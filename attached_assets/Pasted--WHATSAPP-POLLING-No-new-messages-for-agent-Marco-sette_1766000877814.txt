âœ… [WHATSAPP POLLING] No new messages for agent Marco setter
ğŸ“Œ [WATERMARK] Latest on Twilio (2025-12-14T18:11:36.000Z) is older than watermark - keeping current
âš ï¸ [WHATSAPP POLLING] Skipping consultant c2146759-f08a-430a-afdf-701bbc674300 - incomplete config
7:47:32 PM [express] GET /api/followup/activity-log 200 in 592ms :: {"timeline":[],"allEvents":[],"tâ€¦
ğŸ”– [WATERMARK] Agent Receptionist Principale (fe95f393-b8c9-4fc0-80d7-2035dcba305a) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Receptionist Principale
âœ… [WHATSAPP POLLING] Poll cycle complete
ğŸ”„ [FOLLOWUP-API] Manual trigger requested by consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ” [FOLLOWUP-SCHEDULER] Starting ALL follow-up evaluation cycle...
ğŸ§  [FOLLOWUP-SCHEDULER] AI-ONLY mode: Found 3 consultants with active WhatsApp configs
âœ… [FILTER-CHECK] Excluding closed states: 'closed_won', 'closed_lost' from candidate search
ğŸ“Š [CANDIDATE] 1c158920-2cad-4274-98dc-0adbb5ca61e8: leadNeverResponded=true, hoursSinceLastInbound=999.0h, lastInbound=NULL
ğŸ“Š [FOLLOWUP-SCHEDULER] Found 1 ALL candidate conversations
ğŸŒ¡ï¸ [TEMPERATURE] Conversazione 1c158920-2cad-4274-98dc-0adbb5ca61e8: warm â†’ ghost
ğŸ” [FOLLOWUP-SCHEDULER] Evaluating conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
   State: new, Days silent: 0, Hours silent: 0.0, Follow-ups: 0/5
   ğŸ“‹ Applicable rules: 0 (Sistema AI attivo - le regole sono opzionali)
ğŸ¤– [FOLLOWUP-SCHEDULER] Nessuna regola esplicita - Sistema AI "Marco" attivo per 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ§‘â€ğŸ’¼ [FOLLOWUP-ENGINE] Human-Like AI evaluation for conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
   State: new, Days silent: 0, Follow-ups: 0/5
   Mode: AI-ONLY (no hardcoded rules)
ğŸ“œ [FOLLOWUP-ENGINE] Found 0 previous evaluations for context
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
ğŸš€ [FOLLOWUP-ENGINE] Using Vertex AI (SuperAdmin) for evaluation
âœ… [FOLLOWUP-ENGINE] Decision: schedule (confidence: 0.95)
   Reasoning: La conversazione Ã¨ appena iniziata, il nostro primo messaggio (un template) Ã¨ stato inviato pochi minuti fa. Secondo le nostre linee guida, Ã¨ fondamentale dare al lead il tempo di rispondere prima di inviare un altro messaggio. Non ha senso inviare un follow-up subito. ProgrammerÃ² un follow-up per domani mattina, intorno alle 10:00, usando il secondo template disponibile. Questo darÃ  al lead il tempo sufficiente per elaborare il primo messaggio ed eventualmente rispondere. Se non risponde entro domani, allora procederemo con il follow-up programmato, rispettando la regola che saremo fuori dalla finestra delle 24 ore e dovremo usare un template.
   Latency: 14465ms
ğŸ“ [FOLLOWUP-ENGINE] Logging decision for conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
âœ… [FOLLOWUP-ENGINE] Decision logged successfully
ğŸ” [TEMPLATE-TRACE] â•â•â• CHIAMATA 2: AI decision â•â•â•
ğŸ” [TEMPLATE-TRACE] candidate.agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-TRACE] candidate.conversationId: 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ” [TEMPLATE-TRACE] candidate.leadName: undefined
ğŸ” [TEMPLATE-TRACE] decision.decision: schedule
âš ï¸ [FOLLOWUP-SCHEDULER] Lead mai risposto - finestra 24h non ancora aperta, richiesto template approvato
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” [TEMPLATE-DEBUG] Cercando template per agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-DEBUG] Conversation: 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ” [TEMPLATE-DEBUG] Template TROVATI dalla query (tutti): 2
ğŸ” [TEMPLATE-DEBUG]   1. templateId: HX922112cd9b1d531c5be56772acd50034, type: twilio, priority: 2
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG]   2. templateId: HX5e6d27c6d82026f3620247262ef67340, type: twilio, priority: 1
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG] Template DOPO filtro (HX + twilio): 2
ğŸ” [TEMPLATE-DEBUG]   1. HX922112cd9b1d531c5be56772acd50034 (priority: 2)
ğŸ” [TEMPLATE-DEBUG]   2. HX5e6d27c6d82026f3620247262ef67340 (priority: 1)
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… [FOLLOWUP-SCHEDULER] Template Twilio approvato SELEZIONATO: HX922112cd9b1d531c5be56772acd50034 (priority: 2, type: twilio)
ğŸ¯ [FOLLOWUP-SCHEDULER] Outside 24h/Lead never responded - using AI to select best template
ğŸ“‹ [TEMPLATE-AI] Fetching all approved templates for agent: 760bb513-098f-4722-b02a-a700160c2fc3
âŒ [FOLLOWUP-SCHEDULER] AI template selection failed - NOT using priority fallback: TypeError: Cannot convert undefined or null to object
    at Function.entries (<anonymous>)
    at orderSelectedFields (/home/runner/workspace/node_modules/src/utils.ts:77:16)
    at <anonymous> (/home/runner/workspace/node_modules/src/utils.ts:88:19)
    at Array.reduce (<anonymous>)
    at orderSelectedFields (/home/runner/workspace/node_modules/src/utils.ts:77:32)
    at <anonymous> (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:979:23)
    at Object.startActiveSpan (/home/runner/workspace/node_modules/src/tracing.ts:27:11)
    at PgSelectBase._prepare (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:978:17)
    at <anonymous> (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:1009:16)
    at Object.startActiveSpan (/home/runner/workspace/node_modules/src/tracing.ts:27:11)
    at PgSelectBase.execute (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:1008:17)
    at PgSelectBase.then (/home/runner/workspace/node_modules/src/query-promise.ts:31:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
âŒ [FOLLOWUP-SCHEDULER] Error evaluating conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8: TypeError: Cannot convert undefined or null to object
    at Function.entries (<anonymous>)
    at orderSelectedFields (/home/runner/workspace/node_modules/src/utils.ts:77:16)
    at <anonymous> (/home/runner/workspace/node_modules/src/utils.ts:88:19)
    at Array.reduce (<anonymous>)
    at orderSelectedFields (/home/runner/workspace/node_modules/src/utils.ts:77:32)
    at <anonymous> (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:979:23)
    at Object.startActiveSpan (/home/runner/workspace/node_modules/src/tracing.ts:27:11)
    at PgSelectBase._prepare (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:978:17)
    at <anonymous> (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:1009:16)
    at Object.startActiveSpan (/home/runner/workspace/node_modules/src/tracing.ts:27:11)
    at PgSelectBase.execute (/home/runner/workspace/node_modules/src/pg-core/query-builders/select.ts:1008:17)
    at PgSelectBase.then (/home/runner/workspace/node_modules/src/query-promise.ts:31:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[FOLLOWUP-SCHEDULER] Evaluation Cycle cycle_1766000854682_gad1ko: 17.798s
ğŸ“ˆ [FOLLOWUP-SCHEDULER] ALL evaluation cycle completed
   â±ï¸  Duration: 17798ms
   ğŸ“Š Processed: 0/1
   ğŸŒ¡ï¸  Temperature updates: 1
   ğŸ“… Scheduled: 0
   â­ï¸  Skipped: 0
   ğŸ›‘ Stopped: 0
   âŒ Errors: 1
ğŸ“Š [FOLLOWUP-SCHEDULER] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š [FOLLOWUP-SCHEDULER] Cycle Metrics Report
ğŸ“Š [FOLLOWUP-SCHEDULER] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š [FOLLOWUP-SCHEDULER] Timestamp: 2025-12-17T19:47:52.480Z
ğŸ“Š [FOLLOWUP-SCHEDULER] Cycle ID: cycle_1766000854682_gad1ko
ğŸ“Š [FOLLOWUP-SCHEDULER] Type: evaluation_all
ğŸ“Š [FOLLOWUP-SCHEDULER] Duration: 17798ms
ğŸ“Š [FOLLOWUP-SCHEDULER] Processed: 1
ğŸ“Š [FOLLOWUP-SCHEDULER] Success: 0
ğŸ“Š [FOLLOWUP-SCHEDULER] Errors: 1
ğŸ“Š [FOLLOWUP-SCHEDULER] Skipped: 0
ğŸ“Š [FOLLOWUP-SCHEDULER] Rate Limited: 0
ğŸ“Š [FOLLOWUP-SCHEDULER] Error Rate: 100.0%
ğŸ“Š [FOLLOWUP-SCHEDULER] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[FOLLOWUP-SCHEDULER] ALERT: Error rate exceeded 10% (100.0%)
7:47:52 PM [express] POST /api/followup/trigger-eval