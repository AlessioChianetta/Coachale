  GNU nano 7.2                                                                    /opt/alessia-voice/vps-voice-bridge/src/esl-client.ts                                                                              
import modesl from 'modesl';
const { Connection } = modesl;
import { config } from './config.js';
import { logger } from './logger.js';
import { setExpectedCallId } from './voice-bridge-server.js';

const log = logger.child('ESL');

export function startESLController(): void {
  log.info(`Connecting to FreeSWITCH ESL at ${config.esl.host}:${config.esl.port}...`);

  const conn = new Connection(config.esl.host, config.esl.port, config.esl.password, () => {
    log.info('âœ… Connected to FreeSWITCH Event Socket!');
    conn.subscribe(['CHANNEL_ANSWER', 'CHANNEL_HANGUP']);
  });

  conn.on('esl::event::CHANNEL_ANSWER::*', (event: any) => {
    const uuid = event.getHeader('Unique-ID');
    const dest = event.getHeader('Caller-Destination-Number');
    const callerId = event.getHeader('Caller-Caller-ID-Number');

    if (dest !== '9999') return;

    log.info(`ðŸ“ž Detected call to 9999 (Answered)`, { uuid, callerId });

    // 1. URL CORRETTO: IP 172.17.0.1 e parametri con %26 invece di &
   // URL pulitissimo senza caratteri speciali che rompono FreeSWITCH
const wsUrl = `ws://172.17.0.1:${config.ws.port}?call_id=${uuid}`;

    setExpectedCallId(uuid);

    // 2. COMANDO SENZA VIRGOLETTE (Fondamentale!)
    const streamCmd = `uuid_audio_stream ${uuid} start ${wsUrl} mono 16000`;

    // 3. RITARDO DI 500ms (Fondamentale!)
    setTimeout(() => {
        log.debug(`ðŸš€ Executing stream command via bgapi`, { cmd: streamCmd });

        (conn as any).bgapi(streamCmd, (res: any) => {
          const body = res.getBody();
          if (body && body.includes('+OK')) {
            log.info(`âœ… Audio stream initiated successfully`, { uuid });
          } else {
            log.error(`âŒ Failed to start audio stream`, { uuid, error: body || 'Unknown error' });
          }
        });
    }, 500);
  });

  conn.on('esl::event::CHANNEL_HANGUP::*', (event: any) => {
    const dest = event.getHeader('Caller-Destination-Number');
    if (dest === '9999') {
      log.debug(`ðŸ›‘ Call 9999 ended`, { uuid: event.getHeader('Unique-ID') });
    }
  });

  conn.on('error', (err: any) => {
    log.error('âŒ ESL Connection Error', { error: err?.message || err });
    setTimeout(() => startESLController(), 5000);
  });
}




