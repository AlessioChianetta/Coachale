:49:05 PM [express] GET /api/client-data/conversations 200 in 131ms :: {"success":true,"data":[{"id‚Ä¶
2:49:05 PM [express] GET /api/ai-assistant/preferences 304 in 320ms :: {"writingStyle":"eccentric","‚Ä¶
[SMART-QUESTIONS] Generated 10 questions in 3091ms
2:49:08 PM [express] GET /api/client-data/datasets/25/smart-questions 200 in 3209ms :: {"success":tr‚Ä¶
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
[CLIENT-DATA] Conversation created: 13b996b8-50bb-41c2-bde0-6ac6890ea061
2:49:09 PM [express] POST /api/client-data/conversations 201 in 209ms :: {"success":true,"data":{"id‚Ä¶
[PUBLER POLLING] Running scheduled post status sync...
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
2:49:10 PM [express] GET /api/client-data/conversations 200 in 103ms :: {"success":true,"data":[{"id‚Ä¶
[CLIENT-DATA] User message saved: d3c12f71-368a-4666-86be-7d3aabd358d6
[CLIENT-DATA] Loaded 0 messages for context
[CLIENT-DATA] Processing message: "Qual √® il fatturato totale del periodo?" on dataset 25
[QUERY-PLANNER] Processing question: "Qual √® il fatturato totale del periodo?" for 1 datasets
[QUERY-PLANNER] Conversation history: 0 messages, forceAnalytics=false
[WIRING-CHECK] semantic contract detected - requestsAll=false, requestsTopN=false, keywords=[]
[WIRING-CHECK] extractFiltersFromQuestion called - found 0 filters: {}
[WIRING-CHECK] groupByIntent - isProductListing=false, productColumn=product_id
[INTENT-ROUTER] Classifying question: "Qual √® il fatturato totale del periodo?"
[INTENT-ROUTER] Conversation context: 0 messages
üîç Finding AI provider for client 19ed2469-e094-4033-9198-156fc5dbfd3f (consultant: 19ed2469-e094-4033-9198-156fc5dbfd3f)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ [SuperAdmin Gemini] Loaded 1 API keys from config
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[INTENT-ROUTER] Using provider: Google AI Studio
üîí [Semaphore] Acquired slot (1/3 in use)
[PUBLER SYNC] Synced 2 consultants, updated 0 posts
[PUBLER POLLING] Sync complete: 2 consultants, 0 posts updated
üîì [Semaphore] Released slot (0/3 in use)
[INTENT-ROUTER] Raw response (1170ms): ```json
{
  "intent": "analytics",
  "requires_metrics": true,
  "suggested_tools": [
    "execute_metric"
  ],
  "confidence": 0.98
}
```
[INTENT-ROUTER] Classification result: intent=analytics, requires_metrics=true, confidence=0.98, tools=[execute_metric]
[QUERY-PLANNER] Router result: intent=analytics, requires_metrics=true, confidence=0.98
[POLICY-ENGINE] Getting policy for intent: analytics
[QUERY-PLANNER] Policy: allowedTools=[execute_metric,query_metric,aggregate_group,compare_periods,filter_data,get_schema], requireToolCall=true
[SEMANTIC-ORDERBY] Detected "fatturato" ‚Üí metric="revenue", direction=DESC
[QUERY-PLANNER] SEMANTIC ORDERBY DETECTED: metric="revenue", direction=DESC
üîç Finding AI provider for client 19ed2469-e094-4033-9198-156fc5dbfd3f (consultant: 19ed2469-e094-4033-9198-156fc5dbfd3f)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[QUERY-PLANNER] Conversation context for planner: 0 messages
[QUERY-PLANNER] Allowed tools for AI: [execute_metric, query_metric, compare_periods, filter_data, aggregate_group, get_schema]
[QUERY-PLANNER] Using Router Agent classification (legacy classifier disabled)
üîí [Semaphore] Acquired slot (1/3 in use)
üîì [Semaphore] Released slot (0/3 in use)
there are non-text parts functionCall in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.
[QUERY-PLANNER] Plan: 1 steps, complexity: simple
[POLICY-ENGINE] Enforcing policy for intent: analytics, tool calls: 1
[POLICY-ENGINE] ALLOWED: execute_metric
[POLICY-ENGINE] Result: allowed=1, blocked=0, violations=0
[POLICY-ENGINE] Tool analysis: hasComputeTool=true, hasOnlyMetadata=false
[POLICY-ENGINE] VALIDATION OK: compute tool present
[EXECUTE-METRIC] Called with metricName: "revenue", datasetId: 25
[REVENUE-TRACKING] Dataset 25 - Using revenue_amount: "revenue_amount" for revenue
[METRIC-REGISTRY] ===== TEMPLATE SELECTION =====
[METRIC-REGISTRY] metricName: revenue
[METRIC-REGISTRY] template.displayName: Fatturato
[METRIC-REGISTRY] template.description: Fatturato reale (somma degli importi riga gi√† calcolati, post-sconti). Usa revenue_amount, NON price*quantity.
[METRIC-REGISTRY] template.sqlTemplate: SUM(CAST({revenue_amount} AS NUMERIC))
[METRIC-REGISTRY] requiredLogicalColumns: revenue_amount
[SEMANTIC-RESOLVER] ===== RESOLVE TRACE =====
[SEMANTIC-RESOLVER] datasetId: 25
[SEMANTIC-RESOLVER] sqlTemplate (before): SUM(CAST({revenue_amount} AS NUMERIC))
[SEMANTIC-RESOLVER] column mappings: {"price":"price","cost":"cost","quantity":"quantity","order_date":"order_date","document_id":"order_id","product_name":"product_name","product_id":"product_id","category":"category","customer_id":"customer_id","discount_percent":"discount_percent","total_net":"total_net","tax_rate":"tax_rate","payment_method":"payment_method","staff":"staff","line_id":"line_id","is_sellable":"is_sellable","revenue_amount":"revenue_amount","document_type":"document_type","time_slot":"time_slot","sales_channel":"sales_channel"}
[SEMANTIC-RESOLVER] resolved SQL (after): SUM(CAST("revenue_amount" AS NUMERIC))
[SEMANTIC-RESOLVER] valid: true, error: none
[EXECUTE-METRIC] Resolved SQL: SUM(CAST("revenue_amount" AS NUMERIC))
[QUERY-RULES] Rule 2: SKIPPED - document_type filter NOT auto-injected for metric "revenue". Revenue includes all document types (sales, refunds, voids).
[QUERY-RULES] Detected ORDER BY keyword: "fatturato" ‚Üí revenue DESC
[QUERY-RULES] Rule 6: Applying ORDER BY revenue_amount DESC
[QUERY-RULES] Rule 3: No sales_channel filter specified, including all channels
[EXECUTE-METRIC] Query rules applied: RULE_6_ORDER_BY_SEMANTIC, RULE_3_SALES_CHANNEL_ALL
[EXECUTE-METRIC] Enhancements: WHERE=none, ORDER BY="revenue_amount" DESC
[EXECUTE-METRIC-SQL] ===== METRIC EXECUTION TRACE =====
[EXECUTE-METRIC-SQL] datasetId: 25
[EXECUTE-METRIC-SQL] metricName: revenue
[EXECUTE-METRIC-SQL] tableName: cdd_19ed2469_ristorante_simulato_200k_fulls_146dbb8f
[EXECUTE-METRIC-SQL] sqlExpression: SUM(CAST("revenue_amount" AS NUMERIC))
[EXECUTE-METRIC-SQL] columns available: cost, price, staff, line_id, category, order_id, quantity, tax_rate, time_slot, total_net, order_date, product_id, customer_id, is_sellable, product_name, document_type, sales_channel, payment_method, revenue_amount, discount_percent
[EXECUTE-METRIC-SQL] No WHERE clause (full table scan)
[EXECUTE-METRIC-SQL] FINAL SQL: SELECT SUM(CAST(NULLIF(REPLACE(NULLIF("revenue_amount", ''), ',', '.'), '') AS NUMERIC)) AS result FROM "cdd_19ed2469_ristorante_simulato_200k_fulls_146dbb8f"
[EXECUTE-METRIC-SQL] RAW DB RESULT: [{"result":"2681451.7500000000239705"}], success=true, error=none
[CACHE-MANAGER] Transitioned to 'ready' for hash d4c57bd61019... TTL: 3600s
[EXECUTE-METRIC] Result: success=true, error=none
[QUERY-PLANNER] Execution complete in 1429ms, success: true
üîç Finding AI provider for client 19ed2469-e094-4033-9198-156fc5dbfd3f (consultant: 19ed2469-e094-4033-9198-156fc5dbfd3f)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
üîí [Semaphore] Acquired slot (1/3 in use)
üîå [GEMINI TRACKER] ACTIVE GEMINI STREAMS: 0
üîì [Semaphore] Released slot (0/3 in use)
[TOOL-GATING] Tools used: execute_metric, hasComputeTool: true, hasNumericClaims: true, isOnlyMetadata: false, hasOnlyMetadataTools: false
[RESULT-VALIDATOR] Processing tool result: toolName=execute_metric, success=true, result= [{"result":"2681451.7500000000239705"}]
[RESULT-VALIDATOR] Parsed number from string at root[0].result: 2681451.75
[RESULT-VALIDATOR] Total numbers extracted: 1 [ 2681451.75 ]
[RESULT-VALIDATOR] Coverage: 100% (1/1 tool numbers found in response)
[RESULT-VALIDATOR] Generated 3 derived numbers from 1 base numbers
[RESULT-VALIDATOR] COVERAGE BYPASS: 100% coverage, allowing 3 derived/extra numbers
[RESULT-VALIDATOR] Response numbers: 4, Tool numbers: 1, Extra: 3, Final invented: 0
[LABEL-VALIDATOR] Metrics used in tools: revenue
[CLIENT-DATA] Assistant message saved: 2e384b29-7a16-4461-a444-4b537f731b32
2:49:24 PM [express] POST /api/client-data/conversations/13b996b8-50bb-41c2-bde0-6ac6890ea061/messag‚Ä¶
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
2:49:31 PM [express] GET /api/user/profile 200 in 12ms
2:49:31 PM [express] GET /api/client-data/conversations 200 in 103ms :: {"success":true,"data":[{"id‚Ä¶
[CLIENT-DATA] Generating smart questions for dataset 24
[SMART-QUESTIONS] Generating questions for dataset 24
üîå [GEMINI TRACKER] ACTIVE GEMINI STREAMS: 0
[SMART-QUESTIONS] Generated 10 questions in 3056ms
2:49:34 PM [express] GET /api/client-data/datasets/24/smart-questions 200 in 3158ms :: {"success":tr‚Ä¶
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
[CLIENT-DATA] Conversation created: 2e89cb18-875d-4c91-a1a1-c4517283a4d9
2:49:35 PM [express] POST /api/client-data/conversations 201 in 207ms :: {"success":true,"data":{"id‚Ä¶
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
[AUTH] Gold token detected for subscription: 0e04b8b2-99d7-48b0-82c0-4b0704b3ef7c, userId: 3bd72965-8ee1-47aa-8e74-7fdfaecdcc62
2:49:36 PM [express] GET /api/client-data/conversations 200 in 101ms :: {"success":true,"data":[{"id‚Ä¶
[CLIENT-DATA] User message saved: 50724b7e-e31d-4f74-9d29-848307ac2393
[CLIENT-DATA] Loaded 0 messages for context
[CLIENT-DATA] Processing message: "Qual √® il fatturato totale del periodo?" on dataset 24
[QUERY-PLANNER] Processing question: "Qual √® il fatturato totale del periodo?" for 1 datasets
[QUERY-PLANNER] Conversation history: 0 messages, forceAnalytics=false
[WIRING-CHECK] semantic contract detected - requestsAll=false, requestsTopN=false, keywords=[]
[WIRING-CHECK] extractFiltersFromQuestion called - found 0 filters: {}
[WIRING-CHECK] groupByIntent - isProductListing=false, productColumn=product_id
[INTENT-ROUTER] Classifying question: "Qual √® il fatturato totale del periodo?"
[INTENT-ROUTER] Conversation context: 0 messages
üîç Finding AI provider for client 19ed2469-e094-4033-9198-156fc5dbfd3f (consultant: 19ed2469-e094-4033-9198-156fc5dbfd3f)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[INTENT-ROUTER] Using provider: Google AI Studio
üîí [Semaphore] Acquired slot (1/3 in use)
üîì [Semaphore] Released slot (0/3 in use)
[INTENT-ROUTER] Raw response (860ms): ```json
{
  "intent": "analytics",
  "requires_metrics": true,
  "suggested_tools": [
    "execute_metric"
  ],
  "confidence": 0.98
}
```
[INTENT-ROUTER] Classification result: intent=analytics, requires_metrics=true, confidence=0.98, tools=[execute_metric]
[QUERY-PLANNER] Router result: intent=analytics, requires_metrics=true, confidence=0.98
[POLICY-ENGINE] Getting policy for intent: analytics
[QUERY-PLANNER] Policy: allowedTools=[execute_metric,query_metric,aggregate_group,compare_periods,filter_data,get_schema], requireToolCall=true
[SEMANTIC-ORDERBY] Detected "fatturato" ‚Üí metric="revenue", direction=DESC
[QUERY-PLANNER] SEMANTIC ORDERBY DETECTED: metric="revenue", direction=DESC
üîç Finding AI provider for client 19ed2469-e094-4033-9198-156fc5dbfd3f (consultant: 19ed2469-e094-4033-9198-156fc5dbfd3f)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[QUERY-PLANNER] Conversation context for planner: 0 messages
[QUERY-PLANNER] Allowed tools for AI: [execute_metric, query_metric, compare_periods, filter_data, aggregate_group, get_schema]
[QUERY-PLANNER] Using Router Agent classification (legacy classifier disabled)
üîí [Semaphore] Acquired slot (1/3 in use)
üîì [Semaphore] Released slot (0/3 in use)
there are non-text parts functionCall in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.
[QUERY-PLANNER] Plan: 1 steps, complexity: simple
[POLICY-ENGINE] Enforcing policy for intent: analytics, tool calls: 1
[POLICY-ENGINE] ALLOWED: execute_metric
[POLICY-ENGINE] Result: allowed=1, blocked=0, violations=0
[POLICY-ENGINE] Tool analysis: hasComputeTool=true, hasOnlyMetadata=false
[POLICY-ENGINE] VALIDATION OK: compute tool present
[EXECUTE-METRIC] Called with metricName: "revenue", datasetId: 24
[REVENUE-TRACKING] Dataset 24 - Using revenue_amount: "revenue_amount" for revenue
[METRIC-REGISTRY] ===== TEMPLATE SELECTION =====
[METRIC-REGISTRY] metricName: revenue
[METRIC-REGISTRY] template.displayName: Fatturato
[METRIC-REGISTRY] template.description: Fatturato reale (somma degli importi riga gi√† calcolati, post-sconti). Usa revenue_amount, NON price*quantity.
[METRIC-REGISTRY] template.sqlTemplate: SUM(CAST({revenue_amount} AS NUMERIC))
[METRIC-REGISTRY] requiredLogicalColumns: revenue_amount
[SEMANTIC-RESOLVER] ===== RESOLVE TRACE =====
[SEMANTIC-RESOLVER] datasetId: 24
[SEMANTIC-RESOLVER] sqlTemplate (before): SUM(CAST({revenue_amount} AS NUMERIC))
[SEMANTIC-RESOLVER] column mappings: {"price":"price","cost":"cost","quantity":"quantity","order_date":"order_date","document_id":"order_id","product_name":"product_name","product_id":"product_id","category":"category","customer_id":"customer_id","discount_percent":"discount_percent","total_net":"total_net","tax_rate":"tax_rate","payment_method":"payment_method","staff":"staff","line_id":"line_id","is_sellable":"is_sellable","revenue_amount":"revenue_amount","document_type":"document_type","time_slot":"time_slot","sales_channel":"sales_channel"}
[SEMANTIC-RESOLVER] resolved SQL (after): SUM(CAST("revenue_amount" AS NUMERIC))
[SEMANTIC-RESOLVER] valid: true, error: none
[EXECUTE-METRIC] Resolved SQL: SUM(CAST("revenue_amount" AS NUMERIC))
[QUERY-RULES] Rule 2: SKIPPED - document_type filter NOT auto-injected for metric "revenue". Revenue includes all document types (sales, refunds, voids).
[QUERY-RULES] Detected ORDER BY keyword: "fatturato" ‚Üí revenue DESC
[QUERY-RULES] Rule 6: Applying ORDER BY revenue_amount DESC
[QUERY-RULES] Rule 3: No sales_channel filter specified, including all channels
[EXECUTE-METRIC] Query rules applied: RULE_6_ORDER_BY_SEMANTIC, RULE_3_SALES_CHANNEL_ALL
[EXECUTE-METRIC] Enhancements: WHERE=none, ORDER BY="revenue_amount" DESC
[EXECUTE-METRIC-SQL] ===== METRIC EXECUTION TRACE =====
[EXECUTE-METRIC-SQL] datasetId: 24
[EXECUTE-METRIC-SQL] metricName: revenue
[EXECUTE-METRIC-SQL] tableName: cdd_3bd72965_ristorante_simulato_200k_fulls_2fb7a669
[EXECUTE-METRIC-SQL] sqlExpression: SUM(CAST("revenue_amount" AS NUMERIC))
[EXECUTE-METRIC-SQL] columns available: cost, price, staff, line_id, category, order_id, quantity, tax_rate, time_slot, total_net, order_date, product_id, customer_id, is_sellable, product_name, document_type, sales_channel, payment_method, revenue_amount, discount_percent
[EXECUTE-METRIC-SQL] No WHERE clause (full table scan)
[EXECUTE-METRIC-SQL] FINAL SQL: SELECT SUM(CAST(NULLIF(REPLACE(NULLIF("revenue_amount", ''), ',', '.'), '') AS NUMERIC)) AS result FROM "cdd_3bd72965_ristorante_simulato_200k_fulls_2fb7a669"
[QUERY-EXECUTOR] Query execution error: invalid input syntax for type numeric: ""
[EXECUTE-METRIC-SQL] RAW DB RESULT: undefined, success=false, error=invalid input syntax for type numeric: ""
[EXECUTE-METRIC] Result: success=false, error=invalid input syntax for type numeric: ""
[QUERY-PLANNER] Tool execute_metric failed: invalid input syntax for type numeric: ""
[QUERY-PLANNER] Execution complete in 1211ms, success: false
üîç Finding AI provider for client 19ed2469-e094-4033-9198-156fc5dbfd3f (consultant: 19ed2469-e094-4033-9198-156fc5dbfd3f)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[RESULT-EXPLAINER] ALL TOOLS FAILED - generating contextual response. Errors: execute_metric: invalid input syntax for type numeric: ""
üîí [Semaphore] Acquired slot (1/3 in use)
üîå [GEMINI TRACKER] ACTIVE GEMINI STREAMS: 0
üîì [Semaphore] Released slot (0/3 in use)
[CLIENT-DATA] Assistant message saved: a033fcb6-8c39-482c-9de4-19da7c526ec0
2:49:50 PM [express] POST /api/client-data/conversations/2e89cb18-875d-4c91-a1a1-c4517283a4d9/messag‚Ä¶