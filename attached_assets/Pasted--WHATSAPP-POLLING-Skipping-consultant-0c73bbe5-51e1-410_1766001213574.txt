[WHATSAPP POLLING] Skipping consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b - incomplete config
ğŸ“Š [CALENDAR SYNC] Syncing 1 consultant(s)...

ğŸ”„ [CALENDAR SYNC] Starting sync for consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ“‹ Found 1 total configs across all consultants
âœ… Found 0 configs with polling enabled and active
âœ… Lead polling scheduler initialized successfully
7:50:19 PM [express] âœ… Lead polling scheduler initialized
7:50:19 PM [express] ğŸ“Š Training summary aggregator enabled - starting scheduler...
âœ… [TRAINING AGGREGATOR] Registering cron job (ID: 6fwcod)
ğŸ“… [TRAINING AGGREGATOR] Schedule: Daily at 3:00 AM
â° [TRAINING AGGREGATOR] Timezone: UTC
âœ… [TRAINING AGGREGATOR] Cron job started successfully
7:50:19 PM [express] âœ… Training summary aggregator started
7:50:19 PM [express] âš¡ Follow-up scheduler enabled - starting scheduler...
ğŸš€ [FOLLOWUP-SCHEDULER] Initializing follow-up scheduler...
âœ… [FOLLOWUP-SCHEDULER] Scheduler initialized successfully
   ğŸ”¥ HOT/WARM: */5 * * * * (every 5 minutes)
   â„ï¸  COLD: 0 */2 * * * (every 2 hours)
   ğŸ‘» GHOST: 0 10 * * * (daily at 10:00)
   ğŸ“‹ Processing: * * * * * (every minute)
7:50:19 PM [express] âœ… Follow-up scheduler started
âœ… [GOOGLE CALENDAR] Found global OAuth credentials. Client ID: 830305191681-70020p0...
ğŸ”— [GOOGLE CALENDAR] Using GLOBAL OAuth credentials. Redirect URI: https://69b7a3eb-fe09-4b24-bb43-3c566925a6cb-00-2kr08edz273ih.spock.replit.dev/api/calendar-settings/oauth/callback
ğŸ”– [WATERMARK] Agent Marco setter (760bb513-098f-4722-b02a-a700160c2fc3) - last processed: 2025-12-14T18:11:36.000Z
âœ… Using saved calendar ID from settings: primary
âœ… [WHATSAPP POLLING] No new messages for agent Marco setter
ğŸ“Œ [WATERMARK] Latest on Twilio (2025-12-14T18:11:36.000Z) is older than watermark - keeping current
âœ… [CALENDAR SYNC] No confirmed appointments to sync for consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b in the next 90 days
âš ï¸ [WHATSAPP POLLING] Skipping consultant c2146759-f08a-430a-afdf-701bbc674300 - incomplete config

âœ… [CALENDAR SYNC] Sync cycle complete
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

7:50:22 PM [express] GET /api/whatsapp/stats 200 in 19ms
ğŸ”– [WATERMARK] Agent Receptionist Principale (fe95f393-b8c9-4fc0-80d7-2035dcba305a) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Receptionist Principale
7:50:22 PM [express] GET /api/proactive-leads 304 in 437ms :: {"success":true,"leads":[{"id":"e7434eâ€¦
Getting active sessions for consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b
âœ… [WHATSAPP POLLING] Poll cycle complete
Found active sessions: 1
7:50:23 PM [express] GET /api/auth/my-profiles 304 in 1306ms :: {"profiles":[{"id":"fd732f27-d63b-4eâ€¦
7:50:23 PM [express] GET /api/clients 304 in 1315ms :: [{"id":"8a7f6b63-b41e-4071-bf44-28d71df1f4d8"â€¦
Returning sessions with users: 1
7:50:23 PM [express] GET /api/activity/sessions/active 200 in 722ms :: [{"id":"543732da-a30d-4a5b-a8â€¦
7:50:24 PM [express] GET /api/stats/consultant 304 in 1775ms :: {"activeClients":23,"completedExerciâ€¦
Getting activity logs for consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b
7:50:24 PM [express] GET /api/whatsapp/conversations 200 in 714ms :: {"conversations":[{"id":"1c1589â€¦
7:50:24 PM [express] GET /api/exercise-assignments/consultant 304 in 1757ms :: [{"id":"63c7f092-f938â€¦
7:50:24 PM [express] GET /api/email-journey-progress 304 in 2422ms :: [{"id":"b1b288cc-50de-4068-a0aâ€¦
7:50:24 PM [express] GET /api/sessions/active 200 in 12ms
Found activity logs: 500
7:50:25 PM [express] GET /api/exercises 304 in 1320ms :: [{"id":"5718c758-63f5-4b73-aeae-7f386899df4â€¦
Returning logs with users: 500
7:50:28 PM [express] GET /api/activity/clients 304 in 4849ms :: [{"id":"f7a01460-966a-478d-a1e6-5d99â€¦
7:50:29 PM [express] GET /api/consultant/onboarding/interactive-intro/status 304 in 3999ms :: {"succâ€¦
ğŸ”„ [WHATSAPP POLLING] Starting poll cycle...
ğŸ“Š [WHATSAPP POLLING] Polling 5 consultant(s) sequentially...
âš ï¸ [WHATSAPP POLLING] Skipping consultant 611b2437-3b3f-4063-ad89-2164943abf1d - incomplete config
7:50:30 PM [express] GET /api/university/stats/overview 304 in 6720ms :: [{"clientId":"8a7f6b63-b41eâ€¦
âš ï¸ [WHATSAPP POLLING] Skipping consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b - incomplete config
ğŸ”– [WATERMARK] Agent Marco setter (760bb513-098f-4722-b02a-a700160c2fc3) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Marco setter
ğŸ“Œ [WATERMARK] Latest on Twilio (2025-12-14T18:11:36.000Z) is older than watermark - keeping current
âš ï¸ [WHATSAPP POLLING] Skipping consultant c2146759-f08a-430a-afdf-701bbc674300 - incomplete config
ğŸ”– [WATERMARK] Agent Receptionist Principale (fe95f393-b8c9-4fc0-80d7-2035dcba305a) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Receptionist Principale
âœ… [WHATSAPP POLLING] Poll cycle complete
7:50:35 PM [express] GET /api/sessions/active 200 in 6ms
7:50:36 PM [express] GET /api/automation-rules 200 in 7ms
7:50:36 PM [express] GET /api/auth/my-profiles 304 in 432ms :: {"profiles":[{"id":"fd732f27-d63b-4e8â€¦
7:50:36 PM [express] GET /api/campaigns 304 in 428ms :: {"success":true,"data":[{"id":"dd10cce2-065fâ€¦
ğŸ“‹ Loaded 5 cached approval statuses for agent Receptionist Principale
âœ… [APPROVAL FETCH] Template notification_order_tracking (HX16a6ec5dbd358dd745f096c22fb13e3d): unsubmitted
âœ… [APPROVAL FETCH] Template lead_followup_che_non_ha_risposto (HX5e6d27c6d82026f3620247262ef67340): approved
âœ… [APPROVAL FETCH] Template lead_appena_iscritto_messaggi_aperturaa (HX922112cd9b1d531c5be56772acd50034): approved
âœ… [APPROVAL FETCH] Template message_opt_in (HX5b5fa6e11bfe36fa44f872043448e783): unsubmitted
âœ… [APPROVAL FETCH] Template verifications_2fa_template (HXfe0b137388084a3f0a801921c06d08d9): unsubmitted
ğŸ“‹ Loaded 5 cached approval statuses for agent Marco setter
âœ… Updated approval status cache for Receptionist Principale
7:50:38 PM [express] GET /api/whatsapp/custom-templates 304 in 2025ms :: {"success":true,"data":[{"iâ€¦
âœ… [APPROVAL FETCH] Template message_opt_in (HX5b5fa6e11bfe36fa44f872043448e783): unsubmitted
âœ… [APPROVAL FETCH] Template notification_order_tracking (HX16a6ec5dbd358dd745f096c22fb13e3d): unsubmitted
âœ… [APPROVAL FETCH] Template verifications_2fa_template (HXfe0b137388084a3f0a801921c06d08d9): unsubmitted
âœ… [APPROVAL FETCH] Template lead_appena_iscritto_messaggi_aperturaa (HX922112cd9b1d531c5be56772acd50034): approved
âœ… [APPROVAL FETCH] Template lead_followup_che_non_ha_risposto (HX5e6d27c6d82026f3620247262ef67340): approved
7:50:38 PM [express] GET /api/whatsapp/templates 304 in 2165ms :: {"templates":[{"sid":"HX5b5fa6e11bâ€¦
âœ… Updated approval status cache for Marco setter
7:50:39 PM [express] GET /api/auth/my-profiles 304 in 440ms :: {"profiles":[{"id":"fd732f27-d63b-4e8â€¦
7:50:39 PM [express] GET /api/followup/settings 304 in 435ms :: {"hoursWithoutReply":4,"rulesCount":â€¦
7:50:39 PM [express] GET /api/followup/agents 304 in 433ms :: [{"id":"3e3aedc9-1a8f-42b1-b5ac-6a67a4â€¦
7:50:39 PM [express] GET /api/followup/activity-log 304 in 728ms :: {"timeline":[{"conversationId":"â€¦
7:50:39 PM [express] GET /api/followup/dashboard-stats 304 in 1150ms :: {"awaitingFollowup":1,"sentTâ€¦
7:50:49 PM [express] POST /api/activity/session/heartbeat 200 in 436ms :: {"success":true,"lastActivâ€¦
ğŸ”„ [FOLLOWUP-API] Manual trigger requested by consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ” [FOLLOWUP-SCHEDULER] Starting ALL follow-up evaluation cycle...
ğŸ§  [FOLLOWUP-SCHEDULER] AI-ONLY mode: Found 3 consultants with active WhatsApp configs
âœ… [FILTER-CHECK] Excluding closed states: 'closed_won', 'closed_lost' from candidate search
ğŸ“Š [CANDIDATE] 1c158920-2cad-4274-98dc-0adbb5ca61e8: leadNeverResponded=true, hoursSinceLastInbound=999.0h, lastInbound=NULL
ğŸ“Š [FOLLOWUP-SCHEDULER] Found 1 ALL candidate conversations
ğŸ” [FOLLOWUP-SCHEDULER] Evaluating conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
   State: new, Days silent: 0, Hours silent: 0.1, Follow-ups: 0/5
   ğŸ“‹ Applicable rules: 0 (Sistema AI attivo - le regole sono opzionali)
ğŸ¤– [FOLLOWUP-SCHEDULER] Nessuna regola esplicita - Sistema AI "Marco" attivo per 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ§‘â€ğŸ’¼ [FOLLOWUP-ENGINE] Human-Like AI evaluation for conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
   State: new, Days silent: 0, Follow-ups: 0/5
   Mode: AI-ONLY (no hardcoded rules)
ğŸ“œ [FOLLOWUP-ENGINE] Found 1 previous evaluations for context
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
ğŸš€ [FOLLOWUP-ENGINE] Using Vertex AI (SuperAdmin) for evaluation
â° [FOLLOWUP-SCHEDULER] Processing cycle triggered
ğŸ“¤ [FOLLOWUP-SCHEDULER] Processing scheduled messages...
ğŸ”„ [WHATSAPP POLLING] Starting poll cycle...
ğŸ“¬ [FOLLOWUP-SCHEDULER] Found 0 pending messages to send
ğŸ’¤ [FOLLOWUP-SCHEDULER] No pending messages
ğŸ“Š [WHATSAPP POLLING] Polling 5 consultant(s) sequentially...
âš ï¸ [WHATSAPP POLLING] Skipping consultant 611b2437-3b3f-4063-ad89-2164943abf1d - incomplete config
âš ï¸ [WHATSAPP POLLING] Skipping consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b - incomplete config
âš ï¸ [WHATSAPP POLLING] Skipping consultant c2146759-f08a-430a-afdf-701bbc674300 - incomplete config
ğŸ”– [WATERMARK] Agent Marco setter (760bb513-098f-4722-b02a-a700160c2fc3) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Marco setter
ğŸ“Œ [WATERMARK] Latest on Twilio (2025-12-14T18:11:36.000Z) is older than watermark - keeping current
ğŸ”– [WATERMARK] Agent Receptionist Principale (fe95f393-b8c9-4fc0-80d7-2035dcba305a) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Receptionist Principale
âœ… [WHATSAPP POLLING] Poll cycle complete
âœ… [FOLLOWUP-ENGINE] Decision: schedule (confidence: 0.98)
   Reasoning: In qualitÃ  di Marco, con 15 anni di esperienza, non invierei un altro messaggio dopo soli 3 minuti dal primo. Il lead non ha ancora avuto tempo di leggere e rispondere. Ãˆ fondamentale dare spazio al potenziale cliente. La decisione piÃ¹ sensata Ã¨ programmare un follow-up per domani mattina, diciamo alle 10:00. Se entro allora non avrÃ  risposto, potremo inviare un secondo template per riattivare l'interesse. Il primo messaggio Ã¨ stato inviato pochi minuti fa, quindi non ci sono segnali negativi, solo normale attesa. UserÃ² l'altro template disponibile per variare l'approccio nel follow-up.
   Latency: 13423ms
ğŸ“ [FOLLOWUP-ENGINE] Logging decision for conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
âœ… [FOLLOWUP-ENGINE] Decision logged successfully
ğŸ” [TEMPLATE-TRACE] â•â•â• CHIAMATA 2: AI decision â•â•â•
ğŸ” [TEMPLATE-TRACE] candidate.agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-TRACE] candidate.conversationId: 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ” [TEMPLATE-TRACE] candidate.leadName: undefined
ğŸ” [TEMPLATE-TRACE] decision.decision: schedule
âš ï¸ [FOLLOWUP-SCHEDULER] Lead mai risposto - finestra 24h non ancora aperta, richiesto template approvato
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” [TEMPLATE-DEBUG] Cercando template per agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-DEBUG] Conversation: 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ” [TEMPLATE-DEBUG] Template TROVATI dalla query (tutti): 2
ğŸ” [TEMPLATE-DEBUG]   1. templateId: HX922112cd9b1d531c5be56772acd50034, type: twilio, priority: 2
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG]   2. templateId: HX5e6d27c6d82026f3620247262ef67340, type: twilio, priority: 1
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG] Template DOPO filtro (HX + twilio): 2
ğŸ” [TEMPLATE-DEBUG]   1. HX922112cd9b1d531c5be56772acd50034 (priority: 2)
ğŸ” [TEMPLATE-DEBUG]   2. HX5e6d27c6d82026f3620247262ef67340 (priority: 1)
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… [FOLLOWUP-SCHEDULER] Template Twilio approvato SELEZIONATO: HX922112cd9b1d531c5be56772acd50034 (priority: 2, type: twilio)
ğŸ¯ [FOLLOWUP-SCHEDULER] Outside 24h/Lead never responded - using AI to select best template
ğŸ“‹ [TEMPLATE-AI] Fetching all approved templates for agent: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ“‹ [TEMPLATE-AI] Found 2 templates for AI selection
ğŸ¯ [TEMPLATE-AI] Selecting best template for conversation with 2 options
ğŸ”„ [TEMPLATE-AI] Attempt 1/3
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
7:51:11 PM [express] GET /api/followup/activity-log 200 in 1588ms :: {"timeline":[{"conversationId":â€¦
âŒ [TEMPLATE-AI] Attempt 1 failed: GaxiosError: Could not refresh access token: request to http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform failed, reason: connect ECONNREFUSED 169.254.169.254:80
    at Gaxios._request (/home/runner/workspace/node_modules/gaxios/src/gaxios.ts:225:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async metadataAccessor (/home/runner/workspace/node_modules/gcp-metadata/src/index.ts:174:15)
    at async Compute.refreshTokenNoCache (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/computeclient.js:57:20)
    at async Compute.getRequestMetadataAsync (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/oauth2client.js:372:17)
    at async Compute.getRequestHeaders (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/oauth2client.js:336:26)
    at async NodeAuth.addGoogleAuthHeaders (/home/runner/workspace/node_modules/@google/genai/src/node/_node_auth.ts:75:25)
    at async ApiClient.getHeadersInternal (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:634:5)
    at async ApiClient.includeExtraHttpOptionsToRequestInit (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:476:27)
    at async ApiClient.request (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:377:19)
    at async Models.Models.generateContent (/home/runner/workspace/node_modules/@google/genai/src/models.ts:76:14)
    at async selectBestTemplateWithAI (/home/runner/workspace/server/ai/followup-decision-engine.ts:634:26)
    at async evaluateConversation (/home/runner/workspace/server/cron/followup-scheduler.ts:1419:29)
    at async runFollowupEvaluation (/home/runner/workspace/server/cron/followup-scheduler.ts:390:24)
    at async <anonymous> (/home/runner/workspace/server/routes/followup-api.ts:1686:5) {
  config: {
    url: URL {
      href: 'http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform',
      origin: 'http://169.254.169.254',
      protocol: 'http:',
      username: '',
      password: '',
      host: '169.254.169.254',
      hostname: '169.254.169.254',
      port: '',
      pathname: '/computeMetadata/v1/instance/service-accounts/default/token',
      search: '?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform',
      searchParams: URLSearchParams { 'scopes' => 'https://www.googleapis.com/auth/cloud-platform' },
      hash: ''
    },
    headers: Headers { 'metadata-flavor': 'Google' },
    retryConfig: {
      noResponseRetries: 3,
      currentRetryAttempt: 3,
      retry: 3,
      httpMethodsToRetry: [Array],
      retryDelayMultiplier: 2,
      timeOfFirstRequest: 1766001069565,
      totalTimeout: 9007199254740991,
      maxRetryDelay: 9007199254740991,
      statusCodesToRetry: [Array]
    },
    params: { scopes: 'https://www.googleapis.com/auth/cloud-platform' },
    responseType: 'text',
    timeout: 0,
    validateStatus: [Function: validateStatus],
    errorRedactor: [Function: defaultErrorRedactor]
  },
  response: undefined,
  code: 'ECONNREFUSED',
  status: undefined,
  error: FetchError: request to http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform failed, reason: connect ECONNREFUSED 169.254.169.254:80
      at ClientRequest.<anonymous> (file:///home/runner/workspace/node_modules/node-fetch/src/index.js:108:11)
      at ClientRequest.emit (node:events:524:28)
      at emitErrorEvent (node:_http_client:101:11)
      at Socket.socketErrorListener (node:_http_client:504:5)
      at Socket.emit (node:events:524:28)
      at emitErrorNT (node:internal/streams/destroy:169:8)
      at emitErrorCloseNT (node:internal/streams/destroy:128:3)
      at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
    type: 'system',
    errno: 'ECONNREFUSED',
    code: 'ECONNREFUSED',
    erroredSysCall: 'connect'
  },
  [Symbol(gaxios-gaxios-error)]: '7.1.2',
  [cause]: FetchError: request to http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform failed, reason: connect ECONNREFUSED 169.254.169.254:80
      at ClientRequest.<anonymous> (file:///home/runner/workspace/node_modules/node-fetch/src/index.js:108:11)
      at ClientRequest.emit (node:events:524:28)
      at emitErrorEvent (node:_http_client:101:11)
      at Socket.socketErrorListener (node:_http_client:504:5)
      at Socket.emit (node:events:524:28)
      at emitErrorNT (node:internal/streams/destroy:169:8)
      at emitErrorCloseNT (node:internal/streams/destroy:128:3)
      at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
    type: 'system',
    errno: 'ECONNREFUSED',
    code: 'ECONNREFUSED',
    erroredSysCall: 'connect'
  }
}
â³ [TEMPLATE-AI] Waiting 1000ms before retry...
7:51:12 PM [express] GET /api/followup/dashboard-stats 304 in 2029ms :: {"awaitingFollowup":1,"sentTâ€¦
ğŸ”„ [TEMPLATE-AI] Attempt 2/3
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
âŒ [TEMPLATE-AI] Attempt 2 failed: GaxiosError: Could not refresh access token: request to http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform failed, reason: connect ECONNREFUSED 169.254.169.254:80
    at Gaxios._request (/home/runner/workspace/node_modules/gaxios/src/gaxios.ts:225:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async metadataAccessor (/home/runner/workspace/node_modules/gcp-metadata/src/index.ts:174:15)
    at async Compute.refreshTokenNoCache (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/computeclient.js:57:20)
    at async Compute.getRequestMetadataAsync (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/oauth2client.js:372:17)
    at async Compute.getRequestHeaders (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/oauth2client.js:336:26)
    at async NodeAuth.addGoogleAuthHeaders (/home/runner/workspace/node_modules/@google/genai/src/node/_node_auth.ts:75:25)
    at async ApiClient.getHeadersInternal (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:634:5)
    at async ApiClient.includeExtraHttpOptionsToRequestInit (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:476:27)
    at async ApiClient.request (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:377:19)
    at async Models.Models.generateContent (/home/runner/workspace/node_modules/@google/genai/src/models.ts:76:14)
    at async selectBestTemplateWithAI (/home/runner/workspace/server/ai/followup-decision-engine.ts:634:26)
    at async evaluateConversation (/home/runner/workspace/server/cron/followup-scheduler.ts:1419:29)
    at async runFollowupEvaluation (/home/runner/workspace/server/cron/followup-scheduler.ts:390:24)
    at async <anonymous> (/home/runner/workspace/server/routes/followup-api.ts:1686:5) {
  config: {
    url: URL {
      href: 'http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform',
      origin: 'http://169.254.169.254',
      protocol: 'http:',
      username: '',
      password: '',
      host: '169.254.169.254',
      hostname: '169.254.169.254',
      port: '',
      pathname: '/computeMetadata/v1/instance/service-accounts/default/token',
      search: '?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform',
      searchParams: URLSearchParams { 'scopes' => 'https://www.googleapis.com/auth/cloud-platform' },
      hash: ''
    },
    headers: Headers { 'metadata-flavor': 'Google' },
    retryConfig: {
      noResponseRetries: 3,
      currentRetryAttempt: 3,
      retry: 3,
      httpMethodsToRetry: [Array],
      retryDelayMultiplier: 2,
      timeOfFirstRequest: 1766001075467,
      totalTimeout: 9007199254740991,
      maxRetryDelay: 9007199254740991,
      statusCodesToRetry: [Array]
    },
    params: { scopes: 'https://www.googleapis.com/auth/cloud-platform' },
    responseType: 'text',
    timeout: 0,
    validateStatus: [Function: validateStatus],
    errorRedactor: [Function: defaultErrorRedactor]
  },
  response: undefined,
  code: 'ECONNREFUSED',
  status: undefined,
  error: FetchError: request to http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform failed, reason: connect ECONNREFUSED 169.254.169.254:80
      at ClientRequest.<anonymous> (file:///home/runner/workspace/node_modules/node-fetch/src/index.js:108:11)
      at ClientRequest.emit (node:events:524:28)
      at emitErrorEvent (node:_http_client:101:11)
      at Socket.socketErrorListener (node:_http_client:504:5)
      at Socket.emit (node:events:524:28)
      at emitErrorNT (node:internal/streams/destroy:169:8)
      at emitErrorCloseNT (node:internal/streams/destroy:128:3)
      at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
    type: 'system',
    errno: 'ECONNREFUSED',
    code: 'ECONNREFUSED',
    erroredSysCall: 'connect'
  },
  [Symbol(gaxios-gaxios-error)]: '7.1.2',
  [cause]: FetchError: request to http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform failed, reason: connect ECONNREFUSED 169.254.169.254:80
      at ClientRequest.<anonymous> (file:///home/runner/workspace/node_modules/node-fetch/src/index.js:108:11)
      at ClientRequest.emit (node:events:524:28)
      at emitErrorEvent (node:_http_client:101:11)
      at Socket.socketErrorListener (node:_http_client:504:5)
      at Socket.emit (node:events:524:28)
      at emitErrorNT (node:internal/streams/destroy:169:8)
      at emitErrorCloseNT (node:internal/streams/destroy:128:3)
      at process.processTicksAndRejections (node:internal/process/task_queues:82:21) {
    type: 'system',
    errno: 'ECONNREFUSED',
    code: 'ECONNREFUSED',
    erroredSysCall: 'connect'
  }
}
â³ [TEMPLATE-AI] Waiting 2000ms before retry...
ğŸ”„ [TEMPLATE-AI] Attempt 3/3
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client