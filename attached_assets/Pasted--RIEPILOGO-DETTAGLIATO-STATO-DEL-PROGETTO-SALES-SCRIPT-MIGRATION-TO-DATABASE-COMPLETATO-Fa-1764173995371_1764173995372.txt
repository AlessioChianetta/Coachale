üéØ RIEPILOGO DETTAGLIATO - STATO DEL PROGETTO "SALES SCRIPT MIGRATION TO DATABASE"
‚úÖ COMPLETATO (Fasi 1-7/15 - 46.7%)
üìä FASE 1: DATABASE SCHEMA UPDATES
Status: ‚úÖ COMPLETATO con SQL

‚úÖ Aggiunto campo used_script_id VARCHAR a tabella sales_conversation_training

Tipo: VARCHAR (stringa, non Foreign Key per evitare cicli di riferimento)
Scopo: Memorizzare ID dello script usato durante conversazione
Nullable: S√å (per conversazioni senza script DB)
‚úÖ Aggiunto campo used_script_name TEXT a tabella sales_conversation_training

Scopo: Memorizzare nome leggibile dello script per UI
Esempio: "Discovery Call v2.0", "Demo Script - Advanced"
‚úÖ Aggiunto campo used_script_type TEXT a tabella sales_conversation_training

Type: 'discovery' | 'demo' | 'objections'
Scopo: Tracciare quale tipo di script era usato
‚úÖ Aggiunto campo energy_settings JSONB a tabella sales_scripts

Struttura: { [phaseOrStepId]: { level, tone, volume, pace, vocabulary, reason } }
Esempi di valori:
level: "BASSO", "MEDIO", "ALTO"
tone: "CALMO", "SICURO", "CONFIDENZIALE", "ENTUSIASTA"
volume: "SOFT", "NORMAL", "LOUD"
pace: "LENTO", "MODERATO", "VELOCE"
vocabulary: "FORMALE", "COLLOQUIALE", "TECNICO"
Default: '{}'::jsonb (empty object)
‚úÖ Aggiunto campo ladder_overrides JSONB a tabella sales_scripts

Struttura: { [stepId]: { hasLadder: boolean, levels: Array<{level, name, text, purpose}> } }
Memor izza override personalizzati dei 5 livelli di "perch√©" per ogni step
Default: '{}'::jsonb
‚úÖ Aggiunto campo step_questions JSONB a tabella sales_scripts

Struttura: { [stepId]: Array<{id, text, order, type}> }
Memorizza domande chiave personalizzate per ogni step
Default: '{}'::jsonb
‚úÖ Aggiunto campo step_biscottini JSONB a tabella sales_scripts

Struttura: { [stepId]: Array<{text, type}> }
Memorizza "piccole vittorie" (rapport builders, value statements, agreements)
Tipi: "rapport", "value", "agreement", "other"
Default: '{}'::jsonb
Migrazione eseguita con: execute_sql_tool (non drizzle-kit per evitare conflitti)

üîç FASE 2: SALES SCRIPT STRUCTURE PARSER UPGRADE
File: server/ai/sales-script-structure-parser.ts
Status: ‚úÖ COMPLETATO con 600+ righe di nuovo codice

Interfacce Nuove Aggiunte:
interface Question {
  id: string;                    // ID univoco della domanda
  text: string;                  // Testo della domanda
  marker?: string;               // es. "pause_required"
  type?: 'opening' | 'discovery' | 'ladder' | 'closing' | 'objection' | 'general';
  order: number;                 // Ordine nella sequenza
}
interface EnergySettings {
  level: 'BASSO' | 'MEDIO' | 'ALTO';
  tone: 'CALMO' | 'SICURO' | 'CONFIDENZIALE' | 'ENTUSIASTA';
  volume: 'SOFT' | 'NORMAL' | 'LOUD';
  pace: 'LENTO' | 'MODERATO' | 'VELOCE';
  vocabulary: 'FORMALE' | 'COLLOQUIALE' | 'TECNICO';
  reason?: string;               // Motivo della scelta di energy
}
interface LadderLevel {
  level: number;                 // 1-5
  name: string;                  // es. "CHIARIFICAZIONE"
  text: string;                  // Domanda per questo livello
  purpose: string;               // Scopo del livello nel ladder
}
interface Biscottino {
  text: string;                  // Il biscottino (rapport, value, agreement)
  type: 'rapport' | 'value' | 'agreement' | 'other';
}
interface Step {
  // ... campi precedenti ...
  ladderLevels: LadderLevel[];    // Array completo di 5 livelli
  energy?: EnergySettings;         // Energy per questo step
  biscottini: Biscottino[];        // Array di piccole vittorie
}
interface ScriptStructure {
  // ... campi precedenti ...
  metadata: {
    totalPhases: number;
    totalSteps: number;
    totalCheckpoints: number;
    totalQuestions: number;        // NUOVO
    totalLadderSteps: number;      // NUOVO
    totalBiscottini: number;       // NUOVO
    hasEnergySettings: boolean;    // NUOVO
    scriptTypes: string[];
  };
}

Nuove Funzioni di Parsing:
extractEnergyFromContext() - Estrae Energy Settings da contesto

Cerca pattern: "ENERGY: ALTO", "TONO: ENTUSIASTA", ecc.
Ritorna EnergySettings | undefined
Default intelligenti se non trovato
determineQuestionType() - Classifica tipo di domanda

Ritorna: 'opening' | 'discovery' | 'ladder' | 'closing' | 'objection' | 'general'
Usa contesto di fase e se dentro ladder
determineBiscottinoType() - Classifica tipo di biscottino

Cerca keywords: "compliment", "bravo", "valore", "benefic", "esatto", "accord"
Mappa a: 'rapport' | 'value' | 'agreement' | 'other'
getLadderPurpose() - Ritorna scopo per ogni livello ladder

Livello 1: "Chiarificare il problema iniziale"
Livello 2: "Esplorare le conseguenze pratiche"
Livello 3: "Scoprire l'impatto emotivo"
Livello 4: "Trovare la motivazione profonda"
Livello 5: "Visualizzare il futuro ideale"
Parsing Potenziato:
‚úÖ Estrae 5 livelli completi di ladder (non solo numero max)
‚úÖ Assegna ID univoco a ogni domanda (q_1, q_2, etc.)
‚úÖ Estrae domande dentro ogni livello ladder
‚úÖ Mappa domande a question.type (opening, discovery, ladder, etc.)
‚úÖ Estrae biscottini (pattern: üç™ BISCOTTINO: "...testo...")
‚úÖ Estrae Energy Settings per fase/step
‚úÖ Popola metadata con conteggi: totalQuestions, totalLadderSteps, totalBiscottini
‚úÖ Versione script incrementata da 1.0.0 ‚Üí 2.0.0
üéØ FASE 3: SALES SCRIPT TRACKER DATABASE INTEGRATION
File: server/ai/sales-script-tracker.ts
Status: ‚úÖ COMPLETATO con refactoring estensivo

Architettura Rinnovata:
Prima (Sincrono, solo file JSON):

new SalesScriptTracker(conversationId, agentId, initialPhase)

Dopo (Factory method asincrono con DB fallback):

// Metodo 1: Factory asincrono (NUOVO)
const tracker = await SalesScriptTracker.create(
  conversationId,
  agentId,
  initialPhase = 'phase_1_2',
  logger = undefined,
  clientId = undefined,  // NUOVO: per caricare da DB
  scriptType = 'discovery'  // NUOVO: type dello script
);
// Metodo 2: Costruttore legacy (per backward compatibility)
const tracker = new SalesScriptTracker(conversationId, agentId, initialPhase, logger);

Flusso di Caricamento Script:
Se clientId fornito:

Query database: SELECT * FROM sales_scripts WHERE clientId=? AND scriptType=? AND isActive=true
Se trovato: Parse con parseScriptContentToStructure(content, scriptType)
Memorizza info in usedScriptInfo: UsedScriptInfo
Log: üìñ [TRACKER] Loading script from database: ${name}
Se non trovato nel DB o clientId non fornito:

Fallback al file JSON: sales-script-structure.json
Log: üìÅ [TRACKER] Loaded fallback script from JSON file
Version Check:

Confronta hash SHA-256 del file con JSON
Alert se outdated: ‚ö†Ô∏è [TRACKER] SCRIPT OUTDATED
Nuovi Campi Tracciati:
interface UsedScriptInfo {
  id: string;                                      // UUID dello script
  name: string;                                    // es. "Discovery Call v2.0"
  scriptType: 'discovery' | 'demo' | 'objections'; // Tipo di script
  version: string;                                  // es. "1.0.0"
}

Modifica saveToDatabase():
‚úÖ Salva usedScriptId (dalla UsedScriptInfo.id)
‚úÖ Salva usedScriptName (dalla UsedScriptInfo.name)
‚úÖ Salva usedScriptType (dalla UsedScriptInfo.scriptType)
‚úÖ Mantiene tutto il resto invariato
Getter Aggiunto:
getUsedScriptInfo(): UsedScriptInfo | undefined

Aggiornamento getOrCreateTracker():
export async function getOrCreateTracker(
  conversationId: string,
  agentId: string,
  initialPhase?: string,
  clientId?: string,              // NUOVO
  scriptType = 'discovery'        // NUOVO
): Promise<SalesScriptTracker>

üîå FASE 4: API ENDPOINTS - ENERGY, LADDER, QUESTIONS
File: server/routes/sales-scripts.ts
Status: ‚úÖ COMPLETATO - 5 nuovi endpoint

Endpoint 1: PUT /api/sales-scripts/:id/energy
Request Body: {
  phaseOrStepId: "phase_1_2" | "step_5" | "phase_3_step_2",
  settings: {
    level?: "BASSO" | "MEDIO" | "ALTO",
    tone?: "CALMO" | "SICURO" | "CONFIDENZIALE" | "ENTUSIASTA",
    volume?: "SOFT" | "NORMAL" | "LOUD",
    pace?: "LENTO" | "MODERATO" | "VELOCE",
    vocabulary?: "FORMALE" | "COLLOQUIALE" | "TECNICO",
    reason?: "Optional reason for this energy choice"
  }
}
Response: {
  success: true,
  energySettings: { [phaseOrStepId]: {...} }
}
Logica: Merge nuovo setting con existing energySettings, salva a DB

Endpoint 2: PUT /api/sales-scripts/:id/ladder
Request Body: {
  stepId: "phase_1_2_step_3",
  hasLadder: true,
  levels: [
    { level: 1, name: "CHIARIFICAZIONE", text: "Domanda livello 1", purpose: "..." },
    { level: 2, name: "CONSEGUENZE", text: "Domanda livello 2", purpose: "..." },
    // ... 3, 4, 5
  ]
}
Response: {
  success: true,
  ladderOverrides: { [stepId]: {...} }
}
Logica: Merge i 5 livelli con existing ladderOverrides

Endpoint 3: PUT /api/sales-scripts/:id/questions
Request Body: {
  stepId: "phase_3_step_2",
  questions: [
    { id: "q_1", text: "Dimmi di pi√π?", order: 1, type: "discovery" },
    { id: "q_2", text: "E perch√©?", order: 2, type: "ladder" }
  ]
}
Response: {
  success: true,
  stepQuestions: { [stepId]: [...] }
}
Logica: Merge domande con existing stepQuestions

Endpoint 4: PUT /api/sales-scripts/:id/biscottini
Request Body: {
  stepId: "phase_2_step_1",
  biscottini: [
    { text: "Sei molto organizzato!", type: "rapport" },
    { text: "Risparmi tempo", type: "value" }
  ]
}
Response: {
  success: true,
  stepBiscottini: { [stepId]: [...] }
}
Logica: Merge biscottini con existing stepBiscottini

Endpoint 5: GET /api/sales-scripts/:id/enhanced
Response: {
  ...script,
  energySettings: { [phaseOrStepId]: {...} },
  ladderOverrides: { [stepId]: {...} },
  stepQuestions: { [stepId]: [...] },
  stepBiscottini: { [stepId]: [...] }
}
Logica: Ritorna script completo con tutti gli override

‚è≥ PENDING (Fasi 8-15/15 - 53.3% RIMANENTE)
üé® FASE 8: FRONTEND - BlockEditor.tsx (ENERGY BADGE + LADDER INDICATOR)
Status: ‚è≥ IN PROGRESS
Requisiti:

 Aggiungere Energy Badge per ogni fase
Visualizza: Energy Level (ALTO/MEDIO/BASSO) con colore
Tooltip: Mostra tone, volume, pace, vocabulary
 Aggiungere Ladder Indicator per step
Icona: ü™ú se step ha ladder
Badge: "5 livelli" se completo
 Step Counter
Mostra: "Step 3/12" nel titolo
 Checkpoint Indicator
Icona: ‚õî se checkpoint presente
Badge: "3 verifiche"
üîß FASE 9: FRONTEND - PhaseInspector.tsx (ENERGY EDITOR)
Status: ‚è≥ PENDING
Requisiti:

 Sezione Energy Settings editabile
Dropdown per Level: BASSO/MEDIO/ALTO
Dropdown per Tone: CALMO/SICURO/CONFIDENZIALE/ENTUSIASTA
Dropdown per Volume: SOFT/NORMAL/LOUD
Dropdown per Pace: LENTO/MODERATO/VELOCE
Dropdown per Vocabulary: FORMALE/COLLOQUIALE/TECNICO
Text input per Reason (opzionale)
Button: "Salva Energy Settings"
 Preview colore energie
üìã FASE 10: FRONTEND - StepInspector.tsx (LADDER + QUESTIONS EDITOR)
Status: ‚è≥ PENDING
Requisiti:

 Sezione Ladder Levels (5 livelli)
Toggle: "Abilita Ladder"
Card per ogni livello (1-5)
Editable fields: name, text (domanda), purpose
Button: "Salva Ladder"
 Questions List editabile
Mostra tutte le domande
Inline edit: text, type, order
Add/Delete buttons
Button: "Salva Domande"
 Energy per Step
Mini versione della sezione energy
 Biscottini Section
List di biscottini
Add/Delete buttons
Type selector per ogni biscottino
üé™ FASE 11: FRONTEND - client-script-manager.tsx (MUTATIONS)
Status: ‚è≥ PENDING
Requisiti:

 useMutation: updateEnergySettings()
Chiama: PUT /api/sales-scripts/:id/energy
Loading state, error handling
 useMutation: updateLadderLevels()
Chiama: PUT /api/sales-scripts/:id/ladder
 useMutation: updateStepQuestions()
Chiama: PUT /api/sales-scripts/:id/questions
 useMutation: updateStepBiscottini()
Chiama: PUT /api/sales-scripts/:id/biscottini
 Toast notifications: Success/Error per ogni operazione
 Optimistic updates: UI update subito, rollback se error
üîç FASE 12: FRONTEND - ScriptReferencePanel.tsx (DISPLAY)
Status: ‚è≥ PENDING
Requisiti:

 Mostra Energy Badge per fase visibile
 Mostra Ladder Levels completi (5 livelli con domande)
 Questions Counter: "15 domande"
 Checkpoint Details: "3 checkpoint, 12 verifiche"
 Read-only view (solo display, no edit)
üìä FASE 13: ANALYTICS - client-sales-agent-analytics.tsx
Status: ‚è≥ PENDING
Requisiti:

 Aggiungi colonna: "Script Usato"
Visualizza: usedScriptName per conversazione
Link a script details
 Aggiungi filtro: "Script Type"
Filter by: discovery, demo, objections
 Aggiungi metrica: "Script Usage Distribution"
Chart: pie/bar di script pi√π usati
 Tooltip: Mostra version dello script usato
üó∫Ô∏è FASE 14: TRAINING MAP - training-map.tsx + TrainingMapLayout.tsx
Status: ‚è≥ PENDING
Requisiti:

 Usa usedScriptSnapshot invece dello script corrente
Backup: scriptSnapshot da conversation
Fallback: script corrente se non disponibile
 Mostra quale script era attivo per conversazione
 Tracking accurato di fasi/step/checkpoint con script corretto
ü§ñ FASE 15: AI TRAINING - gemini-training-analyzer.ts
Status: ‚è≥ PENDING
Requisiti:

 Carica lo script dalla conversazione (scriptSnapshot o usedScriptId)
 Non usare hardcoded sales-scripts-base.ts
 Passa script corretto a Gemini analyzer
 Analisi accurata basata su script effettivamente usato
üìà PROGRESS SUMMARY
Completato:     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 8 items (46.7%)
Rimanente:      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 7 items (53.3%)
Total:          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 15 items
Database:       ‚úÖ 100%
Parser:         ‚úÖ 100%
Tracker:        ‚úÖ 100%
API:            ‚úÖ 100%
Frontend:       ‚è≥  0% (8 task, 0% completate)
Analytics:      ‚è≥  0%
Training:       ‚è≥  0%
AI:             ‚è≥  0%

üéØ PROSSIMI STEP (PRIORIT√Ä)
CRITICO: Completare frontend BlockEditor (task 8)
CRITICO: Completare PhaseInspector editor (task 9)
ALTO: Completare StepInspector (task 10)
ALTO: Aggiungere mutations (task 11)
MEDIO: Display nel ScriptReferencePanel (task 12)
MEDIO: Analytics script tracking (task 13)
BASSO: Training map sync (task 14)
BASSO: Gemini analyzer update (task 15)
Tempo stimato per completamento: 4-6 ore di lavoro frontend concentrato