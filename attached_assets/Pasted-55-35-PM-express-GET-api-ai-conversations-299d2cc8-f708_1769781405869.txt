55:35 PM [express] GET /api/ai/conversations/299d2cc8-f708-41b3-96e7-ee93dce8ff12 200 in 817ms :: â€¦
ğŸ“ [User Preferences] Applying preferences - Style: eccentric, Length: balanced
ğŸ§  [Memory Context] Daily summaries: 3 days, 2302 chars, ~576 tokens
ğŸ§  [Conversation Memory] Loaded daily summaries for client: 7 conversations across multiple days
ğŸ§  [Conversation Memory] Loaded 5 recent detailed conversations for client

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” FILE SEARCH MODE: Switching to Google AI Studio (required for File Search)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ Provider: Google AI Studio (@google/genai)
   âœ… File Search API: SUPPORTED
   âš ï¸  Vertex AI: NOT compatible with File Search
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… [SuperAdmin Gemini] Loaded 1 API keys from config
âœ… Using SuperAdmin Gemini key for File Search (1/1)
ğŸ”„ Building context for client e9c37790-47ea-40cb-a93c-4242f3f07cdc (intent: consultations, sessionType: normal)
ğŸ“š Including ALL 0 exercises in context (no limits applied)
ğŸ“š Prepared 0 exercise metadata (content will be loaded on-demand when asked)
ğŸ“Š [Monthly Consultation Limit] Client e9c37790:
   - monthlyConsultationLimit from DB: 5
   - thisMonthConsultations count: 0
   - completedThisMonth: 0
   - scheduledThisMonth: 0
   - totalUsedThisMonth: 0
   - monthlyLimitInfo: {"limit":5,"completed":0,"scheduled":0,"totalUsed":0,"remaining":5,"isLimitReached":false,"month":1,"year":2026}
ğŸ“š Found 0 documents linked to exercises
ğŸ“š Total library documents included in context: 0 (intent: consultations)
ğŸ“Š Momentum stats: 0 check-ins (0 productive, 0% rate), streak: 0 days
ğŸ“… Calendar stats: 0 total upcoming (0 ongoing, 0 today, 0 this week)
ğŸ“š [Knowledge Base] Loading ALL knowledge content for client (no filtering)...
ğŸ“š [Client Knowledge Base] Loaded 0 documents and 0 APIs for client e9c37790-47ea-40cb-a93c-4242f3f07cdc
â„¹ï¸ [Knowledge Base] No documents or API data uploaded yet
ğŸ’¾ Stored fresh context in cache for client e9c37790-47ea-40cb-a93c-4242f3f07cdc (intent: consultations)
â±ï¸  [TIMING] Context building: 1164ms
â±ï¸  [TIMING] Exercise scraping: 1ms
ğŸ” [KB Fallback Debug] Querying indexed docs for clientId: e9c37790-47ea-40cb-a93c-4242f3f07cdc, consultantId: 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ“š [KB Fallback] 0 KB docs indexed, 0 will be in prompt
ğŸ“‹ [buildSystemPrompt] monthlyLimit in userContext:
   - consultations exists: true
   - monthlyLimit exists: true
   - monthlyLimit data: {"limit":5,"completed":0,"scheduled":0,"totalUsed":0,"remaining":5,"isLimitReached":false,"month":1,"year":2026}
â±ï¸  [TIMING] Prompt building: 250ms

ğŸ“Š Token Usage Estimation (Intent: consultations):
  - System Prompt: ~4,851 tokens
  - ğŸ§  Conversation Memory: ~753 tokens (included in System Prompt)
  - User Message: ~10 tokens
  - Conversation History: ~0 tokens
  - Total Estimated: ~4,861 tokens
  - File Search Mode: âœ… ACTIVE (RAG via stores)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š SYSTEM PROMPT BREAKDOWN (~4,851 tokens)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ NEL SYSTEM PROMPT (4,851 tokens):
   ğŸ‘¤ User Profile & Base: ~4,851 tokens
   â„¹ï¸  (Include: data/ora, profilo utente, istruzioni AI, metadata esercizi)

ğŸ” VIA FILE SEARCH RAG (indicizzati, cercati su richiesta):
   ğŸ“š Exercises: 192 tokens (3/1 documenti)
   ğŸ’¬ Consultations: 14,648 tokens (2/50 documenti)

   ğŸ’° TOTALE FILE SEARCH: 48,078 tokens (19 documenti indicizzati)

âš ï¸  NON DISPONIBILI ALL'AI (non sincronizzati in File Search):
   ğŸ“– Library: ~1,000 tokens (1 documenti)
   ğŸ’¬ Consultations: ~14,400 tokens (48 documenti)
   ğŸ“ University: ~800 tokens (1 documenti)
   ğŸ’¡ TIP: Sincronizza questi documenti in File Search per renderli disponibili all'AI

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… [FileSearch] Store name valid: fileSearchStores/private-store-client-e9c377-0qubcpy51a0r

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” AI MODE: FILE SEARCH SEMANTIC (Gemini RAG) [CLIENT]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ Stores disponibili: 1
      1. fileSearchStores/private-store-client-e9c377-0qubcpy51a0r

   ğŸ“Š BREAKDOWN DOCUMENTI PER STORE:

   ğŸ‘¥ Private Store - Client e9c37790 (19 documenti):
      ğŸ“§ Email Journey: 8
      ğŸ“„ exercise_external_doc: 6
      ğŸ‹ï¸ Esercizi: 3
      ğŸ’¬ Consulenze: 2
   âœ… Tool fileSearch: ATTIVO
   ğŸ“„ Il modello cercherÃ  semanticamente nei documenti indicizzati
   ğŸ’° RISPARMIO TOKENS: ~14,919 tokens (esercizi+library+consultazioni+KB)
   ğŸ“‰ System prompt ridotto: da ~19,770 a ~4,851 tokens
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[AI] Using model: gemini-3-flash-preview with thinking_level: low [CLIENT STREAMING]
[AI] Provider: Google AI Studio, User-selected: YES

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ” [Intent:377f0cf5] CLASSIFIER REQUEST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Model: gemini-2.5-flash-lite
   Message: "ciao! posso schedulare delle consulenze?"
   Context: hasPendingBooking=false
   Contents structure: 3 turns
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¤ [Intent:377f0cf5] CLASSIFIER RESPONSE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Latency: 674ms
   Response length: 183 chars
   Raw response: "<json>
{
  "intent": "booking_request",
  "confidence": 0.9,
  "reasoning": "The user explicitly asks to 'schedule consultations', which directly maps to a booking request."
}
</json>"
   Response object keys: sdkHttpResponse, candidates, modelVersion, responseId, usageMetadata
   Candidates count: 1
   First candidate parts: 1
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ¯ [Intent:377f0cf5] Classification Result
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Intent: booking_request
   Confidence: 90% (high)
   Latency: 674ms
   Reasoning: The user explicitly asks to 'schedule consultations', which directly maps to a booking request.
   User: 0c73bbe5-51e1-4108-866b-6be7a52fce3b
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ LLM INTENT CLASSIFIER [377f0cf5]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“‹ Intent: booking_request
   ğŸ“Š Confidence: 90% (high)
   ğŸ’¡ Reasoning: The user explicitly asks to 'schedule consultations', which directly maps to a booking request.
   ğŸ”§ Use tools: YES
   â“ Ask clarification: NO
   ğŸ” Trigger: regex match
   ğŸ« Pending Token: none
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ FUNCTION CALLING MODE ACTIVE [CONSULTATION QUERY]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“‹ Intent: booking_request
   ğŸ› ï¸  Tools: getAvailableSlots, proposeBooking
   âš™ï¸  Mode: AUTO (Gemini decides if tool needed)
   âŒ codeExecution: DISABLED
   âŒ fileSearch: DISABLED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”§ [CONSULTATION] Using non-streaming mode for function calling
ğŸ”’ [Semaphore] Acquired slot (1/3 in use)
ğŸ”“ [Semaphore] Released slot (0/3 in use)
ğŸ”§ [CONSULTATION] thoughtSignature present: true
ğŸ”§ [CONSULTATION] Function call detected: getAvailableSlots
   Args: {"startDate":"2026-01-30"}
ğŸ”§ [CONSULTATION TOOL] Executing getAvailableSlots for client e9c37790
   Args: {"startDate":"2026-01-30"}
   ConversationId: none
ğŸ“… [SLOTS] Loaded 63 events from Google Calendar
ğŸ”§ [CONSULTATION] Tool result: success=true
   Data: {"slots":[{"date":"2026-02-02","dayOfWeek":"lunedÃ¬","time":"09:00","dateFormatted":"lunedÃ¬ 2 febbraio","duration":60},{"date":"2026-02-02","dayOfWeek":"lunedÃ¬","time":"10:00","dateFormatted":"lunedÃ¬ 2 febbraio","duration":60},{"date":"2026-02-02","dayOfWeek":"lunedÃ¬","time":"15:00","dateFormatted":"lunedÃ¬ 2 febbraio","duration":60},{"date":"2026-02-02","dayOfWeek":"lunedÃ¬","time":"16:00","dateFormatted":"lunedÃ¬ 2 febbraio","duration":60},{"date":"2026-02-02","dayOfWeek":"lunedÃ¬","time":"17:00","dateFormatted":"lunedÃ¬ 2 febbraio","duration":60},{"date":"2026-02-03","dayOfWeek":"martedÃ¬","time":"09:00","dateFormatted":"martedÃ¬ 3 febbraio","duration":60},{"date":"2026-02-03","dayOfWeek":"martedÃ¬","time":"15:00","dateFormatted":"martedÃ¬ 3 febbraio","duration":60},{"date":"2026-02-03","dayOfWeek":"martedÃ¬","time":"16:00","dateFormatted":"martedÃ¬ 3 febbraio","duration":60},{"date":"2026-02-03","dayOfWeek":"martedÃ¬","time":"17:00","dateFormatted":"martedÃ¬ 3 febbraio","duration":60},{"date":"2026-02-04","dayOfWeek":"mercoledÃ¬","time":"09:00","dateFormatted":"mercoledÃ¬ 4 febbraio","duration":60},{"date":"2026-02-04","dayOfWeek":"mercoledÃ¬","time":"10:00","dateFormatted":"mercoledÃ¬ 4 febbraio","duration":60},{"date":"2026-02-04","dayOfWeek":"mercoledÃ¬","time":"15:00","dateFormatted":"mercoledÃ¬ 4 febbraio","duration":60},{"date":"2026-02-04","dayOfWeek":"mercoledÃ¬","time":"16:00","dateFormatted":"mercoledÃ¬ 4 febbraio","duration":60},{"date":"2026-02-04","dayOfWeek":"mercoledÃ¬","time":"17:00","dateFormatted":"mercoledÃ¬ 4 febbraio","duration":60},{"date":"2026-02-05","dayOfWeek":"giovedÃ¬","time":"09:00","dateFormatted":"giovedÃ¬ 5 febbraio","duration":60},{"date":"2026-02-05","dayOfWeek":"giovedÃ¬","time":"10:00","dateFormatted":"giovedÃ¬ 5 febbraio","duration":60},{"date":"2026-02-05","dayOfWeek":"giovedÃ¬","time":"15:00","dateFormatted":"giovedÃ¬ 5 febbraio","duration":60},{"date":"2026-02-05","dayOfWeek":"giovedÃ¬","time":"16:00","dateFormatted":"giovedÃ¬ 5 febbraio","duration":60},{"date":"2026-02-05","dayOfWeek":"giovedÃ¬","time":"17:00","dateFormatted":"giovedÃ¬ 5 febbraio","duration":60},{"date":"2026-02-06","dayOfWeek":"venerdÃ¬","time":"09:00","dateFormatted":"venerdÃ¬ 6 febbraio","duration":60}],"count":20,"duration":60,"calendarConnected":true,"message":"Ho trovato 20 slot disponibili (consulenze di 60 minuti). Ecco i primi:","next_action_hint":"Chiedi al cliente quale slot preferisce, poi usa proposeBooking"}
ğŸ”§ [CONSULTATION] Using original part: true
ğŸ”§ [CONSULTATION] modelParts[0] keys: functionCall, thoughtSignature
ğŸ”’ [Semaphore] Acquired slot (1/3 in use)
ğŸ”“ [Semaphore] Released slot (0/3 in use)
ğŸ”§ [CONSULTATION] Final response: 1191 chars
â±ï¸  [TIMING] Gemini API call (with streaming): 10300ms

âš ï¸  TOKEN USAGE: usageMetadata not available in streaming response [CLIENT]
âœ… AI streaming completed for message 73415b3d-5cdd-4352-bb3c-6f8fdae64edf
ğŸ“Š [TITLE-GEN] Client conversation e1f5026c-7d73-428a-9e15-c6062ac3ae53: 2 messages, current title: "ciao! posso schedulare delle consulenze?"

ğŸ“ [TITLE-GEN] Generating title for client conversation e1f5026c-7d73-428a-9e15-c6062ac3ae53...
   ğŸ“¨ User message: "ciao! posso schedulare delle consulenze?"
   ğŸ¤– AI response: "EhilÃ  Alessio! Ma certo, sono qui apposta per far incastrare i pezzi del puzzle e assicurarmi che il..."
   âš ï¸ [TITLE-GEN] Error generating title: Cannot find module '/home/runner/workspace/server/super-admin-gemini' imported from /home/runner/workspace/server/ai-service.ts

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ” FILE SEARCH STREAMING SUMMARY [CLIENT]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ“¦ Stores attivi: 1
   âš ï¸  Nota: In modalitÃ  streaming, le citazioni non sono disponibili
      nel response object. File Search Ã¨ stato configurato come tool.
   ğŸ“„ Se la risposta cita documenti specifici, Gemini ha usato File Search.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸  PERFORMANCE TIMING BREAKDOWN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   [0ms â†’ 1164ms] Context Building (1164ms)
   [1164ms â†’ 1165ms] Exercise Scraping (1ms)
   [1165ms â†’ 1415ms] Prompt Building (250ms)
   [1415ms â†’ 13911ms] Gemini API Call (10300ms)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â±ï¸  TOTAL: 13.91s (13911ms)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1:55:55 PM [express] POST /api/ai/chat 200 in 14835ms
1:55:55 PM [express] GET /api/ai/conversations 200 in 343ms :: [{"id":"e1f5026c-7d73-428a-9e15-c6062â€¦
1:55:55 PM [express] GET /api/ai/conversations/e1f5026c-7d73-428a-9e15-c6062ac3ae53 200 in 679ms :: â€¦
1:55:58 PM [express] POST /api/activity/session/heartbeat 200 in 342ms :: {"success":true,"lastActivâ€¦
ğŸ“ [User Preferences] Applying preferences - Style: eccentric, Length: balanced
ğŸ§  [Memory Context] Daily summaries: 3 days, 2302 chars, ~576 tokens
ğŸ§  [Conversation Memory] Loaded daily summaries for client: 7 conversations across multiple days
ğŸ§  [Conversation Memory] Loaded 5 recent detailed conversations for client

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” FILE SEARCH MODE: Switching to Google AI Studio (required for File Search)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ Provider: Google AI Studio (@google/genai)
   âœ… File Search API: SUPPORTED
   âš ï¸  Vertex AI: NOT compatible with File Search
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Using SuperAdmin Gemini key for File Search (1/1)
ğŸ”„ Building context for client e9c37790-47ea-40cb-a93c-4242f3f07cdc (intent: general, sessionType: normal)
ğŸ“š Including ALL 3 exercises in context (no limits applied)
ğŸ“š Prepared 3 exercise metadata (content will be loaded on-demand when asked)
ğŸ“Š [Monthly Consultation Limit] Client e9c37790:
   - monthlyConsultationLimit from DB: 5
   - thisMonthConsultations count: 0
   - completedThisMonth: 0
   - scheduledThisMonth: 0
   - totalUsedThisMonth: 0
   - monthlyLimitInfo: {"limit":5,"completed":0,"scheduled":0,"totalUsed":0,"remaining":5,"isLimitReached":false,"month":1,"year":2026}
ğŸ“š Found 0 documents linked to exercises
ğŸ“š Total library documents included in context: 0 (intent: general)
ğŸ“Š Momentum stats: 0 check-ins (0 productive, 0% rate), streak: 0 days
ğŸ“… Calendar stats: 0 total upcoming (0 ongoing, 0 today, 0 this week)
ğŸ“š [Knowledge Base] Loading ALL knowledge content for client (no filtering)...
ğŸ“š [Client Knowledge Base] Loaded 0 documents and 0 APIs for client e9c37790-47ea-40cb-a93c-4242f3f07cdc
â„¹ï¸ [Knowledge Base] No documents or API data uploaded yet
ğŸ’¾ Stored fresh context in cache for client e9c37790-47ea-40cb-a93c-4242f3f07cdc (intent: general)
â±ï¸  [TIMING] Context building: 1150ms
ğŸ” [FileSearch] Exercises indexed check: 3/3 checked, using FileSearch: true
â±ï¸  [TIMING] Exercise scraping: 343ms
ğŸ” [KB Fallback Debug] Querying indexed docs for clientId: e9c37790-47ea-40cb-a93c-4242f3f07cdc, consultantId: 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ“š [KB Fallback] 0 KB docs indexed, 0 will be in prompt
ğŸ“‹ [buildSystemPrompt] monthlyLimit in userContext:
   - consultations exists: true
   - monthlyLimit exists: true
   - monthlyLimit data: {"limit":5,"completed":0,"scheduled":0,"totalUsed":0,"remaining":5,"isLimitReached":false,"month":1,"year":2026}
â±ï¸  [TIMING] Prompt building: 227ms

ğŸ“Š Token Usage Estimation (Intent: general):
  - System Prompt: ~4,925 tokens
  - ğŸ§  Conversation Memory: ~753 tokens (included in System Prompt)
  - User Message: ~6 tokens
  - Conversation History: ~253 tokens
  - Total Estimated: ~5,184 tokens
  - File Search Mode: âœ… ACTIVE (RAG via stores)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š SYSTEM PROMPT BREAKDOWN (~4,925 tokens)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ NEL SYSTEM PROMPT (4,925 tokens):
   ğŸ‘¤ User Profile & Base: ~4,925 tokens
   â„¹ï¸  (Include: data/ora, profilo utente, istruzioni AI, metadata esercizi)

ğŸ” VIA FILE SEARCH RAG (indicizzati, cercati su richiesta):
   ğŸ“š Exercises: 192 tokens (3/1 documenti)
   ğŸ’¬ Consultations: 14,648 tokens (2/50 documenti)

   ğŸ’° TOTALE FILE SEARCH: 48,078 tokens (19 documenti indicizzati)

âš ï¸  NON DISPONIBILI ALL'AI (non sincronizzati in File Search):
   ğŸ“– Library: ~1,000 tokens (1 documenti)
   ğŸ’¬ Consultations: ~14,400 tokens (48 documenti)
   ğŸ“ University: ~800 tokens (1 documenti)
   ğŸ’¡ TIP: Sincronizza questi documenti in File Search per renderli disponibili all'AI

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… [FileSearch] Store name valid: fileSearchStores/private-store-client-e9c377-0qubcpy51a0r

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” AI MODE: FILE SEARCH SEMANTIC (Gemini RAG) [CLIENT]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ Stores disponibili: 1
      1. fileSearchStores/private-store-client-e9c377-0qubcpy51a0r

   ğŸ“Š BREAKDOWN DOCUMENTI PER STORE:

   ğŸ‘¥ Private Store - Client e9c37790 (19 documenti):
      ğŸ“§ Email Journey: 8
      ğŸ“„ exercise_external_doc: 6
      ğŸ‹ï¸ Esercizi: 3
      ğŸ’¬ Consulenze: 2
   âœ… Tool fileSearch: ATTIVO
   ğŸ“„ Il modello cercherÃ  semanticamente nei documenti indicizzati
   ğŸ’° RISPARMIO TOKENS: ~15,267 tokens (esercizi+library+consultazioni+KB)
   ğŸ“‰ System prompt ridotto: da ~20,192 a ~4,925 tokens
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[AI] Using model: gemini-3-flash-preview with thinking_level: low [CLIENT STREAMING]
[AI] Provider: Google AI Studio, User-selected: YES
ğŸ› ï¸  [TOOLS] Client chat: codeExecution=YES, fileSearch=YES
ğŸ”„ AI stream attempt 1/6...
ğŸ”’ [Semaphore] Acquired slot (1/3 in use)
ğŸ”“ [Semaphore] Released slot (0/3 in use)
âœ… AI streaming completed successfully on attempt 1
â±ï¸  [TIMING] Gemini API call (with streaming): 2505ms

âš ï¸  TOKEN USAGE: usageMetadata not available in streaming response [CLIENT]
âœ… AI streaming completed for message 889d93bf-f1c4-4b79-98bb-3e754010455f
ğŸ“Š [TITLE-GEN] Client conversation e1f5026c-7d73-428a-9e15-c6062ac3ae53: 4 messages, current title: "ciao! posso schedulare delle consulenze?"
   â„¹ï¸ [TITLE-GEN] Skipping - messageCount is 4, not 2

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ” FILE SEARCH STREAMING SUMMARY [CLIENT]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ“¦ Stores attivi: 1
   âš ï¸  Nota: In modalitÃ  streaming, le citazioni non sono disponibili
      nel response object. File Search Ã¨ stato configurato come tool.
   ğŸ“„ Se la risposta cita documenti specifici, Gemini ha usato File Search.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸  PERFORMANCE TIMING BREAKDOWN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   [0ms â†’ 1150ms] Context Building (1150ms)
   [1150ms â†’ 1493ms] Exercise Scraping (343ms)
   [1493ms â†’ 1720ms] Prompt Building (227ms)
   [1720ms â†’ 5820ms] Gemini API Call (2505ms)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â±ï¸  TOTAL: 5.82s (5820ms)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1:56:14 PM [express] POST /api/ai/c