Problema 1: Template/Preview non mostrato
Hai ragione - l'activity-log NON mostra quale template √® stato programmato. Guarda cosa viene salvato nei messaggi schedulati:

templateId ‚úÖ salvato nel database
fallbackMessage ‚úÖ salvato
aiDecisionReasoning ‚úÖ mostrato come reasoning
Ma l'API activity-log (linee 866-895) NON restituisce:

Il template associato
La preview del messaggio che sar√† inviato
Problema 2: Logica 24h - Analisi completa
La logica attuale ha buchi importanti. Ecco la tabella completa:

CASI GESTITI ‚úÖ
Scenario	Comportamento	Dove nel codice
Lead risponde entro 24h, ultimo msg √® nostro	Regola P96: AI genera messaggio libero	system-rules-config.ts linea 166-169
Lead risponde entro 24h, ultimo msg √® suo	Regola P95: Skip (attendiamo)	system-rules-config.ts linea 171-175
Lead dice NO esplicitamente	STOP totale	system-rules-config.ts linea 154-155
Max follow-up raggiunto	STOP	system-rules-config.ts linea 157-158
Messaggio programmato, lead risponde prima dell'invio	Cancellato al momento dell'invio	followup-scheduler.ts linea 1170-1177
Invio fuori 24h con template approvato	Usa ContentSid Twilio	followup-scheduler.ts linea 1250-1254
CASI NON GESTITI ‚ùå (da implementare)
Scenario	Problema attuale	Cosa dovrebbe succedere
AI programma per domani ma siamo gi√† fuori 24h	Errore "No approved template"	Prima di schedulare, verificare se a quell'ora saremo fuori finestra ‚Üí usare template invece di AI message
Messaggio programmato per dopo scadenza 24h	Il sistema non calcola quando scade la finestra 24h	Anticipare invio PRIMA della scadenza o programmare template
Lead risponde, messaggio gi√† schedulato	Cancellato solo al momento dell'invio	Cancellare IMMEDIATAMENTE quando arriva risposta (webhook)
Preview template programmato	Non mostrata nel frontend	Aggiungere templateId + body alla risposta activity-log
AI non percepisce "non posso mandare libero fuori 24h"	L'AI decide senza sapere dei vincoli WhatsApp	Passare all'AI l'info: "Fuori 24h = solo template"
Regole utente con maxHoursSinceLeadMessage: 24	Condizione salvata ma mai verificata	Implementare check nel findApplicableRules
Invio immediato ("Send Now") fuori 24h senza template	Fallisce con errore	Bloccare bottone o mostrare warning
Countdown finestra 24h visibile	Non mostrato	Mostrare timer "Finestra libera scade tra X ore"
FLUSSO IDEALE vs ATTUALE
ATTUALE (problematico):
AI valuta ‚Üí decide "schedule tomorrow" ‚Üí non verifica se saremo fuori 24h ‚Üí 
‚Üí arriva il momento ‚Üí prova a inviare ‚Üí ERRORE (no template)
IDEALE:
AI valuta ‚Üí calcola "saremo fuori 24h?" ‚Üí 
  SE s√¨ ‚Üí cerca template approvato ‚Üí schedula con template
  SE no ‚Üí genera messaggio AI ‚Üí schedula
Lead risponde ‚Üí webhook ‚Üí cancella immediatamente schedulati

Cosa serve implementare (riassunto):
Nel decision engine: Passare all'AI l'info sulla finestra 24h residua
Nel scheduler: Prima di schedulare, calcolare se scheduledFor superer√† le 24h
Nel webhook WhatsApp: Quando arriva messaggio lead, cancellare pending subito
Nel frontend: Mostrare preview template + timer finestra 24h
Nel "Send Now": Bloccare se fuori 24h e nessun template disponibile



Ottima domanda! Con 100 lead/giorno la situazione attuale diventa problematica. Vediamo l'analisi:

Architettura Attuale (problemi di scala)
CRON ogni 5 min ‚Üí Query TUTTE le conversazioni attive ‚Üí 
  Per OGNI conversazione:
    - 5-6 query database
    - 1 chiamata AI (Gemini)
    - Scrittura log

Con 100 lead/giorno, dopo 30 giorni hai ~1000+ conversazioni attive.

Ogni ciclo CRON:

~5000 query database
~1000 chiamate AI ($$$ e lento!)
Tempo ciclo: potenzialmente 10-20 minuti (supera i 5 min del CRON ‚Üí overlap!)
Colli di Bottiglia Principali
Problema	Impatto	Priorit√†
1 chiamata AI per conversazione	Costo elevato, lento	üî¥ Critico
Query N+1	Ogni conversazione = 5+ query	üî¥ Critico
Nessun batching	Tutto sequenziale	üü† Alto
No caching	Ricalcola tutto ogni 5 min	üü† Alto
No prioritizzazione	Valuta anche lead "freddi"	üü° Medio
CRON sincrono	Blocca se lungo	üü° Medio
Strategia di Ottimizzazione (livello superiore)
1. Segmentazione Intelligente (non valutare tutti)
HOT leads (risposto < 2h)     ‚Üí valuta ogni 5 min
WARM leads (risposto < 24h)   ‚Üí valuta ogni 30 min  
COLD leads (silenzio > 24h)   ‚Üí valuta ogni 2 ore
GHOST leads (silenzio > 7gg)  ‚Üí valuta 1 volta/giorno

2. Batching AI (1 chiamata per N conversazioni)
Invece di 100 chiamate AI separate, raggruppa:

"Valuta queste 20 conversazioni e dimmi per ognuna cosa fare"
‚Üí 1 chiamata invece di 20

3. Pre-calcolo e Caching
Calcola hoursSinceLastInbound una volta e cachea
Regole deterministiche (P96-P100) non servono AI ‚Üí skip immediato
4. Queue con Priorit√†
Redis/BullMQ queue:
- priority: 1 = HOT leads
- priority: 5 = COLD leads
- Workers paralleli processano la coda

5. Database Ottimizzato
Indici su lastMessageAt, currentState
Query batch con JOIN invece di N+1
Materialized view per metriche frequenti
Stima Impatto
Metrica	Attuale (100 lead)	Ottimizzato
Chiamate AI/ciclo	~200-500	~20-50 (batching)
Query DB/ciclo	~2000	~50 (batch query)
Tempo ciclo	5-15 min	~30 sec
Costo AI/mese	$$$	$
Priorit√† Implementazione
Quick wins (1-2 giorni):

Segmentazione per temperatura lead
Batch query database
Skip AI per regole deterministiche
Medio termine (3-5 giorni):

Batching chiamate AI
Sistema di code con priorit√†
Lungo termine:

Redis per caching
Workers distribuiti
Analytics real-time


PIANO COMPLETO: AI Follow-up System v2.0
FASE 1: Bug Fix Critici (Logica 24h)
1.1 Cancellazione immediata messaggi quando lead risponde

Nel webhook WhatsApp, quando arriva messaggio inbound, cancellare tutti i scheduledFollowupMessages pending per quella conversazione
Non aspettare il momento dell'invio
1.2 Validazione finestra 24h PRIMA di schedulare

Nel decision engine, calcolare: "A che ora saremo fuori 24h?"
Se scheduledFor > scadenza24h ‚Üí forzare uso template approvato
Se nessun template ‚Üí non schedulare, loggare errore specifico
1.3 Blocco "Send Now" fuori 24h senza template

Frontend: disabilitare bottone se fuori finestra e no template
Mostrare tooltip: "Fuori finestra 24h - serve template approvato"
FASE 2: Scalabilit√† Backend
2.1 Segmentazione Lead per "temperatura"

Aggiungere campo temperatureLevel in conversationStates (hot/warm/cold/ghost)
Calcolare automaticamente basandosi su hoursSinceLastInbound
CRON diversi per temperatura:
HOT (< 2h): ogni 5 min
WARM (< 24h): ogni 30 min
COLD (< 7gg): ogni 2 ore
GHOST (> 7gg): 1 volta/giorno
2.2 Batch Query Database

Sostituire query N+1 con JOIN unica
Caricare tutti i dati necessari in 1-2 query invece di 5+ per conversazione
2.3 Skip AI per regole deterministiche

Valutare PRIMA le regole sistema (P96-P100)
Se match ‚Üí non chiamare AI, risparmiando tempo e costi
2.4 Batching Chiamate AI (fase 2)

Raggruppare conversazioni simili (stesso stato, stessa temperatura)
1 chiamata AI per batch di 10-20 conversazioni
Prompt strutturato: "Valuta queste N conversazioni"
FASE 3: Redesign Log Activity (Backend)
3.1 Arricchire dati scheduledMessages

Restituire templateId, templateName, templateBody (preview)
Aggiungere window24hExpiresAt (quando scade finestra libera)
Aggiungere canSendFreeform (true/false)
3.2 Nuovo endpoint /api/followup/conversation/:id/timeline

Timeline dettagliata per singola conversazione
Include: tutti gli eventi, messaggi, decisioni AI
Paginazione per performance
3.3 Endpoint stats aggregati

/api/followup/stats/summary ‚Üí metriche giornaliere
Messaggi inviati, tasso successo, errori per tipo
FASE 4: Redesign Log Activity (Frontend)
4.1 Card Lead Migliorata

Timer visivo "Finestra 24h scade tra: X ore Y min"
Badge temperatura lead (üî• Hot, üü° Warm, ‚ùÑÔ∏è Cold, üëª Ghost)
Preview messaggio programmato (espandibile)
Stato template: ‚úÖ Approvato, ‚è≥ In attesa, ‚ùå Nessuno
4.2 Timeline Eventi Migliorata

Icone pi√π chiare per ogni tipo evento
Espansione reasoning AI completo (non troncato)
Link diretto a modifica regola se errore
Distinzione visiva: messaggio AI vs template
4.3 Filtri e Ricerca Avanzati

Filtro per agente specifico
Filtro per temperatura lead
Ricerca per nome lead/telefono
Filtro per range date
4.4 Dashboard Metriche

Grafico: messaggi inviati vs programmati vs falliti (ultimi 7gg)
Tasso risposta per tipo messaggio (AI vs template)
Top 5 errori pi√π frequenti
FASE 5: Ottimizzazioni Finali
5.1 Caching intelligente

Cache risultati query frequenti (5 min TTL)
Invalidare cache quando arriva messaggio
5.2 Rate limiting per consulente

Max 50 messaggi/ora per consulente
Distribuzione uniforme (no burst)
5.3 Monitoring e Alerting

Log strutturati per debug
Alert se CRON supera 2 min di esecuzione
Alert se tasso errori > 10%