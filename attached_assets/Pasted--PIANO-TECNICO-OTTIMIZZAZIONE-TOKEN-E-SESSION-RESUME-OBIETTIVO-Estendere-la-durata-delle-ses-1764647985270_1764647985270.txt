ğŸ“‹ PIANO TECNICO: OTTIMIZZAZIONE TOKEN E SESSION RESUME
ğŸ¯ OBIETTIVO
Estendere la durata delle sessioni Gemini Live da ~15-20 scambi a ~30-40+ scambi riducendo il consumo di token e implementando il session resume nel training automatico.

ğŸ”´ PROBLEMA 1: SALES_MANAGER_INSTRUCTION Accumula Token
Situazione Attuale
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONTEXT WINDOW (32,000 tokens)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ SCRIPT SALES (~20,000 tokens) - FISSO                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ SPAZIO DISPONIBILE (~12,000 tokens)                           â”‚
â”‚                                                                             â”‚
â”‚  Turn 1: [USER: 50 tok] [AI: 100 tok] [FEEDBACK: 400 tok] â† Rimane!        â”‚
â”‚  Turn 2: [USER: 50 tok] [AI: 100 tok] [FEEDBACK: 400 tok] â† Rimane!        â”‚
â”‚  Turn 3: [USER: 50 tok] [AI: 100 tok] [FEEDBACK: 400 tok] â† Rimane!        â”‚
â”‚  ...                                                                        â”‚
â”‚  Turn 15: ESAURITO! âŒ Session termina prematuramente                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ“Š CALCOLO:
- Ogni turno: ~550 token (50 user + 100 AI + 400 feedback)
- Spazio: 12,000 token
- Turni massimi: 12,000 Ã· 550 = ~22 turni teorici (meno in pratica)

Dove viene inviato il FEEDBACK (linea 4493-4505):
// ATTUALE: Invia feedback con turnComplete: false
// Il feedback RIMANE nel context come "fresh text input"
geminiSession.send(JSON.stringify({
  client_content: {
    turns: [{
      role: 'user',
      parts: [{ text: `[SALES_MANAGER_INSTRUCTION]\n${feedbackMessage}` }]
    }],
    turn_complete: false  // â† Non genera risposta, MA occupa token!
  }
}));

Soluzione: "Strip After Client Response"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONTEXT WINDOW OTTIMIZZATO                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ SCRIPT SALES (~20,000 tokens) - FISSO                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ SPAZIO DISPONIBILE (~12,000 tokens)                           â”‚
â”‚                                                                             â”‚
â”‚  Turn 1: [USER: 50 tok] [AI: 100 tok]  â† Feedback STRIPPATO dopo risposta  â”‚
â”‚  Turn 2: [USER: 50 tok] [AI: 100 tok]  â† Feedback STRIPPATO dopo risposta  â”‚
â”‚  Turn 3: [USER: 50 tok] [AI: 100 tok]  â† Solo ultimo feedback attivo       â”‚
â”‚  ...                                                                        â”‚
â”‚  Turn 40+: Ancora spazio! âœ…                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ“Š NUOVO CALCOLO:
- Ogni turno: ~150 token (50 user + 100 AI, feedback strippato)
- Spazio: 12,000 token
- Turni massimi: 12,000 Ã· 150 = ~80 turni teorici (2x miglioramento!)

Meccanismo "Fire and Forget"
FLUSSO TEMPORALE:
================
        T0              T1              T2              T3
        â”‚               â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼               â–¼
   [AI parla]     [Manager         [Cliente       [AI processa
                  analizza]        risponde]      feedback â†’ risponde]
                      â”‚               â”‚               â”‚
                      â”‚               â”‚               â”‚
                      â–¼               â”‚               â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚               â”‚
            â”‚ FEEDBACK INVIATOâ”‚       â”‚               â”‚
            â”‚ turnComplete:   â”‚       â”‚               â”‚
            â”‚ false           â”‚       â”‚               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚               â”‚
                     â”‚                â”‚               â”‚
                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                     â”‚    â”‚ CLIENT AUDIO DETECTED â”‚   â”‚
                     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                     â”‚                â”‚               â”‚
                     â–¼                â–¼               â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
            â”‚  ğŸ”¥ STRIP: System instruction aggiornata      â”‚
            â”‚     senza i vecchi SALES_MANAGER_INSTRUCTION  â”‚
            â”‚                                               â”‚
            â”‚  Gemini API: session.send({                   â”‚
            â”‚    client_content: {                          â”‚
            â”‚      turns: [{                                â”‚
            â”‚        role: 'system',                        â”‚
            â”‚        parts: [{ text: 'nuovo contesto' }]    â”‚
            â”‚      }],                                      â”‚
            â”‚      turn_complete: false                     â”‚
            â”‚    }                                          â”‚
            â”‚  });                                          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Implementazione Tecnica
File: server/ai/gemini-live-ws-service.ts

// NUOVA VARIABILE: Traccia feedback pendente
let pendingSalesManagerFeedback: string | null = null;
// MODIFICA alla linea ~4493: NON inviare subito, salvare
function injectSalesManagerFeedback(feedback: string) {
  pendingSalesManagerFeedback = feedback;
  console.log(`ğŸ“ [FEEDBACK] Buffered for next turn: ${feedback.substring(0, 50)}...`);
}
// NUOVA FUNZIONE: Chiamata quando cliente inizia a parlare
function onClientAudioDetected() {
  if (pendingSalesManagerFeedback) {
    // Invia feedback ORA (just-in-time)
    geminiSession.send(JSON.stringify({
      client_content: {
        turns: [{
          role: 'user',
          parts: [{ text: `[SALES_MANAGER_INSTRUCTION]\n${pendingSalesManagerFeedback}` }]
        }],
        turn_complete: false
      }
    }));
    
    // Subito dopo, "strippalo" con un'istruzione di sistema vuota
    // che sovrascrive il contesto precedente
    pendingSalesManagerFeedback = null;
  }
}

ğŸ”´ PROBLEMA 2: Prospect Simulator Senza Session Resume
Situazione Attuale
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROSPECT SIMULATOR - FLUSSO ATTUALE                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚    [START]                                                                  â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ createSession() â”‚  â† Crea nuova sessione                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ connectToWebSocket()                                        â”‚            â”‚
â”‚  â”‚                                                             â”‚            â”‚
â”‚  â”‚ URL: ws://host/ws/ai-voice?mode=sales_agent                 â”‚            â”‚
â”‚  â”‚                            &sessionToken=xxx                â”‚            â”‚
â”‚  â”‚                            &shareToken=yyy                  â”‚            â”‚
â”‚  â”‚                                                             â”‚            â”‚
â”‚  â”‚ âŒ MANCA: resumeHandle=zzz                                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Turno 1...10   â”‚ â”€â”€â–¶ â”‚  TIMEOUT 10min  â”‚ â”€â”€â–¶ â”‚ âŒ SESSIONE     â”‚        â”‚
â”‚  â”‚  Funziona OK    â”‚     â”‚  goAway ricevutoâ”‚     â”‚    PERSA!       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Soluzione: Implementare Session Resume
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROSPECT SIMULATOR - FLUSSO CORRETTO                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚    [START]                                                                  â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ createSession() â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ connectToWebSocket()                                        â”‚            â”‚
â”‚  â”‚                                                             â”‚            â”‚
â”‚  â”‚ URL: ws://host/ws/ai-voice?mode=sales_agent                 â”‚            â”‚
â”‚  â”‚                            &sessionToken=xxx                â”‚            â”‚
â”‚  â”‚                            &shareToken=yyy                  â”‚            â”‚
â”‚  â”‚                            &resumeHandle=zzz  âœ… AGGIUNTO   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                   â”‚                                         â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚           â”‚                       â”‚                       â”‚                 â”‚
â”‚           â–¼                       â–¼                       â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Gestisce msg:   â”‚   â”‚ Gestisce msg:       â”‚   â”‚ Gestisce msg:   â”‚        â”‚
â”‚  â”‚ session_        â”‚   â”‚ session_expiring    â”‚   â”‚ goAway          â”‚        â”‚
â”‚  â”‚ resumption_     â”‚   â”‚                     â”‚   â”‚                 â”‚        â”‚
â”‚  â”‚ update          â”‚   â”‚ â†’ Salva handle      â”‚   â”‚ â†’ Reconnect     â”‚        â”‚
â”‚  â”‚                 â”‚   â”‚ â†’ Prepara reconnect â”‚   â”‚   automatico    â”‚        â”‚
â”‚  â”‚ â†’ Salva handle  â”‚   â”‚                     â”‚   â”‚                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                       â”‚                       â”‚                 â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                   â”‚                                         â”‚
â”‚                                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚                    RECONNECT AUTOMATICO                     â”‚            â”‚
â”‚  â”‚                                                             â”‚            â”‚
â”‚  â”‚  1. Chiudi vecchio WebSocket                                â”‚            â”‚
â”‚  â”‚  2. Aspetta 1 secondo                                       â”‚            â”‚
â”‚  â”‚  3. Riconnetti con resumeHandle salvato                     â”‚            â”‚
â”‚  â”‚  4. Continua la sessione senza perdere contesto âœ…          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Codice da Aggiungere
File: server/services/prospect-simulator/index.ts

// NUOVA PROPRIETÃ€ nella classe
private resumeHandle: string | null = null;
private reconnectAttempts = 0;
private maxReconnectAttempts = 3;
// MODIFICA buildWebSocketUrl()
private buildWebSocketUrl(): string {
  const params = new URLSearchParams({
    mode: 'sales_agent',
    sessionToken: this.sessionToken!,
    shareToken: this.options.agent.shareToken,
  });
  
  if (this.options.testMode) {
    params.set('testMode', this.options.testMode);
  }
  
  // âœ… NUOVO: Aggiungi resumeHandle se disponibile
  if (this.resumeHandle) {
    params.set('resumeHandle', this.resumeHandle);
  }
  
  return `${protocol}://${host}/ws/ai-voice?${params.toString()}`;
}
// NUOVI HANDLER in handleServerMessage()
case 'session_resumption_update':
  this.resumeHandle = message.handle;
  console.log(`ğŸ”„ [PROSPECT SIMULATOR] Resume handle saved: ${message.handle.substring(0, 20)}...`);
  break;
case 'session_expiring':
  console.log(`â° [PROSPECT SIMULATOR] Session expiring in ${message.timeLeft}s, preparing reconnect...`);
  // Il server ha giÃ  inviato l'handle via session_resumption_update
  break;
case 'goAway':
  console.log(`âš ï¸ [PROSPECT SIMULATOR] GoAway received, attempting reconnect...`);
  await this.attemptReconnect();
  break;
// NUOVO METODO
private async attemptReconnect(): Promise<void> {
  if (this.reconnectAttempts >= this.maxReconnectAttempts) {
    console.error(`âŒ [PROSPECT SIMULATOR] Max reconnect attempts reached`);
    await this.completeSession();
    return;
  }
  
  this.reconnectAttempts++;
  console.log(`ğŸ”„ [PROSPECT SIMULATOR] Reconnect attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
  
  // Chiudi vecchio WebSocket
  if (this.ws) {
    this.ws.close();
    this.ws = null;
  }
  
  // Attendi 1 secondo
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Riconnetti con resumeHandle
  await this.connectToWebSocket();
}

ğŸ“Š IMPATTO ATTESO
Metrica	Prima	Dopo	Miglioramento
Turni per sessione	~20	~40+	+100%
Token risparmiati	0	~8,000/sessione	-25% costo
Training timeout	Sessione persa	Auto-resume	+âˆ durata
ğŸ“ FILE DA MODIFICARE
server/ai/gemini-live-ws-service.ts

Implementare "fire and forget" per SALES_MANAGER_INSTRUCTION
Buffer feedback, invia just-in-time, strippalo dopo
server/services/prospect-simulator/index.ts

Aggiungere resumeHandle property
Modificare buildWebSocketUrl() per includere resumeHandle
Gestire messaggi: session_resumption_update, session_expiring, goAway
Implementare attemptReconnect()