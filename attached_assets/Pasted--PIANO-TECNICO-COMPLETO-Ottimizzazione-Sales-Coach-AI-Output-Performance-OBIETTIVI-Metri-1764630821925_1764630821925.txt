ðŸ“‹ PIANO TECNICO COMPLETO
Ottimizzazione Sales Coach AI - Output & Performance
ðŸŽ¯ OBIETTIVI
Metrica	ATTUALE	TARGET
Latenza risposta	5000-8000 ms	1000-2000 ms
Token feedback	~150+ parole	90-110 token
Riferimenti tecnici	"step", "fase", "checkpoint"	ZERO
Checkpoint verde	PuÃ² tornare rosso	Verde = verde per sempre
ðŸ—ï¸ ARCHITETTURA ATTUALE (PROBLEMA)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUSSO ATTUALE (LENTO)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Utente parla                                                â”‚
â”‚         â†“                                                       â”‚
â”‚  2. validateCheckpointWithAI()  â”€â”€â”€â”€â”€â”€â†’  ~2000-4000ms          â”‚
â”‚         â†“  (SEQUENZIALE!)                                       â”‚
â”‚  3. analyzeStepAdvancement()    â”€â”€â”€â”€â”€â”€â†’  ~2000-4000ms          â”‚
â”‚         â†“                                                       â”‚
â”‚  4. Genera feedback verboso     â”€â”€â”€â”€â”€â”€â†’  ~150+ parole          â”‚
â”‚         â†“                                                       â”‚
â”‚  5. Injection al venditore      â”€â”€â”€â”€â”€â”€â†’  TOTALE: 5000-8000ms   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… ARCHITETTURA NUOVA (SOLUZIONE)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUSSO OTTIMIZZATO                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Utente parla                                                â”‚
â”‚         â†“                                                       â”‚
â”‚  2. Promise.all([                                               â”‚
â”‚        validateCheckpointWithAI(),  â”                           â”‚
â”‚        analyzeStepAdvancement()     â”˜â”€â”€â†’  ~1000-1500ms MAX     â”‚
â”‚     ])  (PARALLELO!)                                            â”‚
â”‚         â†“                                                       â”‚
â”‚  3. formatCompactFeedback()         â”€â”€â†’  90-110 token          â”‚
â”‚         â†“                                                       â”‚
â”‚  4. Injection al venditore          â”€â”€â†’  TOTALE: 1000-2000ms   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ðŸ“ FILE DA MODIFICARE
FILE 1: server/ai/sales-manager-agent.ts
Posizione: Riga 821 e 979

PRIMA (sequenziale):

// Riga 821
const checkpointStatus = await this.validateCheckpointWithAI(params);
// ... altro codice ...
// Riga 979
const aiAnalysis = await this.analyzeStepAdvancement(params);

DOPO (parallelo):

// Riga 821 - SOSTITUIRE CON:
const [checkpointStatus, aiAnalysis] = await Promise.all([
  this.validateCheckpointWithAI(params),
  this.analyzeStepAdvancement(params)
]);

Posizione: Riga 767

PRIMA:

private static readonly TIMEOUT_MS = 6000; // 6 secondi max

DOPO:

private static readonly TIMEOUT_MS = 3000; // 3 secondi max

Posizione: Riga 1042-1084 (blocco forzato checkpoint)

MODIFICA: Aggiungere condizione soft validation

// PRIMA: blocca sempre se canAdvance === false
if (isPhaseTransition && checkpointStatus && !checkpointStatus.canAdvance) {
// DOPO: permetti se qualityScore >= 6
if (isPhaseTransition && checkpointStatus && !checkpointStatus.canAdvance 
    && (checkpointStatus.qualityScore?.overall || 0) < 6) {

FILE 2: server/ai/step-advancement-agent.ts
Posizione: Riga 660-663

PRIMA:

generationConfig: {
  temperature: 0,
  maxOutputTokens: 2000,
}

DOPO:

generationConfig: {
  temperature: 0,
  maxOutputTokens: 300,
}

Posizione: Riga 714 - Filtrare messaggi

PRIMA:

const conversationText = recentMessages
  .map(m => `${m.role === 'user' ? 'PROSPECT' : 'AGENTE'}: ${m.content}`)
  .join('\n\n');

DOPO:

// Filtra solo messaggi della fase corrente
const phaseMessages = this.getPhaseRelevantMessages(recentMessages, currentPhase, checkpoint);
const conversationText = phaseMessages
  .map(m => `${m.role === 'user' ? 'PROSPECT' : 'AGENTE'}: ${m.content}`)
  .join('\n\n');

NUOVA FUNZIONE DA AGGIUNGERE:

private static getPhaseRelevantMessages(
  messages: ConversationMessage[],
  currentPhase: any,
  checkpoint: any
): ConversationMessage[] {
  // Estrai le domande della fase corrente
  const phaseQuestions = currentPhase?.steps
    ?.flatMap(s => s.questions?.map(q => q.text) || []) || [];
  
  // Filtra messaggi che contengono domande della fase O risposte correlate
  return messages.filter((msg, idx) => {
    // Includi sempre gli ultimi 6 messaggi per contesto
    if (idx >= messages.length - 6) return true;
    
    // Includi se contiene domande della fase
    const msgLower = msg.content.toLowerCase();
    return phaseQuestions.some(q => 
      msgLower.includes(q.toLowerCase().substring(0, 30))
    );
  });
}

FILE 3: server/ai/gemini-live-ws-service.ts
Posizione: Riga 4160-4175

PRIMA:

const feedbackContent = `<<<SALES_MANAGER_INSTRUCTION>>>
${managerReasoning ? `\nðŸ’­ REASONING MANAGER: ${managerReasoning}` : ''}
${toneReminder ? `ðŸŽµ REMINDER TONO: ${toneReminder}` : ''}
...altri campi verbosi...
<<</SALES_MANAGER_INSTRUCTION>>>`;

DOPO:

const feedbackContent = `<<<SALES_MANAGER_INSTRUCTION>>>
${formatCompactFeedback(analysis)}
<<</SALES_MANAGER_INSTRUCTION>>>`;

NUOVA FUNZIONE DA AGGIUNGERE (sopra o in file utils):

function formatCompactFeedback(analysis: SalesManagerAnalysis): string {
  const parts: string[] = [];
  
  // 1. PERFORMANCE (forza + criticitÃ )
  const strength = getStrengthFromAnalysis(analysis);
  const weakness = getWeaknessFromAnalysis(analysis);
  if (strength) parts.push(strength);
  if (weakness) parts.push(weakness);
  
  // 2. TONO (adeguatezza + ridondanze)
  const toneNote = getToneNote(analysis.toneAnalysis);
  if (toneNote) parts.push(toneNote);
  
  // 3. ARCHETIPO
  const archetype = analysis.archetypeState?.current;
  if (archetype && archetype !== 'neutral') {
    const archetypeAction = getArchetypeAction(archetype);
    parts.push(`Prospect ${archetype}: ${archetypeAction}`);
  }
  
  // Unisci tutto in singola riga fluida
  let feedback = parts.join('. ') + '.';
  
  // Garantisci 90-110 token (approssimazione: ~0.75 parole per token)
  const words = feedback.split(' ');
  if (words.length > 80) {
    feedback = words.slice(0, 75).join(' ') + '.';
  }
  
  // Blacklist: rimuovi parole vietate
  feedback = feedback
    .replace(/\bstep\b/gi, '')
    .replace(/\bfase\b/gi, '')
    .replace(/\bcheckpoint\b/gi, '')
    .replace(/\bprossimi passi\b/gi, '')
    .replace(/\s+/g, ' ')
    .trim();
  
  return feedback;
}
function getStrengthFromAnalysis(analysis: SalesManagerAnalysis): string {
  if (analysis.buySignals?.detected) return "Segnali positivi rilevati";
  if (!analysis.toneAnalysis?.isRobotic) return "Buon rapport costruito";
  return "Conversazione fluida";
}
function getWeaknessFromAnalysis(analysis: SalesManagerAnalysis): string {
  if (analysis.feedbackForAgent?.type === 'control_loss') 
    return "riprendi controllo con domanda mirata";
  if (analysis.toneAnalysis?.consecutiveQuestions > 2) 
    return "troppe domande consecutive, aspetta risposta";
  if (analysis.checkpointStatus && !analysis.checkpointStatus.canAdvance)
    return "approfondisci prima di procedere";
  return "";
}
function getToneNote(tone: ToneAnalysis): string {
  if (!tone) return "Tono adeguato";
  if (tone.energyMismatch) return "aumenta energia";
  if (tone.lastMessageTooLong) return "risposte piÃ¹ brevi";
  return "Tono OK";
}
function getArchetypeAction(archetype: string): string {
  const actions: Record<string, string> = {
    'skeptic': 'usa prove concrete e casi studio',
    'busy': 'vai dritto al punto',
    'price_focused': 'enfatizza valore prima del prezzo',
    'enthusiast': 'guida verso closing',
    'indecisive': 'offri rassicurazioni',
    'defensive': 'costruisci fiducia gradualmente',
    'technical': 'usa dati e specifiche'
  };
  return actions[archetype] || 'adatta il tuo approccio';
}

ðŸ“Š FORMATO FEEDBACK - ESEMPI
Esempio 1: Prospect scettico
<<<SALES_MANAGER_INSTRUCTION>>>
Buon rapport costruito, riprendi controllo con domanda mirata. Tono OK, evita ripetere "interessante". Prospect skeptic: usa prove concrete e casi studio.
<<</SALES_MANAGER_INSTRUCTION>>>

(~92 token)

Esempio 2: Prospect frettoloso
<<<SALES_MANAGER_INSTRUCTION>>>
Conversazione fluida, troppe domande consecutive. Tono adeguato ma risposte piÃ¹ brevi. Prospect busy: vai dritto al punto senza giri di parole.
<<</SALES_MANAGER_INSTRUCTION>>>

(~88 token)

Esempio 3: Perdita controllo
<<<SALES_MANAGER_INSTRUCTION>>>
Segnali positivi rilevati, riprendi controllo con domanda mirata. Aumenta energia, evita ripetizioni. Prospect enthusiast: guida verso closing.
<<</SALES_MANAGER_INSTRUCTION>>>

(~90 token)

âœ… CHECKPOINT PERSISTENCE
Logica da rafforzare in sales-manager-agent.ts riga 1526-1558:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CHECKPOINT PERSISTENCE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚  ROSSO   â”‚ â”€â”€â†’ â”‚  VERDE   â”‚ â”€â”€â†’ â”‚  VERDE   â”‚               â”‚
â”‚   â”‚ (missing)â”‚     â”‚(validated)â”‚     â”‚ (LOCKED) â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                          â”‚                â”‚                     â”‚
â”‚                          â†“                â†“                     â”‚
â”‚                    Salva in DB      Skip rivalutazione          â”‚
â”‚                 completedCheckpoints[]   per sempre             â”‚
â”‚                                                                 â”‚
â”‚   ðŸ”’ REGOLA: Verde = Verde PER SEMPRE (no amnesia AI)          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ðŸ“ˆ RISULTATI ATTESI
Metrica	Prima	Dopo	Miglioramento
Latenza	5000-8000ms	1000-2000ms	-75%
Token feedback	150+	90-110	-35%
Riferimenti tecnici	Presenti	Zero	100%
Checkpoint stability	Fluttuante	Persistente	100%
Contesto analizzato	Tutti i messaggi	Solo fase	-80% dati
ðŸ”§ CHECKLIST IMPLEMENTAZIONE
 sales-manager-agent.ts: Promise.all() per parallelizzare
 sales-manager-agent.ts: TIMEOUT_MS = 3000
 sales-manager-agent.ts: Soft validation qualityScore >= 6
 step-advancement-agent.ts: maxOutputTokens = 300
 step-advancement-agent.ts: getPhaseRelevantMessages()
 gemini-live-ws-service.ts: formatCompactFeedback()
 Test latenza < 2000ms
 Test feedback 90-110 token
 Test checkpoint persistence