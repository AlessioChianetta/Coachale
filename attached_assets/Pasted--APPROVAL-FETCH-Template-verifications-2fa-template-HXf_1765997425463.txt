âœ… [APPROVAL FETCH] Template verifications_2fa_template (HXfe0b137388084a3f0a801921c06d08d9): unsubmitted
6:50:03 PM [express] GET /api/whatsapp/templates 304 in 1123ms :: {"templates":[{"sid":"HX5b5fa6e11bâ€¦
âœ… [WHATSAPP POLLING] Poll cycle complete
âœ… Updated approval status cache for Marco setter
6:50:03 PM [express] GET /api/whatsapp/custom-templates 304 in 1235ms :: {"success":true,"data":[{"iâ€¦
6:50:05 PM [express] GET /api/followup/settings 304 in 342ms :: {"hoursWithoutReply":4,"rulesCount":â€¦
6:50:05 PM [express] GET /api/auth/my-profiles 304 in 334ms :: {"profiles":[{"id":"fd732f27-d63b-4e8â€¦
6:50:05 PM [express] GET /api/followup/agents 304 in 333ms :: [{"id":"3e3aedc9-1a8f-42b1-b5ac-6a67a4â€¦
6:50:05 PM [express] GET /api/followup/activity-log 304 in 454ms :: {"timeline":[],"allEvents":[],"tâ€¦
6:50:05 PM [express] GET /api/followup/dashboard-stats 304 in 890ms :: {"awaitingFollowup":1,"sentToâ€¦
ğŸ”„ [FOLLOWUP-API] Manual trigger requested by consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ” [FOLLOWUP-SCHEDULER] Starting ALL follow-up evaluation cycle...
ğŸ§  [FOLLOWUP-SCHEDULER] AI-ONLY mode: Found 3 consultants with active WhatsApp configs
âœ… [FILTER-CHECK] Excluding closed states: 'closed_won', 'closed_lost' from candidate search
ğŸ“Š [CANDIDATE] 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c: leadNeverResponded=true, hoursSinceLastInbound=999.0h, lastInbound=NULL
ğŸ“Š [FOLLOWUP-SCHEDULER] Found 1 ALL candidate conversations
ğŸ” [FOLLOWUP-SCHEDULER] Evaluating conversation 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c
   State: new, Days silent: 0, Hours silent: 0.2, Follow-ups: 0/5
   ğŸ“‹ Applicable rules: 0 (Sistema AI attivo - le regole sono opzionali)
ğŸ¤– [FOLLOWUP-SCHEDULER] Nessuna regola esplicita - Sistema AI "Marco" attivo per 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c
ğŸ§‘â€ğŸ’¼ [FOLLOWUP-ENGINE] Human-Like AI evaluation for conversation 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c
   State: new, Days silent: 0, Follow-ups: 0/5
   Mode: AI-ONLY (no hardcoded rules)
ğŸ“œ [FOLLOWUP-ENGINE] Found 0 previous evaluations for context
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
ğŸš€ [FOLLOWUP-ENGINE] Using Vertex AI (SuperAdmin) for evaluation
6:50:16 PM [express] POST /api/activity/session/heartbeat 200 in 335ms :: {"success":true,"lastActivâ€¦
âœ… [FOLLOWUP-ENGINE] Decision: schedule (confidence: 1)
   Reasoning: Ãˆ passato troppo poco tempo, solo 9 minuti, dall'invio del primo messaggio al lead. Non ha ancora avuto il tempo materiale di leggerlo e rispondere. Non ha senso inviare un altro messaggio cosÃ¬ presto. Seguendo le buone pratiche di vendita e rispettando i tempi del lead, attenderÃ² almeno 24 ore. Se non ci sarÃ  risposta entro domani, programmerÃ² un follow-up con un template approvato, dato che saremo fuori dalla finestra delle 24 ore di WhatsApp.
   Latency: 12610ms
ğŸ“ [FOLLOWUP-ENGINE] Logging decision for conversation 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c
âœ… [FOLLOWUP-ENGINE] Decision logged successfully
ğŸ” [TEMPLATE-TRACE] â•â•â• CHIAMATA 2: AI decision â•â•â•
ğŸ” [TEMPLATE-TRACE] candidate.agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-TRACE] candidate.conversationId: 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c
ğŸ” [TEMPLATE-TRACE] candidate.leadName: undefined
ğŸ” [TEMPLATE-TRACE] decision.decision: schedule
âš ï¸ [FOLLOWUP-SCHEDULER] Lead mai risposto - finestra 24h non ancora aperta, richiesto template approvato
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” [TEMPLATE-DEBUG] Cercando template per agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-DEBUG] Conversation: 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c
ğŸ” [TEMPLATE-DEBUG] Template TROVATI dalla query (tutti): 2
ğŸ” [TEMPLATE-DEBUG]   1. templateId: HX922112cd9b1d531c5be56772acd50034, type: twilio, priority: 2
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG]   2. templateId: HX5e6d27c6d82026f3620247262ef67340, type: twilio, priority: 1
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG] Template DOPO filtro (HX + twilio): 2
ğŸ” [TEMPLATE-DEBUG]   1. HX922112cd9b1d531c5be56772acd50034 (priority: 2)
ğŸ” [TEMPLATE-DEBUG]   2. HX5e6d27c6d82026f3620247262ef67340 (priority: 1)
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… [FOLLOWUP-SCHEDULER] Template Twilio approvato SELEZIONATO: HX922112cd9b1d531c5be56772acd50034 (priority: 2, type: twilio)
ğŸ”’ [FOLLOWUP-SCHEDULER] Outside 24h window - using pre-validated template: HX922112cd9b1d531c5be56772acd50034
ğŸ“‹ [TEMPLATE-FINAL] Conversation 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c:
   leadNeverResponded: true
   allowFreeformMessage: false
   templateIdToUse: HX922112cd9b1d531c5be56772acd50034
   fallbackMessageToUse: NULL
âŒ [FOLLOWUP-SCHEDULER] Error evaluating conversation 68a51f7c-6c7f-4e7a-b43c-5aeed7926b6c: error: insert or update on table "scheduled_followup_messages" violates foreign key constraint "scheduled_followup_messages_template_id_fkey"
    at /home/runner/workspace/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async evaluateConversation (/home/runner/workspace/server/cron/followup-scheduler.ts:1468:5)
    at async runFollowupEvaluation (/home/runner/workspace/server/cron/followup-scheduler.ts:390:24)
    at async <anonymous> (/home/runner/workspace/server/routes/followup-api.ts:1698:5) {
  length: 395,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (template_id)=(HX922112cd9b1d531c5be56772acd50034) is not present in table "whatsapp_custom_templates".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'scheduled_followup_messages',
  column: undefined,
  dataType: undefined,
  constraint: 'scheduled_followup_messages_template_id_fkey',
  file: 'ri_triggers.c',
  line: '2599',
  routine: 'ri_ReportViolation'
}
[FOLLOWUP-SCHEDULER] Evaluation Cycle cycle_1765997407548_bzodsi: 14.525s
ğŸ“ˆ [FOLLOWUP-SCHEDULER] ALL evaluation cycle completed
   â±ï¸  Duration: 14525ms
   ğŸ“Š Processed: 0/1
   ğŸŒ¡ï¸  Temperature updates: 0
   ğŸ“… Scheduled: 0
   â­ï¸  Skipped: 0
   ğŸ›‘ Stopped: 0
   âŒ Errors: 1
ğŸ“Š [FOLLOWUP-SCHEDULER] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š [FOLLOWUP-SCHEDULER] Cycle Metrics Report
ğŸ“Š [FOLLOWUP-SCHEDULER] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š [FOLLOWUP-SCHEDULER] Timestamp: 2025-12-17T18:50:22.074Z
ğŸ“Š [FOLLOWUP-SCHEDULER] Cycle ID: cycle_1765997407548_bzodsi
ğŸ“Š [FOLLOWUP-SCHEDULER] Type: evaluation_all
ğŸ“Š [FOLLOWUP-SCHEDULER] Duration: 14525ms
ğŸ“Š [FOLLOWUP-SCHEDULER] Processed: 1
ğŸ“Š [FOLLOWUP-SCHEDULER] Success: 0
ğŸ“Š [FOLLOWUP-SCHEDULER] Errors: 1
ğŸ“Š [FOLLOWUP-SCHEDULER] Skipped: 0
ğŸ“Š [FOLLOWUP-SCHEDULER] Rate Limited: 0
ğŸ“Š [FOLLOWUP-SCHEDULER] Error Rate: 100.0%
ğŸ“Š [FOLLOWUP-SCHEDULER] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[FOLLOWUP-SCHEDULER] ALERT: Error rate exceeded 10% (100.0%)