

1. DATABASE SCHEMA
Tabelle principali:
email_accounts - Account email collegati

Campo	Tipo	Descrizione
id	serial PK	ID univoco
consultant_id	FK→users	Proprietario
provider	enum	gmail, microsoft, imap
display_name	varchar	Nome visualizzato
primary_email	varchar	Email principale
auth_type	enum	oauth, password
oauth_refresh_token	text (encrypted)	Token refresh OAuth
oauth_access_token	text (encrypted)	Token accesso
oauth_expires_at	timestamp	Scadenza token
imap_host/port/tls	per IMAP generico	
smtp_host/port/tls/user/password	per invio	
auto_reply_mode	enum	manual, review, auto
confidence_threshold	real	Soglia fiducia AI (0.0-1.0)
polling_interval_minutes	integer	Frequenza sync
last_sync_at	timestamp	Ultima sincronizzazione
emails - Email ricevute/inviate

Campo	Tipo	Descrizione
id	serial PK	ID univoco
account_id	FK→email_accounts	Account di appartenenza
consultant_id	FK→users	Consulente
client_id	FK→users nullable	Cliente associato
message_id	varchar unique	ID univoco messaggio
thread_id	varchar	ID thread conversazione
subject	text	Oggetto
from_name/from_email	varchar	Mittente
to_recipients	jsonb	Destinatari
body_html/body_text	text	Contenuto
attachments	jsonb	Allegati
direction	enum	inbound, outbound
ai_classification	jsonb	Classificazione AI
ai_confidence	real	Confidenza classificazione
processing_status	enum	new, pending_ai, ai_draft_ready, awaiting_review, sent, archived, escalated
received_at/sent_at	timestamp	Date
email_ai_responses - Risposte generate dall'AI

Campo	Tipo	Descrizione
id	serial PK	ID univoco
email_id	FK→emails	Email di riferimento
draft_body_html/text	text	Bozza risposta
reasoning	jsonb	Ragionamento AI
status	enum	draft, awaiting_review, approved_sent, rejected, auto_sent
generated_by	enum	ai, human
sent_at	timestamp nullable	Data invio
email_rules - Regole automazione

Campo	Tipo	Descrizione
id	serial PK	ID univoco
consultant_id	FK→users	Proprietario
name	varchar	Nome regola
trigger	enum	intent, keyword, sender, time
conditions	jsonb	Condizioni
action	enum	auto_reply, set_folder, escalate
is_active	boolean	Attiva/disattiva
2. BACKEND API
Account Management
POST   /api/email-hub/accounts              → Crea account
GET    /api/email-hub/accounts              → Lista account
PATCH  /api/email-hub/accounts/:id          → Modifica account
DELETE /api/email-hub/accounts/:id          → Elimina account
OAuth Flow
GET    /api/email-hub/oauth/google/start    → Avvia OAuth Google
GET    /api/email-hub/oauth/google/callback → Callback OAuth
GET    /api/email-hub/oauth/microsoft/start → Avvia OAuth Microsoft
GET    /api/email-hub/oauth/microsoft/callback
POST   /api/email-hub/accounts/:id/imap-test → Test IMAP
Email Operations
GET    /api/email-hub/inbox                 → Lista email (paginated)
GET    /api/email-hub/emails/:id            → Dettaglio email
POST   /api/email-hub/emails/:id/ai-draft   → Rigenera bozza AI
POST   /api/email-hub/emails/:id/approve    → Approva e invia
POST   /api/email-hub/emails/:id/reject     → Rifiuta bozza
POST   /api/email-hub/emails/:id/escalate   → Escalation manuale
Sync & Rules
POST   /api/email-hub/accounts/:id/sync     → Trigger sync manuale
GET    /api/email-hub/rules                 → Lista regole
POST   /api/email-hub/rules                 → Crea regola
PATCH  /api/email-hub/rules/:id             → Modifica regola
DELETE /api/email-hub/rules/:id             → Elimina regola
3. FRONTEND - /consultant/email-hub
Layout
┌─────────────────────────────────────────────────────────────┐
│  Header: Email Hub - Centro Gestione Email                  │
├──────────┬──────────────────────────────────────────────────┤
│ Sidebar  │  Main Content                                    │
│          │  ┌─────────────────────────────────────────────┐ │
│ • Account│  │ Inbox List (filtri, ricerca, ordinamento)   │ │
│   Gmail  │  │ ┌───────────────────────────────────────┐   │ │
│   Outlook│  │ │ Email 1 - Subject - Da: Mario - 10:30│   │ │
│   IMAP   │  │ │ Email 2 - Subject - Da: Lucia - 09:15│   │ │
│          │  │ └───────────────────────────────────────┘   │ │
│ • Regole │  ├─────────────────────────────────────────────┤ │
│ • Stats  │  │ Email Detail + AI Response Panel            │ │
│          │  │ [Originale] [Risposta AI] [Timeline]        │ │
│          │  │ ┌─────────────────────────────────────────┐ │ │
│          │  │ │ Bozza AI: "Gentile Mario, grazie..."    │ │ │
│          │  │ │ Confidenza: 92%                         │ │ │
│          │  │ │ [Approva] [Modifica] [Rifiuta]          │ │ │
│          │  │ └─────────────────────────────────────────┘ │ │
└──────────┴──────────────────────────────────────────────────┘
Componenti React
EmailHubPage - Pagina principale
AccountSidebar - Lista account + stato sync
AccountWizard - Modal per collegare nuovo account
InboxList - Lista email con filtri
EmailDetail - Dettaglio email selezionata
AIResponsePanel - Bozza AI con azioni
RulesEditor - Gestione regole automazione
SyncStatus - Indicatore sincronizzazione
4. AI WORKFLOW
┌──────────────┐     ┌───────────────┐     ┌─────────────────┐
│ Email Ricevuta │ ─→ │ Classificazione │ ─→ │ Valuta Regole   │
└──────────────┘     │   (Gemini)      │     └─────────────────┘
                     │ • intent        │              │
                     │ • urgenza       │              ▼
                     │ • sentiment     │     ┌─────────────────┐
                     └───────────────┘     │ Modalità Auto?   │
                                           └─────────────────┘
                                                  │
                          ┌───────────────────────┼───────────────────────┐
                          ▼                       ▼                       ▼
                   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
                   │ auto_reply  │         │   review    │         │   manual    │
                   │ Confidenza  │         │ Bozza AI    │         │ Solo notify │
                   │ >= soglia   │         │ per approva │         │ consulente  │
                   └─────────────┘         └─────────────┘         └─────────────┘
                          │                       │
                          ▼                       ▼
                   ┌─────────────┐         ┌─────────────┐
                   │ Genera +    │         │ Genera      │
                   │ Invia auto  │         │ Bozza       │
                   └─────────────┘         └─────────────┘
Context per Gemini
Profilo consulente (tono, firma, stile)
Storico cliente (email precedenti, goals, note)
Knowledge base (documenti caricati)
Regole custom del consulente
5. INTEGRATIONS
Provider	Metodo	Auth	Sync
Gmail	Gmail API	OAuth 2.0	Push (webhook) + Pull
Microsoft 365	Graph API	OAuth 2.0	Delta queries
IMAP generico	node-imap	Password	Polling (IDLE)
Token Refresh
Job cron ogni 5 minuti
Controlla oauth_expires_at
Refresh automatico prima scadenza
6. SECURITY
Crittografia: Tutte le credenziali cifrate con salt per-consulente
OAuth scopes minimi: solo mail.read, mail.send
Multi-tenant isolation: filtro consultant_id su tutte le query
Audit log: log di tutte le email inviate dall'AI
Rate limiting: max 10 draft AI/minuto, max 50 email/ora