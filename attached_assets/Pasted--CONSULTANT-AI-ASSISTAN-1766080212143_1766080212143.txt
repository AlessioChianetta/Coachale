======================================================================
ğŸ§‘â€ğŸ’¼ CONSULTANT AI ASSISTANT - New Chat Message
======================================================================
Consultant ID: 0c73bbe5-51e1-4108-866b-6be7a52fce3b
Message: ciao
======================================================================

ğŸ” [FileSearch] getStoreNamesForGeneration - Role: consultant, UserId: 0c73bbe5-51e1-4108-866b-6be7a52fce3b, ConsultantId: N/A
   ğŸ“¦ Found 0 stores: nessuno
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
ğŸ” [Intent Detection] Detected intent from message: general
ğŸ”‘ [Cache Key] Using cache key: 0c73bbe5-51e1-4108-866b-6be7a52fce3b-general
ğŸ”„ Building fresh consultant context (intent: general)
ğŸ” [DEBUG] Query flags: {
  shouldLoadClients: true,
  shouldLoadExercises: true,
  shouldLoadClientData: true,
  shouldLoadEmail: true,
  shouldLoadWhatsApp: true,
  shouldLoadCalendar: true,
  shouldLoadConsultations: true,
  shouldLoadEmailDetailed: false,
  shouldLoadWhatsAppDetailed: true,
  shouldLoadAIAgents: false,
  shouldLoadLeads: true,
  shouldLoadCampaigns: true,
  shouldLoadApiSettings: true,
  shouldLoadWhatsAppConfig: true
}
ğŸ” [Q1] Fetching consultant info...
ğŸ” [Q2] Fetching all clients...
ğŸ” [Q3] Fetching pending exercise reviews...
ğŸ” [Q4] Fetching recently created exercises...
ğŸ” [Q5] Fetching exercise stats...
ğŸ” [Q6] Fetching email drafts...
ğŸ” [Q7] Fetching scheduler logs...
ğŸ” [Q8] Fetching WhatsApp leads...
ğŸ” [Q9] Fetching WhatsApp conversations...
ğŸ” [Q10] Fetching upcoming appointments...
ğŸ” [Q11] Fetching today appointments...
ğŸ” [Q12] Fetching all consultations...
ğŸ” [Q13] Fetching consultation tasks...
ğŸ” [Q13a] Fetching client goals...
ğŸ” [Q13b] Fetching client state tracking data (latest per client)...
ğŸ” [Q14] Fetching SMTP settings...
ğŸ” [Q15] Fetching email journey templates...
ğŸ” [Q16] Fetching WhatsApp custom templates...
ğŸ” [Q17] Fetching library documents...
ğŸ” [Q18] Fetching exercise feedback...
ğŸ” [Q19] Fetching university year assignments with detailed structure...
ğŸ” [Q20] Fetching exercise templates...
ğŸ” [Q21] Fetching university templates...
ğŸ” [Q27] Fetching detailed WhatsApp conversations...
ğŸ” [Q28] Fetching recent WhatsApp messages...
ğŸ” [Q29] Fetching WhatsApp agent configs...
ğŸ” [Q40] Fetching proactive leads...
ğŸ” [Q41] Fetching lead stats by status...
ğŸ” [Q42] Fetching lead stats by category...
ğŸ” [Q43] Fetching lead stats by campaign...
ğŸ” [Q44] Fetching marketing campaigns with agent names...
ğŸ” [Q44] Building query with leftJoin...
ğŸ” [Q45] Fetching campaign analytics (last 30 days)...
ğŸ” [Q46] Fetching external API configs...
ğŸ” [Q46] Building query with leftJoin...
ğŸ” [Q47] Fetching external lead import logs (last 30 days)...
ğŸ” [Q48] Fetching WhatsApp/Twilio configuration (FULL)...
ğŸ” [Q49] Fetching WhatsApp custom templates with versions...
ğŸ” [Q50] Fetching WhatsApp template assignments...
ğŸ” [Q51] Fetching Twilio WhatsApp templates from Content API...
ğŸ” [Q52] Fetching calendar settings...
âœ… [Q1] Consultant info fetched
âœ… [Q2] All clients fetched: 20
âœ… [Q3] Pending exercise reviews fetched: 19
âœ… [Q21] University templates fetched: 4
âœ… [Q27] Detailed WhatsApp conversations fetched: 4
âœ… [Q20] Exercise templates fetched: 84
âœ… [Q29] WhatsApp agent configs fetched: 3
âœ… [Q28] Recent WhatsApp messages fetched: 75
âœ… [Q40] Proactive leads fetched: 4
âœ… [Q41] Lead stats by status fetched: 2 statuses
âœ… [Q19] University year assignments raw data fetched: 1097 rows
âœ… [Q4] Recently created exercises fetched: 50
âœ… [Q8] WhatsApp leads fetched: 4
âœ… [Q5] Exercise stats fetched
âœ… [Q42] Lead stats by category fetched: 1 categories
âœ… [Q9] WhatsApp conversations fetched: 4
âœ… [Q11] Today appointments fetched: 0
âœ… [Q10] Upcoming appointments fetched: 0
âœ… [Q43] Lead stats by campaign fetched: 1 campaigns
âœ… [Q13a] Client goals fetched: 0
âœ… [Q13] Consultation tasks fetched: 1
âœ… [Q14] SMTP settings fetched: 1
âœ… [Q15] Email journey templates fetched: 31
âœ… [Q16] WhatsApp custom templates fetched: 50
âœ… [Q18] Exercise feedback fetched: 10
âœ… [Q17] Library documents fetched: 20
âœ… [Q44] Marketing campaigns fetched: 2
âœ… [Q46] External API configs fetched: 1
âœ… [Q45] Campaign analytics fetched: 0 records
âœ… [Q47] External lead import logs fetched: 1
âœ… [Q48] WhatsApp/Twilio configuration (FULL) fetched: 1 record(s)
âœ… [Q7] Scheduler logs fetched: 1
âœ… [Q50] WhatsApp template assignments fetched: 0
âœ… [Q52] Calendar settings fetched: Found
âœ… [Q13b] Client state tracking fetched (unique clients): 23
âœ… [Q49] WhatsApp custom templates fetched: 104
âœ… [Q6] Email drafts fetched: 749
âœ… [Q12] All consultations fetched: 30
âœ… [Q51] Twilio WhatsApp templates fetched: 10 from 3 agent(s)
ğŸ“§ [EMAIL MAPPING] Created email mapping for 54 consultations
ğŸ” [WhatsApp Config] Populated with masked credentials (Account SID: NULL, Auth Token: NULL)
ğŸ“š [Knowledge Base] Loading ALL knowledge content for consultant (no filtering)...
ğŸ“š [Knowledge Base] Loaded 1 documents and 0 APIs for consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b
âœ… [Knowledge Base] Loaded ALL content: 1 documents, 0 API sources

ğŸ“Š Token Usage Breakdown (Intent: general):
   Dashboard: 26 tokens
   Clients (20 clients): 1,635 tokens
   Exercises: 3,403 tokens
   Email Marketing: 579 tokens
   WhatsApp Leads: 319 tokens
   Calendar: 149 tokens
   Consultations: 35,903 tokens
   Consultation Tasks: 18 tokens
   Client Goals: 19 tokens
   Client States (23 states): 7,904 tokens
   SMTP Configuration: 0 tokens
   Email Templates: 0 tokens
   WhatsApp Templates: 0 tokens
   Library Documents: 0 tokens
   Exercise Feedback: 2,795 tokens
   University: 42,478 tokens
   Exercise Templates: 13,460 tokens
   ğŸ’¬ WhatsApp (Detailed): 3,464 tokens
   ğŸ¯ Lead Management: 1,207 tokens
   ğŸ“Š Campaign Marketing: 446 tokens
   ğŸ”Œ API Settings: 290 tokens
   ğŸ“± WhatsApp Config: 531 tokens
   ğŸ“ WhatsApp Templates (Detailed): 11,501 tokens
   ğŸ”— WhatsApp Template Assignments: 1 tokens
   ğŸ“² Twilio WhatsApp Templates: 1,667 tokens
   ğŸ“… Calendar Settings: 304 tokens
   ğŸ“š Knowledge Base: 2,191 tokens
   Base (prompts + metadata): 5,052 tokens
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ğŸ¯ TOTAL ESTIMATED: 135,342 tokens

âœ… Built and cached consultant context (intent: general)
â±ï¸  [TIMING] Consultant context building: 2086ms
â±ï¸  [TIMING] Consultant prompt building: 15ms

ğŸ“Š Token Usage Estimation:
  - System Prompt: ~60,940 tokens
  - User Message: ~1 tokens
  - Conversation History: ~0 tokens
  - Total Estimated: ~60,941 tokens


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AI MODE: RAG CLASSICO (Context Injection) [CONSULTANT]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ Stores FileSearch: NESSUNO
   âŒ Tool fileSearch: NON ATTIVO
   ğŸ“„ Tutto il contesto viene iniettato nel system prompt (~60,940 tokens)
   ğŸ’¡ TIP: Vai su AI Settings > File Search per sincronizzare i documenti!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”„ AI stream attempt 1/6...
ğŸ”„ [WHATSAPP POLLING] Starting poll cycle...
ğŸ“Š [WHATSAPP POLLING] Polling 7 consultant(s) sequentially...
âš ï¸ [WHATSAPP POLLING] Skipping consultant 611b2437-3b3f-4063-ad89-2164943abf1d - incomplete config
âœ… AI streaming completed successfully on attempt 1
â±ï¸  [TIMING] Gemini API call (with streaming): 1944ms
âš ï¸ [WHATSAPP POLLING] Skipping consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b - incomplete config
âœ… Consultant AI streaming completed for message ca22acd6-9378-4cb5-b5a8-44088664c334

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“š RAG CLASSICO STREAMING SUMMARY [CONSULTANT]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   âŒ File Search: NON ATTIVO
   ğŸ“„ La risposta Ã¨ basata interamente sul context injection
      (~60,940 tokens nel system prompt)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸  PERFORMANCE TIMING BREAKDOWN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   [0ms â†’ 2086ms] Context Building (2086ms)
   [2086ms â†’ 2101ms] Prompt Building (15ms)
   [2101ms â†’ 5954ms] Gemini API Call (1944ms)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â±ï¸  TOTAL: 5.95s (5954ms)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

5:45:31 PM [express] POST /api/consultant/ai/chat 200 in 6179ms