
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”‘ [STEP 3] Selecting AI Provider (Vertex AI / Google AI Studio)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ†” Conversation ID: d5dce693-1828-4f53-ada4-6f5b62b542bd
ğŸ‘¤ User Type: CLIENT
âœ… Using SuperAdmin Google AI Studio for WhatsApp (Gemini 3)
   ğŸ”‘ Key: 1/1
âœ… Selected AI Provider: studio
   ğŸ” API Key: AIzaSyAzZA...CL20
   ğŸ†” Key ID: superadm...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”‘ [API KEY] Extracted from Google AI Studio provider (key: superadm...)
ğŸ’¾ [STEP 4] Saving 1 inbound message(s) to database
âœ… [STEP 4] Saved inbound message b4e7f50b-df34-422d-94ed-5ca829a0b5d9: "Ciao..."
ğŸ”„ [STEP 4b] Updated conversation lastMessageAt and unreadByConsultant (+1)
ğŸ’¬ [AUDIO DETECTION] Client sent text message - No audio TTS needed unless always_audio mode
ğŸ”„ [NEXT-EVAL] Reset nextEvaluationAt for conversation d5dce693-1828-4f53-ada4-6f5b62b542bd (new inbound message)
ğŸ“¸ [STEP 5] Building media context (1 messages)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– [STEP 6] Building AI System Prompt
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ Participant Type: CLIENT
ğŸ’¬ Message: "Ciao"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ‘¤ CLIENTE â†’ FLUSSO LEAD (agente non-support)                 â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ“ Telefono:           +393519272875
â•‘  ğŸ¤– Agente:             Marco setter (proactive_setter)
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  âš¡ DECISIONE
â•‘  â”œâ”€ Tipo utente:        CLIENTE RICONOSCIUTO (agente non-support)
â•‘  â”œâ”€ Accesso CRM:        NO (CRM solo per agente default "Assistenza Clienti")
â•‘  â””â”€ Flusso:             Reindirizzato â†’ Lead (senza dati CRM)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ” Detecting intent for lead message...
âœ… Intent detected: general
â­ï¸ [OBJECTION] Objection detection DISABLED (aligned with public share)
ğŸ‘¤ Fetching/creating lead profile...
âœ… Lead profile: difficult (difficulty: 8.5/10)
â­ï¸ [APPOINTMENT SLOTS] Slots fetch DISABLED (bookingEnabled=false)
ğŸ” [PROACTIVE CHECK] conversation.isProactiveLead=false, conversation.proactiveLeadId=null
â„¹ï¸ [PROACTIVE CHECK] This is a REACTIVE lead (isProactiveLead=false)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [TEMPLATE ENGINE] Checking agent instructions...
   agentInstructionsEnabled: true
   agentInstructions length: 14957 chars
   selectedTemplate: receptionist
âœ… [TEMPLATE ENGINE] Using CUSTOM TEMPLATE from database
   Template preview: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ RUOLO: RECEPTIONIST VIRTUALE (INBOUND)
â”â”â”â”â”â”...
   - Sender Phone Injected: +393519272875
âœ… [FEATURE BLOCKS] Conditional injection summary:
   - Knowledge Base: DISABLED (no items)
   - Booking: ENABLED
   - Objection Handling: DISABLED (removed Dec 2025)
   - Disqualification: ENABLED
   - Upselling: DISABLED (no block yet)
   - Sender Phone: INJECTED
ğŸ“¤ [SYSTEM PROMPT] Ready (35172 chars): "ğŸ“… OGGI Ãˆ: domenica 22 febbraio 2026  Sei l'assistente di Orbitale. Il cliente Ã¨ un LEAD CALDO che h..."

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¯ LEAD - MAPPA DECISIONALE                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ“ Telefono:           +393519272875
â•‘  ğŸ¤– Agente:             Marco setter
â•‘  ğŸ‘¤ Profilo:            difficult (difficoltÃ : 8.5/10)
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  âš¡ DECISIONE
â•‘  â”œâ”€ Tipo utente:        LEAD (potenziale cliente)
â•‘  â”œâ”€ Prompt:             buildLeadSystemPrompt (vendita)
â•‘  â”œâ”€ Accesso CRM:        NO
â•‘  â”œâ”€ Booking attivo:     SI
â•‘  â”œâ”€ Proattivo:          NO
â•‘  â””â”€ Flusso:             Lead â†’ vendita + prenotazione
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“š [STEP 7] Checking for reset request and fetching message history
ğŸ“š [STEP 7] Found 10 historical messages
ğŸ§  [STEP 8] Calling Gemini AI (model selection based on provider)

ğŸ“Š [GEMINI TOKENS] Stima PRIMA della chiamata:
   ğŸ“ System Prompt: ~8,793 tokens (35,172 chars)
   ğŸ’¬ User Message: ~1 tokens (4 chars)
   ğŸ“œ History: ~818 tokens (3,269 chars)
   ğŸ”¢ TOTALE INPUT: ~9,612 tokens

[IMAP] Opened folder "INBOX.Sent": server reports 2 total messages
[IMAP] Finished parsing 2 emails from "INBOX.Sent"
[EMAIL-HUB AUTO] Fetched 2 emails from INBOX.Sent (sent)
ğŸ‘¤ [FILE SEARCH] User Alessio Chianetta is a CLIENT - enabling consultant store access
ğŸ” [FILE SEARCH] Access check - Agent level: null, Client Gold: true, Source: client
ğŸ“š [DIPENDENTE FILE SEARCH] Merged dipendente store "WhatsApp Agent: Marco setter" (1 docs) into client search
âœ… [FileSearch] Store name valid: fileSearchStores/private-store-client-e9c377-0qubcpy51a0r
âœ… [FileSearch] Store name valid: fileSearchStores/whatsapp-agent-marco-setter-o2sz4beuox1z
ğŸ‘‘ [FILE SEARCH] Gold client using semantic search (like AI Assistant)
   ğŸ“¦ Stores: 2
      1. fileSearchStores/private-store-client-e9c377-0qubcpy51a0r
      2. fileSearchStores/whatsapp-agent-marco-setter-o2sz4beuox1z
   ğŸ“„ Total documents: 30
   ğŸ“Š Private Store - Client e9c37790: 29 docs
   ğŸ“Š Dipendente: Marco setter: 1 docs
ğŸ”„ [RETRY] Attempt 1/3
   ğŸ§  [AI] Google AI Studio - Using model: gemini-3-flash-preview, thinking: enabled (low)
[IMAP] Opened folder "INBOX.Drafts": server reports 0 total messages
[EMAIL-HUB AUTO] Fetched 0 emails from INBOX.Drafts (drafts)
ğŸ“Š [TokenTracker] Buffered: whatsapp-agent:marco-setter | gemini-3-flash-preview | 10954 tokens | $0.0057 | consultant=0c73bbe5-51e1-4108-866b-6be7a52fce3b client=self
âœ… [RETRY] Success on attempt 1!
â±ï¸  [TIMING] Gemini API call: 1955ms

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [DEBUG] Analyzing Gemini Response Object
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ Response object keys: [
  'sdkHttpResponse',
  'candidates',
  'modelVersion',
  'responseId',
  'usageMetadata'
]
âœ… response.text is a property - using it...
ğŸ“ Extracted text length: 335
ğŸ“ Extracted text preview: Ciao! ğŸ‘‹ Piacere di conoscerti, sono l'assistente di Orbitale. 

Aiutiamo imprenditori, liberi professionisti e dipendenti a creare, gestire e proteggere il proprio denaro attraverso un metodo scienti
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”


ğŸ“Š [WHATSAPP AI] Token Breakdown for agent "Marco setter":
   â”œâ”€â”€ System Prompt: 8,793 tokens
   â”œâ”€â”€ Conversation History: 957 tokens
   â”œâ”€â”€ User Message: 1 tokens
   â””â”€â”€ TOTAL INPUT: 9,751 tokens

ğŸ“Š [GEMINI TOKENS] Utilizzo DOPO la risposta:
   âœ… Response: ~84 tokens (335 chars)
   ğŸ”¢ TOTALE (input + output): ~9,696 tokens
   â±ï¸  Tempo di risposta: 1955ms
   ğŸ’° Costo stimato: $0.019392 (input + output)

âœ… [STEP 8] Gemini response received: "Ciao! ğŸ‘‹ Piacere di conoscerti, sono l'assistente di Orbitale. 

Aiutiamo imprenditori, liberi profe..."
ğŸ’¾ [STEP 9] Saving AI response to database
âœ… [STEP 9] AI response saved with ID: 670f440f-45e9-4448-8575-373acb391b11 (timing: 1955ms Gemini, 4698ms total)
ğŸ”„ [STEP 9b] Updated conversation lastMessageAt (AI response)
ğŸ›ï¸ [AUDIO DECISION] Mode: always_text, ClientSentAudio: false â†’ sendAudio=false, sendText=true

ğŸ“ [TTS SKIP] TTS disabled or not needed (ttsEnabled=false, mode=always_text, clientAudio=false)

ğŸ“¤ [STEP 10] Sending WhatsApp message to +393519272875
[IMAP] Opened folder "INBOX.Trash": server reports 6 total messages
âœ… Using agent from existing conversation: Marco setter (760bb513-098f-4722-b02a-a700160c2fc3)
ğŸ“± Using From number: whatsapp:+3935002201290 (Agent: Marco setter)
ğŸ“¤ Sending WhatsApp message as plain text
âœ… [TokenTracker] Flushed 1 entries to DB
[IMAP] Finished parsing 6 emails from "INBOX.Trash"
[EMAIL-HUB AUTO] Fetched 6 emails from INBOX.Trash (trash)
âŒ [ERROR] Error processing pending messages:
Error message: Twilio could not find a Channel with the specified From address
Error stack: Error: Twilio could not find a Channel with the specified From address
    at success (/home/runner/workspace/node_modules/twilio/lib/base/Version.js:79:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async sendWhatsAppMessage (/home/runner/workspace/server/whatsapp/twilio-client.ts:538:21)
    at async processPendingMessages (/home/runner/workspace/server/whatsapp/message-processor.ts:2874:5)
    at async processPendingMessagesWithRetry (/home/runner/workspace/server/whatsapp/message-processor.ts:517:5)
    at async processConsultantQueue (/home/runner/workspace/server/whatsapp/message-processor.ts:496:9)
    at async enqueueProcessing (/home/runner/workspace/server/whatsapp/message-processor.ts:472:5)
    at async Timeout._onTimeout (/home/runner/workspace/server/whatsapp/message-processor.ts:449:5)
ğŸ›Ÿ [ERROR RECOVERY] Saving 1 inbound messages and marking as processed to prevent infinite loop
âœ… [ERROR RECOVERY] Marked 1 messages as processed with error info
â„¹ï¸ [ERROR RECOVERY] Messages are saved in DB. AI response failed but conversation history is preserved.
âš ï¸ [ERROR] Processing failed but messages saved. Conversation can continue manually.
[EMAIL-HUB AUTO] Initial sync complete: 0 emails imported
[IMAP] Opened folder "[Gmail]/Posta inviata