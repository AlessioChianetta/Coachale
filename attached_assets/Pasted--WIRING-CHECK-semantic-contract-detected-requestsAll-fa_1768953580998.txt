[WIRING-CHECK] semantic contract detected - requestsAll=false, requestsTopN=false, keywords=[]
[WIRING-CHECK] extractFiltersFromQuestion called - found 0 filters: {}
[GROUPBY-VALIDATION] Extracted searchTerm="pizza", categoryFilter="Food"
[GROUPBY-VALIDATION] Detected patterns: Quali pizze
[GROUPBY-VALIDATION] isProductListing=true, isCategoryComparison=false
[GROUPBY-VALIDATION] productColumn=product_name, categoryColumn=category, quantityColumn=quantity
[GROUPBY-VALIDATION] searchTerm=pizza, categoryFilter=Food
[WIRING-CHECK] groupByIntent - isProductListing=true, productColumn=product_name
[INTENT-ROUTER] Classifying question: "Quali pizze sono pi√π profittevoli?"
[INTENT-ROUTER] Conversation context: 2 messages
üîç Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ [SuperAdmin Gemini] Loaded 1 API keys from config
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[INTENT-ROUTER] Using provider: Google AI Studio
[INTENT-ROUTER] Raw response (1149ms): ```json
{
  "intent": "analytics",
  "requires_metrics": true,
  "suggested_tools": [
    "aggregate_group"
  ],
  "confidence": 0.99
}
```
[INTENT-ROUTER] Classification result: intent=analytics, requires_metrics=true, confidence=0.99, tools=[aggregate_group]
[QUERY-PLANNER] Router result: intent=analytics, requires_metrics=true, confidence=0.99
[POLICY-ENGINE] Getting policy for intent: analytics
[QUERY-PLANNER] Policy: allowedTools=[execute_metric,aggregate_group,compare_periods,filter_data,get_schema], requireToolCall=true
[CATEGORY-DETECT] Found category term "pizze" ‚Üí categoryValue="Pizza"
[QUERY-PLANNER] CATEGORY TERM DETECTED: term="pizze", value="Pizza"
[SEMANTIC-ORDERBY] Detected "profittevol" ‚Üí metric="gross_margin", direction=DESC
[QUERY-PLANNER] SEMANTIC ORDERBY DETECTED: metric="gross_margin", direction=DESC
üîç Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[QUERY-PLANNER] Conversation context for planner: 2 messages
[QUERY-PLANNER] Allowed tools for AI: [execute_metric, query_metric, compare_periods, filter_data, aggregate_group, get_schema]
[QUERY-PLANNER] Using Router Agent classification (legacy classifier disabled)
[SHEETS POLLING] Completed import for job ca427ee2-05d4-4614-b7bf-c10af25d5953: 0 imported, 48 duplicates, 0 skipped, 0 errors
[SHEETS POLLING] Polling cycle completed (ExecID: 776m1)
there are non-text parts functionCall in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.
[QUERY-PLANNER] Plan: 1 steps, complexity: simple
[POLICY-ENGINE] Enforcing policy for intent: analytics, tool calls: 1
[POLICY-ENGINE] ALLOWED: aggregate_group
[POLICY-ENGINE] Result: allowed=1, blocked=0, violations=0
[POLICY-ENGINE] Tool analysis: hasComputeTool=true, hasOnlyMetadata=false
[POLICY-ENGINE] VALIDATION OK: compute tool present
[GROUPBY-CORRECTION] Correcting groupBy for product listing
[GROUPBY-CORRECTION] Original: ["category"] ‚Üí [product_name]
[FILTER-INJECTION] category filter: category = 'Food'
[FILTER-INJECTION] ILIKE filter: product_name ILIKE '%pizza%'
[AGGREGATION-INJECTION] SUM(quantity) as totale_venduto
[ORDERBY-INJECTION] ORDER BY totale_venduto DESC
[GROUPBY-CORRECTION] Final tool call args: {"orderBy":{"column":"totale_venduto","direction":"DESC"},"metricName":"gross_margin","filters":{"category":{"operator":"=","value":"Food"},"product_name":{"operator":"ILIKE","value":"%pizza%"}},"datasetId":"9","groupBy":["product_name"],"aggregations":[{"function":"SUM","column":"quantity","alias":"totale_venduto"}]}
[WIRING-CHECK] groupBy auto-corrected: ["category"] ‚Üí ["product_name"]
[SEMANTIC-CATEGORY] INJECTION: category='Pizza' for term "pizze"
[SEMANTIC-ORDERBY] Injecting metricName: gross_margin
[SEMANTIC-ORDERBY] Injecting orderBy: gross_margin DESC
[AGGREGATE-GROUP] Full args from Gemini: {
  "orderBy": {
    "column": "gross_margin",
    "direction": "DESC"
  },
  "metricName": "gross_margin",
  "filters": {
    "category": {
      "operator": "=",
      "value": "Food"
    },
    "product_name": {
      "operator": "ILIKE",
      "value": "%pizza%"
    }
  },
  "datasetId": "9",
  "groupBy": [
    "product_name"
  ],
  "aggregations": [
    {
      "function": "SUM",
      "column": "quantity",
      "alias": "totale_venduto"
    }
  ],
  "_semanticCategoryFilter": {
    "logicalRole": "category",
    "value": "Pizza"
  },
  "_detectedCategoryTerm": "pizze",
  "_applyIsSellable": true,
  "_semanticOrderByApplied": true
}
[AGGREGATE-GROUP] datasetId: 9
[AGGREGATE-GROUP] groupBy: ["product_name"]
[AGGREGATE-GROUP] metricName: gross_margin
[AGGREGATE-GROUP] aggregations: [{"function":"SUM","column":"quantity","alias":"totale_venduto"}]
[AGGREGATE-GROUP] orderBy: {"column":"gross_margin","direction":"DESC"}
[AGGREGATE-GROUP] filters: {"category":{"operator":"=","value":"Food"},"product_name":{"operator":"ILIKE","value":"%pizza%"}}
[WIRING-CHECK] checkCardinalityBeforeAggregate called for columns: ["product_name"]
[CARDINALITY-PROBE] Running: SELECT COUNT(DISTINCT "product_name") AS distinct_count, COUNT(*) AS total_rows FROM "cdd_0c73bbe5_ristorante_simulato_120k_con_c_314cf4be" WHERE "category" ILIKE $1 AND "product_name" ILIKE $2
[CARDINALITY-PROBE] Column "product_name": 0 distinct values, 0 total rows (696ms)
[CARDINALITY-CHECK] OK: 0 distinct values in "product_name" is within limit 500
[AGGREGATE-GROUP] Loaded 0 semantic mappings from database
[SEMANTIC-FILTER] FALLBACK ILIKE: No category column, using 7 patterns
[AGGREGATE-GROUP] Sales analytics detected - generating is_sellable filter
[AGGREGATE-GROUP] Reason: product groupBy
[AGGREGATE-GROUP] is_sellable config: productCol=product_name, revenueCol=none
[AGGREGATE-GROUP] productIlikeConfig built: 7 patterns on column "product_name"
[AGGREGATE-GROUP] is_sellable filter applied: productCol=product_name, revenueCol=none
[AGGREGATE-GROUP] productIlike filter applied: 7 patterns on column "product_name"
[AGGREGATE-GROUP] Result: success=false, rowCount=undefined, error=Invalid order by column: gross_margin
[QUERY-PLANNER] Tool aggregate_group failed: Invalid order by column: gross_margin
[QUERY-PLANNER] Execution complete in 1215ms, success: false
üîç Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
üìã Client preferred AI provider: vertex_admin
üîç TIER 0: Checking SuperAdmin Gemini Keys (Google AI Studio)...
‚úÖ TIER 0: Using SuperAdmin Google AI Studio (Gemini 3)
   üîë Key: 1/1
[RESULT-EXPLAINER] ALL TOOLS FAILED - generating contextual response. Errors: aggregate_group: Invalid order by column: gross_margin
3:59:16 AM [express] POST /api/activity/session/heartbeat 200 in 311ms :: {"success":true,"lastActiv‚Ä¶
[CLIENT-DATA] Assistant message saved: 967a79d6-3a1d-488e-bdb5-b88a54dd689e
3:59:22 AM [express] POST /api/client-data/conversations/94299690-2404-492f-9e3d-513f2f337209/messa