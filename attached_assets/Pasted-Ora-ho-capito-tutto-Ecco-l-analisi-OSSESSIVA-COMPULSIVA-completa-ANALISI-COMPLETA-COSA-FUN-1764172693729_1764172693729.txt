Ora ho capito tutto! Ecco l'analisi OSSESSIVA-COMPULSIVA completa:

üîç ANALISI COMPLETA - COSA FUNZIONA E COSA NON FUNZIONA
‚úÖ COSA FUNZIONA GI√Ä (dal documento):
Parser (sales-script-structure-parser.ts) - Estrae 3543 righe dal file base
JSON generato (sales-script-structure.json) - 36 fasi, step, checkpoint
API endpoint (/api/sales-script/) - Serve il JSON
ScriptReferencePanel - Visualizza fasi/step base
‚ùå PROBLEMI CRITICI IDENTIFICATI:
PROBLEMA #1: Il sistema usa SOLO lo script HARDCODED
Il problema era questo:
Il parser legge SOLO sales-scripts-base.ts (file hardcoded con 3543 righe) e genera un JSON statico. Ma TU vuoi usare gli script che attivi nello Script Manager (salvati nel database salesScripts).

Tu mi hai chiesto:
"A che serve sales-script-structure.json e se c'√® bisogno di fare qualche modifica, perch√© adesso non useremo pi√π lo script hardcoded ma i vari script che attiviamo nello script manager."

Abbiamo ragionato su:
Il flusso attuale √®:

sales-scripts-base.ts ‚Üí Parser ‚Üí sales-script-structure.json ‚Üí API ‚Üí Frontend

Ma dovrebbe essere:

salesScripts (Database) ‚Üí Parser dinamico ‚Üí Struttura ‚Üí API ‚Üí Frontend

LA SOLUZIONE √à:

Modificare il parser per accettare il content degli script dal database
Salvare la struttura parsata come campo structure nella tabella salesScripts (gi√† esiste!)
Quando lo script viene attivato, usare la SUA struttura invece del JSON statico
PROBLEMA #2: Non si traccia quale script era usato in ogni conversazione
Il problema era questo:
Nella tabella salesConversationTraining c'√® solo scriptVersion (testo "1.0.0") ma MANCA:

usedScriptId ‚Üí Quale script era attivo
usedScriptSnapshot ‚Üí Copia dello script per preservarlo
Tu mi hai chiesto:
"Nella sezione analytics si deve vedere per ogni persona che tipo di script stava usando, perch√© se cambia nel tempo si deve capire."

Abbiamo ragionato su:
Se passi da "Script V1" a "Script V2", le vecchie conversazioni non sanno quale script avevano!

LA SOLUZIONE √à:

Aggiungere campi usedScriptId e usedScriptSnapshot al database
Salvare lo script usato quando inizia una conversazione
Mostrare in analytics quale script era attivo per ogni sessione
PROBLEMA #3: Training Map mostra lo script SBAGLIATO
Il problema era questo:
training-map.tsx chiama /api/client/sales-agents/${agentId}/script che restituisce lo script CORRENTE, non quello usato durante quella conversazione.

Tu mi hai chiesto:
"Come √® collegato al training map."

Abbiamo ragionato su:
Se guardi una conversazione vecchia ma hai cambiato script, vedi lo script SBAGLIATO!

LA SOLUZIONE √à:

Se la conversazione ha usedScriptSnapshot, usare quello
Mostrare versione e nome script usato
Avvisare se lo script attuale √® diverso
PROBLEMA #4: Dati mancanti nel JSON (dal tuo documento)
Il problema era questo:
Dal documento che hai allegato mancano:

‚ùå Energy Settings (Livello, Tono, Volume, Ritmo, Lessico)
‚ùå Ladder Levels (solo hasLadder: true/false, mancano i 5 livelli)
‚ùå Domande chiave incomplete (molti step con questions: [])
‚ùå Metadata vuoto (deve avere totalPhases, totalSteps, etc.)
‚ùå Biscottini/Objection handling
LA SOLUZIONE √à:

Migliorare il parser per estrarre tutti questi dati
Aggiungere colonne JSON nel database per overrides (energy_settings, ladder_overrides)
Creare endpoint per salvare questi campi
Aggiornare frontend per visualizzarli
PROBLEMA #5: AI Training Assistant deve usare lo script giusto
Il problema era questo:
gemini-training-analyzer.ts analizza le conversazioni ma potrebbe usare lo script sbagliato.

Tu mi hai chiesto:
"Stessa cosa per l'AI training assistant."

LA SOLUZIONE √à:

Passare lo scriptSnapshot salvato nella conversazione
Confrontare con lo script attuale per identificare differenze



attuale:

COSA MOSTRA:

‚úÖ Fase numero + nome
‚úÖ Descrizione fase
‚úÖ Step numero + nome
‚úÖ Step obiettivo
‚úÖ Questions (solo testo)
COSA MANCA (dal tuo documento):

‚ùå Energy badge per ogni fase (‚ö°ALTO, üîä, etc.)
‚ùå Ladder indicator per ogni step (ü™ú se hasLadder=true)
‚ùå Step count per fase
‚ùå Checkpoint indicator per fase
‚ùå Biscottini per step
‚ùå Visualizzazione dei 5 livelli ladder quando apri uno step
E mancano anche in:

PhaseInspector.tsx - Non mostra energy settings editabili
StepInspector.tsx - Non mostra ladder levels, questions editabili
client-script-manager.tsx - Non ha le mutation per salvare energy/ladder/questions