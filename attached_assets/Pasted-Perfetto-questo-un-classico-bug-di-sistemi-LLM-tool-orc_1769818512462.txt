Perfetto, questo √® un classico bug di sistemi LLM + tool orchestration:
non √® ‚Äúcolpa del modello‚Äù, √® mancanza di routing stateful + tool gating.

Ti spiego perch√© √® successo e come lo rendi impossibile da ripetere.

Cosa √® successo davvero

Scenario:

1Ô∏è‚É£ Hai appena creato una consultation
2Ô∏è‚É£ Stato reale: esiste una consultation nel DB
3Ô∏è‚É£ Utente scrive:

‚Äúme lo puoi modificare‚Äù

Il tuo router ha fatto questo:

Intent ‚Üí general (o confidence bassa)

Non ha trovato keyword booking

hasPendingBooking=false (perch√© √® gi√† confirmed)

isConsultationQuery=false

Tool booking NON esposti

File Search + codeExecution ATTIVI

üëâ Gemini ha solo una scelta: parlare
üëâ e quindi ha ‚Äúfinto‚Äù la modifica.

Root problem (architetturale)

Tu stai usando solo:

pending state (awaiting confirm)

Ma non hai uno stato per:

‚Äúesiste una consultation appena creata che pu√≤ essere modificata‚Äù

Serve uno POST-BOOKING CONTEXT.

Soluzione corretta (production pattern)

Devi introdurre questo concetto:

üß† Active Consultation Context

Quando fai confirmBooking:

Salva in session:
lastConsultationId
lastConsultationStartAt
lastConsultationExpiresAt (es: now + 30 min)


Questo pu√≤ stare:

Redis

DB conversation state

in-memory cache per user session

Router logic nuova

Prima di decidere intent/tools:

if lastConsultationExists AND within time window:
   allow modify/cancel tools

Devi anche avere INTENT esplicito

Aggiungi nel tuo classifier:

modify_booking - User wants to change existing consultation
Examples:
- "me lo puoi modificare"
- "spostalo"
- "cambia orario"
- "vorrei anticiparlo"

Tool set corretto per MODIFY

Non riusare confirmBooking.

Crea:

rescheduleBooking
cancelBooking

E soprattutto: QUI devi usare REQUIRED

Caso tuo:

Utente:

me lo puoi modificare

Router:

if intent == modify_booking AND lastConsultationId exists:
   tools = [rescheduleBooking]
   mode = REQUIRED


Cos√¨:

Gemini NON pu√≤ usare file search

NON pu√≤ parlare

DEVE chiamare backend

Guardrail fondamentale (da mettere nel system prompt)

Aggiungi:

Never claim to modify, cancel, or reschedule a consultation unless a tool call succeeds.

Questo da solo elimina il 70% delle allucinazioni operative.

Extra: fallback UX corretto

Se l‚Äôutente scrive:

me lo puoi modificare

Ma NON c‚Äô√® lastConsultation:

Risposta corretta:

Non vedo consulenze recenti da modificare. Vuoi prenotarne una nuova o indicarmi quale vuoi cambiare?

NON chiamare tools.

Riassunto operativo (da implementare)
1Ô∏è‚É£ Aggiungi intent
modify_booking
cancel_booking

2Ô∏è‚É£ Salva stato post-confirm

Quando confirmBooking success:

session.lastConsultationId = consultation_id
session.bookingContextTTL = now + 30min

3Ô∏è‚É£ Router patch
if (
  intent === 'modify_booking' &&
  session.lastConsultationId
) {
  tools = ['rescheduleBooking'];
  mode = 'REQUIRED';
}

4Ô∏è‚É£ Blocca file search durante booking flows

Se:

booking_flow_active OR lastConsultationExists


üëâ fileSearch = false

Livello architetturale (quello che stai costruendo)

Stai passando da:

‚ùå stateless chat bot
a
‚úÖ transactional assistant

Serve:

memory corta (booking state)

router deterministico

REQUIRED per azioni mutative