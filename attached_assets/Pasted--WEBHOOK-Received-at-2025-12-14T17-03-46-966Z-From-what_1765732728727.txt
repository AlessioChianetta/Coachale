
ğŸ””ğŸ””ğŸ”” [WEBHOOK] Received at 2025-12-14T17:03:46.966Z ğŸ””ğŸ””ğŸ””
ğŸ“ From: whatsapp:+393519272875
ğŸ“± To: whatsapp:+393500220129
ğŸ’¬ Body: Ciao!...
ğŸ†” MessageSid: SMef83ae89324ca0ca37d0f75aa2a1dcf2
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… [ANTI-DUP] Messaggio SMef83ae89324ca0ca37d0f75aa2a1dcf2 Ã¨ nuovo, procedo con l'elaborazione
ğŸ“ Routing message to agent: Receptionist Principale (+393500220129)
ğŸ†• Conversation not found for +393519272875, creating new one...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [CONVERSATION LOOKUP] Called at 2025-12-14T17:03:47.480Z
ğŸ“ Phone: +393519272875
ğŸ‘¤ Consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ¤– Agent: fe95f393-b8c9-4fc0-80d7-2035dcba305a
ğŸ¯ Proactive Lead: false
ğŸ“ Call originated from:
    at handleWebhook (/home/runner/workspace/server/whatsapp/webhook-handler.ts:273:26)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:9794:7)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ†•ğŸ†•ğŸ†• [CONVERSATION CREATE] Creating NEW conversation at 2025-12-14T17:03:47.802Z ğŸ†•ğŸ†•ğŸ†•
ğŸ‘¤ [PARTICIPANT] Type: unknown, isLead: true, userId: none
âœ… [CONVERSATION CREATED] id=8b109eec-b6bc-4447-b75a-851b5127d34b for +393519272875 (Type: unknown, Lead) assigned to agent: fe95f393-b8c9-4fc0-80d7-2035dcba305a
âš ï¸ [CONVERSATION STATE] Failed to create state for 8b109eec-b6bc-4447-b75a-851b5127d34b: error: there is no unique or exclusion constraint matching the ON CONFLICT specification
    at /home/runner/workspace/node_modules/pg/lib/client.js:545:17
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async <anonymous> (/home/runner/workspace/server/whatsapp/webhook-handler.ts:690:9)
    at async NodePgSession.transaction (/home/runner/workspace/node_modules/src/node-postgres/session.ts:193:19)
    at async findOrCreateConversation (/home/runner/workspace/server/whatsapp/webhook-handler.ts:537:10)
    at async handleWebhook (/home/runner/workspace/server/whatsapp/webhook-handler.ts:273:20)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:9794:7) {
  length: 148,
  severity: 'ERROR',
  code: '42P10',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'plancat.c',
  line: '943',
  routine: 'infer_arbiter_indexes'
}
âŒ WhatsApp webhook error: error: insert or update on table "whatsapp_pending_messages" violates foreign key constraint "whatsapp_pending_messages_conversation_id_fkey"
    at /home/runner/workspace/node_modules/pg-pool/index.js:45:11
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async handleWebhook (/home/runner/workspace/server/whatsapp/webhook-handler.ts:362:3)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:9794:7) {
  length: 398,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (conversation_id)=(8b109eec-b6bc-4447-b75a-851b5127d34b) is not present in table "whatsapp_conversations".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'whatsapp_pending_messages',
  column: undefined,
  dataType: undefined,
  constraint: 'whatsapp_pending_messages_conversation_id_fkey',
  file: 'ri_triggers.c',
  line: '2599',
  routine: 'ri_ReportViolation'
}
5:03:48 PM [express] POST /api/whatsapp/webhook 500 in 1382ms :: {"message":"insert or update on tabâ€¦
Unexpected database pool error: {
  code: 'XX000',
  message: 'DbHandler exited. Check logs for more information.',
  severity: 'FATAL'
}
5:03:50 PM [express] GET /api/whatsapp/conversations 304 in 1016ms :: {"conversations":[{"id":"eee1dâ€¦
5:03:56 PM [express] GET /api/whatsapp/conversations 304 in 404ms :: {"conversations":[{"id":"eee1ddâ€¦
ğŸ”„ [WHATSAPP POLLING] Starting poll cycle...
â° [FOLLOWUP-SCHEDULER] Processing cycle triggered
ğŸ“¤ [FOLLOWUP-SCHEDULER] Processing scheduled messages...
ğŸ“Š [WHATSAPP POLLING] Polling 4 consultant(s) sequentially...
âš ï¸ [WHATSAPP POLLING] Skipping consultant 611b2437-3b3f-4063-ad89-2164943abf1d - incomplete config
ğŸ“¬ [FOLLOWUP-SCHEDULER] Found 0 pending messages to send
ğŸ’¤ [FOLLOWUP-SCHEDULER] No pending messages
âš ï¸ [WHATSAPP POLLING] Skipping consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b - incomplete config
ğŸ”’ [CIRCUIT BREAKER] Skipping agent 760bb513-098f-4722-b02a-a700160c2fc3 (Marco setter) - circuit breaker is open
5:04:01 PM [express] GET /api/whatsapp/conversations 304 in 407ms :: {"conversations":[{"id":"eee1ddâ€¦
ğŸ”– [WATERMARK] Agent Receptionist Principale (fe95f393-b8c9-4fc0-80d7-2035dcba305a) - last processed: 2025-12-14T17:03:48.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Receptionist Principale
ğŸ“Œ [WATERMARK] Latest on Twilio (2025-12-14T17:03:48.000Z) is older than watermark - keeping current
âœ… [WHATSAPP POLLING] Poll cycle complete







