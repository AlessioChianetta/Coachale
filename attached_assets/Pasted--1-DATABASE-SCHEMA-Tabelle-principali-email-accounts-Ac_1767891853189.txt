

1. DATABASE SCHEMA
Tabelle principali:
email_accounts - Account email collegati

Campo	Tipo	Descrizione
id	serial PK	ID univoco
consultant_id	FKâ†’users	Proprietario
provider	enum	gmail, microsoft, imap
display_name	varchar	Nome visualizzato
primary_email	varchar	Email principale
auth_type	enum	oauth, password
oauth_refresh_token	text (encrypted)	Token refresh OAuth
oauth_access_token	text (encrypted)	Token accesso
oauth_expires_at	timestamp	Scadenza token
imap_host/port/tls	per IMAP generico	
smtp_host/port/tls/user/password	per invio	
auto_reply_mode	enum	manual, review, auto
confidence_threshold	real	Soglia fiducia AI (0.0-1.0)
polling_interval_minutes	integer	Frequenza sync
last_sync_at	timestamp	Ultima sincronizzazione
emails - Email ricevute/inviate

Campo	Tipo	Descrizione
id	serial PK	ID univoco
account_id	FKâ†’email_accounts	Account di appartenenza
consultant_id	FKâ†’users	Consulente
client_id	FKâ†’users nullable	Cliente associato
message_id	varchar unique	ID univoco messaggio
thread_id	varchar	ID thread conversazione
subject	text	Oggetto
from_name/from_email	varchar	Mittente
to_recipients	jsonb	Destinatari
body_html/body_text	text	Contenuto
attachments	jsonb	Allegati
direction	enum	inbound, outbound
ai_classification	jsonb	Classificazione AI
ai_confidence	real	Confidenza classificazione
processing_status	enum	new, pending_ai, ai_draft_ready, awaiting_review, sent, archived, escalated
received_at/sent_at	timestamp	Date
email_ai_responses - Risposte generate dall'AI

Campo	Tipo	Descrizione
id	serial PK	ID univoco
email_id	FKâ†’emails	Email di riferimento
draft_body_html/text	text	Bozza risposta
reasoning	jsonb	Ragionamento AI
status	enum	draft, awaiting_review, approved_sent, rejected, auto_sent
generated_by	enum	ai, human
sent_at	timestamp nullable	Data invio
email_rules - Regole automazione

Campo	Tipo	Descrizione
id	serial PK	ID univoco
consultant_id	FKâ†’users	Proprietario
name	varchar	Nome regola
trigger	enum	intent, keyword, sender, time
conditions	jsonb	Condizioni
action	enum	auto_reply, set_folder, escalate
is_active	boolean	Attiva/disattiva
2. BACKEND API
Account Management
POST   /api/email-hub/accounts              â†’ Crea account
GET    /api/email-hub/accounts              â†’ Lista account
PATCH  /api/email-hub/accounts/:id          â†’ Modifica account
DELETE /api/email-hub/accounts/:id          â†’ Elimina account
OAuth Flow
GET    /api/email-hub/oauth/google/start    â†’ Avvia OAuth Google
GET    /api/email-hub/oauth/google/callback â†’ Callback OAuth
GET    /api/email-hub/oauth/microsoft/start â†’ Avvia OAuth Microsoft
GET    /api/email-hub/oauth/microsoft/callback
POST   /api/email-hub/accounts/:id/imap-test â†’ Test IMAP
Email Operations
GET    /api/email-hub/inbox                 â†’ Lista email (paginated)
GET    /api/email-hub/emails/:id            â†’ Dettaglio email
POST   /api/email-hub/emails/:id/ai-draft   â†’ Rigenera bozza AI
POST   /api/email-hub/emails/:id/approve    â†’ Approva e invia
POST   /api/email-hub/emails/:id/reject     â†’ Rifiuta bozza
POST   /api/email-hub/emails/:id/escalate   â†’ Escalation manuale
Sync & Rules
POST   /api/email-hub/accounts/:id/sync     â†’ Trigger sync manuale
GET    /api/email-hub/rules                 â†’ Lista regole
POST   /api/email-hub/rules                 â†’ Crea regola
PATCH  /api/email-hub/rules/:id             â†’ Modifica regola
DELETE /api/email-hub/rules/:id             â†’ Elimina regola
3. FRONTEND - /consultant/email-hub
Layout
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: Email Hub - Centro Gestione Email                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sidebar  â”‚  Main Content                                    â”‚
â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â€¢ Accountâ”‚  â”‚ Inbox List (filtri, ricerca, ordinamento)   â”‚ â”‚
â”‚   Gmail  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚   Outlookâ”‚  â”‚ â”‚ Email 1 - Subject - Da: Mario - 10:30â”‚   â”‚ â”‚
â”‚   IMAP   â”‚  â”‚ â”‚ Email 2 - Subject - Da: Lucia - 09:15â”‚   â”‚ â”‚
â”‚          â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â€¢ Regole â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â€¢ Stats  â”‚  â”‚ Email Detail + AI Response Panel            â”‚ â”‚
â”‚          â”‚  â”‚ [Originale] [Risposta AI] [Timeline]        â”‚ â”‚
â”‚          â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚          â”‚  â”‚ â”‚ Bozza AI: "Gentile Mario, grazie..."    â”‚ â”‚ â”‚
â”‚          â”‚  â”‚ â”‚ Confidenza: 92%                         â”‚ â”‚ â”‚
â”‚          â”‚  â”‚ â”‚ [Approva] [Modifica] [Rifiuta]          â”‚ â”‚ â”‚
â”‚          â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Componenti React
EmailHubPage - Pagina principale
AccountSidebar - Lista account + stato sync
AccountWizard - Modal per collegare nuovo account
InboxList - Lista email con filtri
EmailDetail - Dettaglio email selezionata
AIResponsePanel - Bozza AI con azioni
RulesEditor - Gestione regole automazione
SyncStatus - Indicatore sincronizzazione
4. AI WORKFLOW
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Email Ricevuta â”‚ â”€â†’ â”‚ Classificazione â”‚ â”€â†’ â”‚ Valuta Regole   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   (Gemini)      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ â€¢ intent        â”‚              â”‚
                     â”‚ â€¢ urgenza       â”‚              â–¼
                     â”‚ â€¢ sentiment     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ ModalitÃ  Auto?   â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â–¼                       â–¼                       â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ auto_reply  â”‚         â”‚   review    â”‚         â”‚   manual    â”‚
                   â”‚ Confidenza  â”‚         â”‚ Bozza AI    â”‚         â”‚ Solo notify â”‚
                   â”‚ >= soglia   â”‚         â”‚ per approva â”‚         â”‚ consulente  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                       â”‚
                          â–¼                       â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Genera +    â”‚         â”‚ Genera      â”‚
                   â”‚ Invia auto  â”‚         â”‚ Bozza       â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Context per Gemini
Profilo consulente (tono, firma, stile)
Storico cliente (email precedenti, goals, note)
Knowledge base (documenti caricati)
Regole custom del consulente
5. INTEGRATIONS
Provider	Metodo	Auth	Sync
Gmail	Gmail API	OAuth 2.0	Push (webhook) + Pull
Microsoft 365	Graph API	OAuth 2.0	Delta queries
IMAP generico	node-imap	Password	Polling (IDLE)
Token Refresh
Job cron ogni 5 minuti
Controlla oauth_expires_at
Refresh automatico prima scadenza
6. SECURITY
Crittografia: Tutte le credenziali cifrate con salt per-consulente
OAuth scopes minimi: solo mail.read, mail.send
Multi-tenant isolation: filtro consultant_id su tutte le query
Audit log: log di tutte le email inviate dall'AI
Rate limiting: max 10 draft AI/minuto, max 50 email/ora








ğŸ”§ USE CASE SUPERADMIN
1. Configurazione OAuth Apps
Registrare Google Cloud OAuth Client ID/Secret
Registrare Microsoft Azure App ID/Secret
Ruotare le credenziali quando scadono
Abilitare/disabilitare provider per i consulenti
2. Gestione Provider Email
Configurare server IMAP/SMTP condivisi aziendali
Definire domini email autorizzati
Monitorare stato salute account (sync failures, quota)
3. Policy AI Globali
Impostare limiti: max 10 bozze AI/minuto, max 50 email/ora
Definire guardrails (cosa l'AI NON puÃ² dire)
Configurare escalation automatiche per casi sensibili
Template risposte standard per categorie comuni
4. Audit e Monitoraggio
Dashboard account collegati per tutti i consulenti
Log di tutte le email inviate dall'AI
Report usage e costi AI
ğŸ‘¨â€ğŸ’¼ USE CASE CONSULENTE
5. Connessione Account Email
Flow Gmail:

Click "Connetti Gmail" â†’ Redirect OAuth Google â†’ 
Autorizza permessi â†’ Token salvato criptato â†’ 
Sync iniziale â†’ Account visibile in sidebar
Flow Microsoft 365:

Click "Connetti Outlook" â†’ Redirect OAuth Microsoft â†’ 
Autorizza permessi â†’ Token salvato â†’ Sync
Flow IMAP Generico:

Inserisci host/porta/utente/password â†’ 
Test connessione â†’ Salva credenziali criptate â†’ Sync
6. Inbox Unificato
Vista lista email con filtri (account, data, stato, cliente)
Ricerca full-text su oggetto e corpo
Ordinamento per data, urgenza, stato AI
Badge per email non lette, in attesa review
Thread di conversazione raggruppati
7. Dettaglio Email
Visualizza email originale (HTML/testo)
Vedi allegati
Timeline conversazione completa
Info cliente associato (dal CRM)
Storico interazioni precedenti
8. Gestione Risposte AI
ModalitÃ  Review:

Email arriva â†’ AI genera bozza â†’ 
Consulente riceve notifica â†’ Apre bozza â†’ 
Vede confidenza (es. 92%) e ragionamento â†’ 
[Approva] invia subito | [Modifica] e invia | [Rifiuta] scrivi manuale
ModalitÃ  Auto:

Email arriva â†’ AI classifica + genera risposta â†’ 
Se confidenza â‰¥ soglia â†’ Invia automaticamente â†’ 
Log per audit
ModalitÃ  Manual:

Email arriva â†’ Solo notifica â†’ 
Consulente scrive risposta manualmente
9. Impostazioni Account
Nome visualizzato e firma
Tono risposte AI (formale/informale)
Soglia confidenza per auto-reply (0.0 - 1.0)
Frequenza sync (ogni 1, 5, 15 minuti)
ModalitÃ  risposta (auto/review/manual)
10. Regole Automazione
Esempi regole:

Trigger	Condizione	Azione
Mittente	@gmail.com	Tagga come "Personale"
Keyword	"fattura", "pagamento"	Escalation immediata
Intent AI	Richiesta supporto	Auto-reply con FAQ
Orario	Fuori ufficio	Risposta automatica assenza
SLA	Nessuna risposta 24h	Notifica urgente
Flow creazione regola:

Click "Nuova Regola" â†’ Scegli trigger â†’ 
Imposta condizioni â†’ Seleziona azione â†’ 
Testa su email storiche â†’ Attiva
11. Azioni Rapide
Archivia email
Snooze (ricompare tra X ore)
Assegna a collaboratore
Crea task nel CRM
Collega a cliente esistente
ğŸ¤– USE CASE AI AUTOMATION
12. Classificazione Automatica
Quando arriva un'email, l'AI analizza:

Intent: richiesta info, supporto, reclamo, vendita, spam
Urgenza: bassa, media, alta, critica
Sentiment: positivo, neutro, negativo
Cliente: identifica se giÃ  in database
13. Generazione Risposta
L'AI usa come contesto:

Profilo consulente (tono, firma, specializzazione)
Storico cliente (email precedenti, goals, note CRM)
Knowledge base (documenti caricati)
Template approvati
Regole custom
14. Escalation Intelligente
Trigger automatici:

Confidenza AI < soglia
Parole chiave sensibili (legale, rimborso, denuncia)
Cliente VIP
SLA in scadenza
Sentiment molto negativo
15. Follow-up Automatici
Se nessuna risposta dopo X giorni â†’ reminder
Se pratica aperta â†’ aggiornamento stato
Se scadenza imminente â†’ sollecito
ğŸ‘¥ USE CASE CLIENTE FINALE
16. Ricezione Risposte
Riceve email contestuali e personalizzate
Risposte rapide (anche fuori orario se auto)
Consistenza tono e qualitÃ 
17. Interazione Thread
Risponde all'email â†’ arriva al consulente
Richiesta elaborata velocemente
Storico conversazione mantenuto
18. Link a Portale
Email contiene link ad azioni (es. "Clicca per confermare")
Stato azione sincronizzato nel CRM
ğŸ”„ SYNC E BACKGROUND
19. Polling Email
Provider	Metodo	Frequenza
Gmail	Webhook + polling backup	Real-time
Microsoft	Graph API webhooks	Real-time
IMAP generico	IDLE + polling	1-15 min
20. Token Refresh
Job ogni 5 minuti controlla scadenze
Refresh automatico prima scadenza
Alert se refresh fallisce
21. Retry e Resilienza
Coda retry per sync falliti
Backoff esponenziale
Dashboard errori e quota
