import { logger } from './logger.js';
import { config } from './config.js';
import pkg from 'modesl';
const { Connection } = pkg;

const log = logger.child('OUTBOUND');

declare function setExpectedCallId(uuid: string): void;

interface OutboundCallRequest {
  targetPhone: string;
  callId: string;
  aiMode: string;
  customPrompt?: string;
}

interface OutboundCallResponse {
  success: boolean;
  callId?: string;
  freeswitchUuid?: string;
  error?: string;
}

function validatePhoneNumber(phone: string): boolean {
  const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
  return /^(\+?[1-9]\d{6,14}|\d{3,6})$/.test(cleanPhone);
}

function normalizePhone(phone: string): string {
  let clean = phone.replace(/[\s\-\(\)]/g, '');
  if (clean.startsWith('00')) clean = '+' + clean.slice(2);
  return clean;
}

async function originateCall(targetPhone: string, callId: string): Promise<{ uuid: string }> {
  return new Promise((resolve, reject) => {
    const conn = new Connection(
      config.esl?.host || '127.0.0.1',
      config.esl?.port || 8021,
      config.esl?.password || 'ClueCon'
    );

    conn.on('error', (err: Error) => {
      log.error('ESL connection error', { error: err.message });
      reject(new Error('ESL connection failed: ' + err.message));
    });

    conn.on('esl::ready', () => {
      const uuid = 'outbound-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
      const normalizedPhone = normalizePhone(targetPhone);

      setExpectedCallId(uuid);

      const gateway = config.sip?.gateway || 'voip_trunk';
      const callerId = config.sip?.callerId || '+390000000000';

      const originateCmd = 'originate {origination_uuid=' + uuid + ',origination_caller_id_number=' + callerId + ',origination_caller_id_name=Alessia}sofia/gateway/' + gateway + '/' + normalizedPhone + ' &bridge(user/9999)';

      log.info('Executing originate command', { uuid, targetPhone: normalizedPhone, gateway });

      (conn as any).api(originateCmd, (result: any) => {
        const response = result?.body || '';
        log.info('Originate result', { response });

        if (response.includes('-ERR')) {
          reject(new Error('FreeSWITCH error: ' + response));
        } else {
          resolve({ uuid });
        }

        conn.disconnect();
      });
    });
  });
}

export async function handleOutboundCall(req: OutboundCallRequest): Promise<OutboundCallResponse> {
  const { targetPhone, callId, aiMode } = req;

  log.info('Received outbound call request', { callId, targetPhone, aiMode });

  if (!validatePhoneNumber(targetPhone)) {
    log.warn('Invalid phone number', { targetPhone });
    return { success: false, error: 'Invalid phone number format' };
  }

  if (!callId) {
    return { success: false, error: 'Missing callId' };
  }

  try {
    const result = await originateCall(targetPhone, callId);
    log.info('Call originated successfully', { callId, uuid: result.uuid });

    return {
      success: true,
      callId,
      freeswitchUuid: result.uuid,
    };
  } catch (error: any) {
    log.error('Failed to originate call', { callId, error: error.message });
    return {
      success: false,
      callId,
      error: error.message,
    };
  }
}