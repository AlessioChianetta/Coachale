7:50:49 PM [express] POST /api/activity/session/heartbeat 200 in 436ms :: {"success":true,"lastActivâ€¦
ğŸ”„ [FOLLOWUP-API] Manual trigger requested by consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b
ğŸ” [FOLLOWUP-SCHEDULER] Starting ALL follow-up evaluation cycle...
ğŸ§  [FOLLOWUP-SCHEDULER] AI-ONLY mode: Found 3 consultants with active WhatsApp configs
âœ… [FILTER-CHECK] Excluding closed states: 'closed_won', 'closed_lost' from candidate search
ğŸ“Š [CANDIDATE] 1c158920-2cad-4274-98dc-0adbb5ca61e8: leadNeverResponded=true, hoursSinceLastInbound=999.0h, lastInbound=NULL
ğŸ“Š [FOLLOWUP-SCHEDULER] Found 1 ALL candidate conversations
ğŸ” [FOLLOWUP-SCHEDULER] Evaluating conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
   State: new, Days silent: 0, Hours silent: 0.1, Follow-ups: 0/5
   ğŸ“‹ Applicable rules: 0 (Sistema AI attivo - le regole sono opzionali)
ğŸ¤– [FOLLOWUP-SCHEDULER] Nessuna regola esplicita - Sistema AI "Marco" attivo per 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ§‘â€ğŸ’¼ [FOLLOWUP-ENGINE] Human-Like AI evaluation for conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
   State: new, Days silent: 0, Follow-ups: 0/5
   Mode: AI-ONLY (no hardcoded rules)
ğŸ“œ [FOLLOWUP-ENGINE] Found 1 previous evaluations for context
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
ğŸš€ [FOLLOWUP-ENGINE] Using Vertex AI (SuperAdmin) for evaluation
â° [FOLLOWUP-SCHEDULER] Processing cycle triggered
ğŸ“¤ [FOLLOWUP-SCHEDULER] Processing scheduled messages...
ğŸ”„ [WHATSAPP POLLING] Starting poll cycle...
ğŸ“¬ [FOLLOWUP-SCHEDULER] Found 0 pending messages to send
ğŸ’¤ [FOLLOWUP-SCHEDULER] No pending messages
ğŸ“Š [WHATSAPP POLLING] Polling 5 consultant(s) sequentially...
âš ï¸ [WHATSAPP POLLING] Skipping consultant 611b2437-3b3f-4063-ad89-2164943abf1d - incomplete config
âš ï¸ [WHATSAPP POLLING] Skipping consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b - incomplete config
âš ï¸ [WHATSAPP POLLING] Skipping consultant c2146759-f08a-430a-afdf-701bbc674300 - incomplete config
ğŸ”– [WATERMARK] Agent Marco setter (760bb513-098f-4722-b02a-a700160c2fc3) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Marco setter
ğŸ“Œ [WATERMARK] Latest on Twilio (2025-12-14T18:11:36.000Z) is older than watermark - keeping current
ğŸ”– [WATERMARK] Agent Receptionist Principale (fe95f393-b8c9-4fc0-80d7-2035dcba305a) - last processed: 2025-12-14T18:11:36.000Z
âœ… [WHATSAPP POLLING] No new messages for agent Receptionist Principale
âœ… [WHATSAPP POLLING] Poll cycle complete
âœ… [FOLLOWUP-ENGINE] Decision: schedule (confidence: 0.98)
   Reasoning: In qualitÃ  di Marco, con 15 anni di esperienza, non invierei un altro messaggio dopo soli 3 minuti dal primo. Il lead non ha ancora avuto tempo di leggere e rispondere. Ãˆ fondamentale dare spazio al potenziale cliente. La decisione piÃ¹ sensata Ã¨ programmare un follow-up per domani mattina, diciamo alle 10:00. Se entro allora non avrÃ  risposto, potremo inviare un secondo template per riattivare l'interesse. Il primo messaggio Ã¨ stato inviato pochi minuti fa, quindi non ci sono segnali negativi, solo normale attesa. UserÃ² l'altro template disponibile per variare l'approccio nel follow-up.
   Latency: 13423ms
ğŸ“ [FOLLOWUP-ENGINE] Logging decision for conversation 1c158920-2cad-4274-98dc-0adbb5ca61e8
âœ… [FOLLOWUP-ENGINE] Decision logged successfully
ğŸ” [TEMPLATE-TRACE] â•â•â• CHIAMATA 2: AI decision â•â•â•
ğŸ” [TEMPLATE-TRACE] candidate.agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-TRACE] candidate.conversationId: 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ” [TEMPLATE-TRACE] candidate.leadName: undefined
ğŸ” [TEMPLATE-TRACE] decision.decision: schedule
âš ï¸ [FOLLOWUP-SCHEDULER] Lead mai risposto - finestra 24h non ancora aperta, richiesto template approvato
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” [TEMPLATE-DEBUG] Cercando template per agentConfigId: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ” [TEMPLATE-DEBUG] Conversation: 1c158920-2cad-4274-98dc-0adbb5ca61e8
ğŸ” [TEMPLATE-DEBUG] Template TROVATI dalla query (tutti): 2
ğŸ” [TEMPLATE-DEBUG]   1. templateId: HX922112cd9b1d531c5be56772acd50034, type: twilio, priority: 2
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG]   2. templateId: HX5e6d27c6d82026f3620247262ef67340, type: twilio, priority: 1
ğŸ” [TEMPLATE-DEBUG]      - Inizia con HX? true
ğŸ” [TEMPLATE-DEBUG]      - templateType === 'twilio'? true
ğŸ” [TEMPLATE-DEBUG] Template DOPO filtro (HX + twilio): 2
ğŸ” [TEMPLATE-DEBUG]   1. HX922112cd9b1d531c5be56772acd50034 (priority: 2)
ğŸ” [TEMPLATE-DEBUG]   2. HX5e6d27c6d82026f3620247262ef67340 (priority: 1)
ğŸ” [TEMPLATE-DEBUG] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… [FOLLOWUP-SCHEDULER] Template Twilio approvato SELEZIONATO: HX922112cd9b1d531c5be56772acd50034 (priority: 2, type: twilio)
ğŸ¯ [FOLLOWUP-SCHEDULER] Outside 24h/Lead never responded - using AI to select best template
ğŸ“‹ [TEMPLATE-AI] Fetching all approved templates for agent: 760bb513-098f-4722-b02a-a700160c2fc3
ğŸ“‹ [TEMPLATE-AI] Found 2 templates for AI selection
ğŸ¯ [TEMPLATE-AI] Selecting best template for conversation with 2 options
ğŸ”„ [TEMPLATE-AI] Attempt 1/3
ğŸ” Finding AI provider for client 0c73bbe5-51e1-4108-866b-6be7a52fce3b (consultant: 0c73bbe5-51e1-4108-866b-6be7a52fce3b)...
ğŸ“‹ Client preferred AI provider: vertex_admin
ğŸ” TIER 0: Checking SuperAdmin Vertex AI eligibility...
ğŸ“‹ User 0c73bbe5-51e1-4108-866b-6be7a52fce3b is the consultant themselves
âœ… Consultant 0c73bbe5-51e1-4108-866b-6be7a52fce3b can use SuperAdmin Vertex AI
ğŸ” Looking for SuperAdmin Vertex AI configuration...
ğŸ“‹ Found SuperAdmin Vertex AI config: project=gen-lang-client-0278434337, location=us-central1
âœ… Parsed credentials as plaintext JSON
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… Created SuperAdmin Vertex AI client successfully
âœ… TIER 0: Successfully created SuperAdmin Vertex AI client
7:51:11 PM [express] GET /api/followup/activity-log 200 in 1588ms :: {"timeline":[{"conversationId":â€¦
âŒ [TEMPLATE-AI] Attempt 1 failed: GaxiosError: Could not refresh access token: request to http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform failed, reason: connect ECONNREFUSED 169.254.169.254:80
    at Gaxios._request (/home/runner/workspace/node_modules/gaxios/src/gaxios.ts:225:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async metadataAccessor (/home/runner/workspace/node_modules/gcp-metadata/src/index.ts:174:15)
    at async Compute.refreshTokenNoCache (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/computeclient.js:57:20)
    at async Compute.getRequestMetadataAsync (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/oauth2client.js:372:17)
    at async Compute.getRequestHeaders (/home/runner/workspace/node_modules/google-auth-library/build/src/auth/oauth2client.js:336:26)
    at async NodeAuth.addGoogleAuthHeaders (/home/runner/workspace/node_modules/@google/genai/src/node/_node_auth.ts:75:25)
    at async ApiClient.getHeadersInternal (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:634:5)
    at async ApiClient.includeExtraHttpOptionsToRequestInit (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:476:27)
    at async ApiClient.request (/home/runner/workspace/node_modules/@google/genai/src/_api_client.ts:377:19)
    at async Models.Models.generateContent (/home/runner/workspace/node_modules/@google/genai/src/models.ts:76:14)
    at async selectBestTemplateWithAI (/home/runner/workspace/server/ai/followup-decision-engine.ts:634:26)
    at async evaluateConversation (/home/runner/workspace/server/cron/followup-scheduler.ts:1419:29)