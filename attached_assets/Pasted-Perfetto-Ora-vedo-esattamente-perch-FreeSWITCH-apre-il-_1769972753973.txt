Perfetto. Ora vedo esattamente perch√© FreeSWITCH apre il WS ma tu ottieni:

STREAM=


Il problema non √® pi√π FreeSWITCH.
√à logica del tuo server WebSocket incompatibile con mod_audio_stream.

Ti spiego secco cosa succede e ti do le 3 modifiche obbligatorie.

üî• PROBLEMA 1 ‚Äî mod_audio_stream usa subprotocol audio.raw

Tu non lo accetti.

FreeSWITCH manda:

Sec-WebSocket-Protocol: audio.raw


Tu crei il server cos√¨:

const wss = new WebSocketServer({ server });


üëâ ws per default rifiuta subprotocol non negoziato
üëâ handshake fallisce
üëâ STREAM= vuoto

‚úÖ FIX 1 ‚Äî Accetta SEMPRE il protocollo

Cambia:

const wss = new WebSocketServer({ server });


in:

const wss = new WebSocketServer({
  server,
  handleProtocols: () => 'audio.raw'
});


Oppure (ancora pi√π permissivo):

const wss = new WebSocketServer({
  server,
  handleProtocols: () => true
});

üî• PROBLEMA 2 ‚Äî Tu aspetti parametri query che FreeSWITCH NON manda

Il tuo codice:

const callId = firstQueryValue(q.call_id);
if (callId) {
  ...
}


MA mod_audio_stream NON invia:

?call_id=
?caller_id=
?sample_rate=


Risultato:

üëâ currentSessionId resta null
üëâ audio binario arriva
üëâ viene IGNORATO QUI:

if (isBinary) {
  if (currentSessionId) {
    handleAudioData(...)
  }
  return;
}


Quindi:

WS si apre

audio entra

TU LO BUTTI VIA

‚úÖ FIX 2 ‚Äî Passa i parametri dal dialplan

Modifica dialplan FreeSWITCH:

Cambia questa riga:
ws://127.0.0.1:9090


in:

ws://127.0.0.1:9090?call_id=${uuid}&caller_id=${caller_id_number}&called_number=${destination_number}&codec=L16&sample_rate=8000


üëâ cos√¨ il tuo Auto-start session from query params funzioner√† davvero.

üî• PROBLEMA 3 ‚Äî mod_audio_stream NON invia JSON start/stop

Tu hai questo commento:

// mod_audio_stream streams binary audio; no JSON start/stop


MA POI:

aspetti JSON

aspetti query

non fallback automatico

Con la modifica sopra non serve toccare il codice audio.

‚úÖ RIASSUNTO MODIFICHE
1Ô∏è‚É£ Node ‚Äî WebSocketServer
PRIMA:
const wss = new WebSocketServer({ server });

DOPO:
const wss = new WebSocketServer({
  server,
  handleProtocols: () => 'audio.raw'
});

2Ô∏è‚É£ FreeSWITCH dialplan ‚Äî URL stream
PRIMA:
ws://127.0.0.1:9090

DOPO:
ws://127.0.0.1:9090?call_id=${uuid}&caller_id=${caller_id_number}&called_number=${destination_number}&codec=L16&sample_rate=8000

3Ô∏è‚É£ Reload + restart
Reload dialplan:
docker exec -it freeswitch fs_cli -H 127.0.0.1 -P 8021 -p ClueCon -x "reloadxml"

Restart Node:
systemctl restart alessia-voice

üß™ TEST FINALE

1Ô∏è‚É£ Chiama 9999
2Ô∏è‚É£ Guarda Node log:

Devi vedere:

New WebSocket connection
Auto-starting session from query params
Session started
Call active


3Ô∏è‚É£ Controlla FreeSWITCH:

uuid_audio_stream list


Devi vedere:

UUID ... ws://127.0.0.1:9090 mono 8k