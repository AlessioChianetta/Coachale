â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“š [STEP 7] Checking for reset request and fetching message history
ğŸ“š [STEP 7] Found 1 historical messages
ğŸ§  [STEP 8] Calling Gemini AI (model: gemini-2.5-flash)

ğŸ“Š [GEMINI TOKENS] Stima PRIMA della chiamata:
   ğŸ“ System Prompt: ~7,608 tokens (30,431 chars)
   ğŸ’¬ User Message: ~2 tokens (5 chars)
   ğŸ“œ History: ~2 tokens (5 chars)
   ğŸ”¢ TOTALE INPUT: ~7,612 tokens

ğŸ”„ [RETRY] Attempt 1/3
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
âœ… [RETRY] Success on attempt 1!
â±ï¸  [TIMING] Gemini API call: 979ms

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [DEBUG] Analyzing Gemini Response Object
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ Response object keys: [ 'response' ]
ğŸ“¦ response.response keys: [ 'text' ]
ğŸ“Š response.response.candidates: 0
âœ… response.response.text is a function - calling it...
ğŸ“ Extracted text length: 343
ğŸ“ Extracted text preview: Ciao! ğŸ‘‹ Piacere, sono l'assistente di Orbitale.
Aiutiamo imprenditori, liberi professionisti e dipendenti a creare, gestire e proteggere il proprio denaro, risparmiarlo e investirlo strategicamente, 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”


ğŸ“Š [GEMINI TOKENS] Utilizzo DOPO la risposta:
   âœ… Response: ~86 tokens (343 chars)
   ğŸ”¢ TOTALE (input + output): ~7,698 tokens
   â±ï¸  Tempo di risposta: 979ms
   ğŸ’° Costo stimato: $0.015396 (input + output)

âœ… [STEP 8] Gemini response received: "Ciao! ğŸ‘‹ Piacere, sono l'assistente di Orbitale.
Aiutiamo imprenditori, liberi professionisti e dipe..."
ğŸ’¾ [STEP 9] Saving AI response to database
âœ… [STEP 9] AI response saved with ID: bcf58c5b-bfb0-4c78-b17e-de35111a7843
ğŸ›ï¸ [AUDIO DECISION] Mode: mirror, ClientSentAudio: false â†’ sendAudio=false, sendText=true

ğŸ“ [TTS SKIP] TTS disabled or not needed (ttsEnabled=true, mode=mirror, clientAudio=false)

ğŸ“¤ [STEP 10] Sending WhatsApp message to +393519272875
âœ… Using agent from existing conversation: Receptionist Principale (fe95f393-b8c9-4fc0-80d7-2035dcba305a)
ğŸ“¤ Sending WhatsApp message as plain text
âœ… Sent WhatsApp message chunk 1/1: SM9d8443f78a6f6c364b00a99d140e9c36 (343 chars)
âœ… [STEP 10] WhatsApp message sent: text
ğŸ’¾ [APPOINTMENT BOOKING] Retrieved 20 proposed slots from database
ğŸ“… [APPOINTMENT BOOKING] Attempting to extract appointment confirmation from lead message
ğŸ“Š [EXTRACTION] Retrieved 2 messages for extraction

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” [STEP 2] Extracting Appointment Data from Conversation
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“š Analyzing last 2 messages for appointment details...
ğŸ¤– Using AI model: gemini-2.5-flash
ğŸ”„ [EXTRACTION] Attempt 1/3 with provider: vertex
ğŸš€ Creating VertexAI instance with Service Account credentials
  - project: gen-lang-client-0278434337
  - location: us-central1
  - model: gemini-2.5-flash
  - credentials: vertex-ai-service-account@gen-lang-client-0278434337.iam.gserviceaccount.com
âœ… VertexAI instance created successfully
ğŸ”§ Getting Generative Model...
âœ… GenerativeModel created successfully
ğŸ”„ Switching model from gemini-2.5-flash to undefined
âŒ [EXTRACTION] Failed after 1 attempt(s): [VertexAI.ClientError]: model parameter must not be empty.
âŒ [APPOINTMENT BOOKING] Error extracting appointment details
   Error type: ClientError
   Error message: [VertexAI.ClientError]: model parameter must not be empty.
   Stack trace:
ClientError: [VertexAI.ClientError]: model parameter must not be empty.
    at formulateResourcePathFromModel (/home/runner/workspace/node_modules/@google-cloud/vertexai/src/models/generative_models.ts:537:11)
    at new GenerativeModelPreview (/home/runner/workspace/node_modules/@google-cloud/vertexai/src/models/generative_models.ts:323:25)
    at VertexAIPreview.getGenerativeModel (/home/runner/workspace/node_modules/@google-cloud/vertexai/src/vertex_ai.ts:219:12)
    at VertexAIClientAdapter.generateContent (/home/runner/workspace/server/ai/provider-factory.ts:65:42)
    at processPendingMessages (/home/runner/workspace/server/whatsapp/message-processor.ts:2126:55)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async processPendingMessagesWithRetry (/home/runner/workspace/server/whatsapp/message-processor.ts:273:5)
    at async processConsultantQueue (/home/runner/workspace/server/whatsapp/message-processor.ts:252:9)
    at async enqueueProcessing (/home/runner/workspace/server/whatsapp/message-processor.ts:228:5)
    at async Timeout._onTimeout (/home/runner/workspace/server/whatsapp/message-processor.ts:205:5)
âœ”ï¸ [STEP 11] Marking 1 pending messages as processed
âœ… Processed 1 messages for +393519272875

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸  PERFORMANCE BREAKDOWN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… Appointment Fetch:        1042ms  (21.1%)
ğŸš¨ Objection Detection:         1ms  (0.0%)
ğŸ¤– Gemini API Call:           979ms  (19.8%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â° TOTAL TIME:               4940ms
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”