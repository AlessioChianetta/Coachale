â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” FILE SEARCH MODE: Switching to Google AI Studio (required for File Search)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ Provider: Google AI Studio (@google/genai)
   âœ… File Search API: SUPPORTED
   âš ï¸  Vertex AI: NOT compatible with File Search
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Using SuperAdmin Gemini key for File Search (1/1)
ğŸ” [Intent Detection] Detected intent from message: general
ğŸ”‘ [Cache Key] Using cache key: c2146759-f08a-430a-afdf-701bbc674300-general
ğŸ”„ Building fresh consultant context (intent: general)
ğŸ” [DEBUG] Query flags: {
  shouldLoadClients: true,
  shouldLoadExercises: true,
  shouldLoadClientData: true,
  shouldLoadEmail: true,
  shouldLoadWhatsApp: true,
  shouldLoadCalendar: true,
  shouldLoadConsultations: true,
  shouldLoadEmailDetailed: false,
  shouldLoadWhatsAppDetailed: true,
  shouldLoadAIAgents: false,
  shouldLoadLeads: true,
  shouldLoadCampaigns: true,
  shouldLoadApiSettings: true,
  shouldLoadWhatsAppConfig: true
}
ğŸ” [Q1] Fetching consultant info...
ğŸ” [Q2] Fetching all clients...
ğŸ” [Q3] Fetching pending exercise reviews...
ğŸ” [Q4] Fetching recently created exercises...
ğŸ” [Q5] Fetching exercise stats...
ğŸ” [Q6] Fetching email drafts...
ğŸ” [Q7] Fetching scheduler logs...
ğŸ” [Q8] Fetching WhatsApp leads...
ğŸ” [Q9] Fetching WhatsApp conversations...
ğŸ” [Q10] Fetching upcoming appointments...
ğŸ” [Q11] Fetching today appointments...
ğŸ” [Q12] Fetching all consultations...
ğŸ” [Q13] Fetching consultation tasks...
ğŸ” [Q13a] Fetching client goals...
ğŸ” [Q13b] Fetching client state tracking data (latest per client)...
ğŸ” [Q14] Fetching SMTP settings...
ğŸ” [Q15] Fetching email journey templates...
ğŸ” [Q16] Fetching WhatsApp custom templates...
ğŸ” [Q17] Fetching library documents...
ğŸ” [Q18] Fetching exercise feedback...
ğŸ” [Q19] Fetching university year assignments with detailed structure...
ğŸ” [Q20] Fetching exercise templates...
ğŸ” [Q21] Fetching university templates...
ğŸ” [Q27] Fetching detailed WhatsApp conversations (last 24h)...
ğŸ” [Q28] Fetching recent WhatsApp messages (last 24h)...
ğŸ” [Q29] Fetching WhatsApp agent configs...
ğŸ” [Q40] Fetching proactive leads (last 24h)...
ğŸ” [Q41] Fetching lead stats by status...
ğŸ” [Q42] Fetching lead stats by category...
ğŸ” [Q43] Fetching lead stats by campaign...
ğŸ” [Q44] Fetching marketing campaigns with agent names...
ğŸ” [Q44] Building query with leftJoin...
ğŸ” [Q45] Fetching campaign analytics (last 30 days)...
ğŸ” [Q46] Fetching external API configs...
ğŸ” [Q46] Building query with leftJoin...
ğŸ” [Q47] Fetching external lead import logs (last 30 days)...
ğŸ” [Q48] Fetching WhatsApp/Twilio configuration (FULL)...
ğŸ” [Q49] Fetching WhatsApp custom templates with versions...
ğŸ” [Q50] Fetching WhatsApp template assignments...
ğŸ” [Q51] Fetching Twilio WhatsApp templates from Content API...
ğŸ” [Q52] Fetching calendar settings...
âœ… [Q1] Consultant info fetched
âœ… [Q3] Pending exercise reviews fetched: 0
âœ… [Q2] All clients fetched: 0
âœ… [Q5] Exercise stats fetched
âœ… [Q4] Recently created exercises fetched: 0
âœ… [Q21] University templates fetched: 0
âœ… [Q20] Exercise templates fetched: 0
âœ… [Q27] Detailed WhatsApp conversations fetched (24h): 3
âœ… [Q19] University year assignments raw data fetched: 0 rows
âœ… [Q28] Recent WhatsApp messages fetched (24h): 11
âœ… [Q29] WhatsApp agent configs fetched: 4
âœ… [Q6] Email drafts fetched: 0
âœ… [Q41] Lead stats by status fetched: 4 statuses
âœ… [Q40] Proactive leads fetched (24h): 3
âœ… [Q42] Lead stats by category fetched: 2 categories
âœ… [Q43] Lead stats by campaign fetched: 1 campaigns
âœ… [Q44] Marketing campaigns fetched: 1
âœ… [Q45] Campaign analytics fetched: 0 records
âœ… [Q46] External API configs fetched: 0
âœ… [Q48] WhatsApp/Twilio configuration (FULL) fetched: 1 record(s)
âœ… [Q49] WhatsApp custom templates fetched: 12
âœ… [Q47] External lead import logs fetched: 0
âœ… [Q50] WhatsApp template assignments fetched: 0
âœ… [Q52] Calendar settings fetched: Found
âœ… [Q10] Upcoming appointments fetched: 0
âœ… [Q8] WhatsApp leads fetched: 30
âœ… [Q12] All consultations fetched: 0
âœ… [Q11] Today appointments fetched: 0
âœ… [Q13a] Client goals fetched: 0
âœ… [Q13] Consultation tasks fetched: 0
âœ… [Q14] SMTP settings fetched: 1
âœ… [Q9] WhatsApp conversations fetched: 20
âœ… [Q15] Email journey templates fetched: 31
âœ… [Q16] WhatsApp custom templates fetched: 12
âœ… [Q13b] Client state tracking fetched (unique clients): 0
âœ… [Q18] Exercise feedback fetched: 0
âœ… [Q17] Library documents fetched: 20
âœ… [Q7] Scheduler logs fetched: 1
ğŸ”’ [CronLock] Acquired lock for "ai-task-scheduler" (instance: 13b28cdb)
ğŸ¤– [AI-SCHEDULER] â•â•â•â•â•â• STEP 1: Starting task processing cycle â•â•â•â•â•â•
âœ… [Q51] Twilio WhatsApp templates fetched: 3 from 4 agent(s)
ğŸ“§ [EMAIL MAPPING] Created email mapping for 0 consultations
ğŸ” [WhatsApp Config] Populated with masked credentials (Account SID: NULL, Auth Token: NULL)
ğŸ“š [Knowledge Base] Loading ALL knowledge content for consultant (no filtering)...
ğŸ¤– [AI-SCHEDULER] STEP 1: No approved tasks to move
ğŸ“š [Knowledge Base] Loaded 1 documents and 0 APIs for consultant c2146759-f08a-430a-afdf-701bbc674300
âœ… [Knowledge Base] Loaded ALL content: 1 documents, 0 API sources

ğŸ“Š Token Usage Breakdown (Intent: general):
   Dashboard: 26 tokens
   Clients (0 clients): 3 tokens
   Exercises: 32 tokens
   Email Marketing: 51 tokens
   WhatsApp Leads: 1,293 tokens
   Calendar: 27 tokens
   Consultations: 22 tokens
   Consultation Tasks: 18 tokens
   Client Goals: 19 tokens
   Client States (0 states): 16 tokens
   SMTP Configuration: 0 tokens
   Email Templates: 0 tokens
   WhatsApp Templates: 0 tokens
   Library Documents: 0 tokens
   Exercise Feedback: 13 tokens
   University: 36 tokens
   Exercise Templates: 17 tokens
   ğŸ’¬ WhatsApp (Detailed): 2,142 tokens
   ğŸ¯ Lead Management: 817 tokens
   ğŸ“Š Campaign Marketing: 242 tokens
   ğŸ”Œ API Settings: 54 tokens
   ğŸ“± WhatsApp Config: 554 tokens
   ğŸ“ WhatsApp Templates (Detailed): 1,536 tokens
   ğŸ”— WhatsApp Template Assignments: 1 tokens
   ğŸ“² Twilio WhatsApp Templates: 552 tokens
   ğŸ“… Calendar Settings: 81 tokens
   ğŸ“š Knowledge Base: 2,361 tokens
   Base (prompts + metadata): 5,051 tokens
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ğŸ¯ TOTAL ESTIMATED: 14,964 tokens

âœ… Built and cached consultant context (intent: general)
â±ï¸  [TIMING] Consultant context building: 1387ms
ğŸ¤– [AI-SCHEDULER] STEP 2: No tasks to process
ğŸ”“ [CronLock] Released lock for "ai-task-scheduler"
â±ï¸  [TIMING] Consultant prompt building: 5ms

ğŸ“Š Token Usage Estimation:
  - System Prompt: ~41,042 tokens
  - ğŸ§  Conversation Memory: ~1,654 tokens (included in System Prompt)
  - User Message: ~1 tokens
  - Conversation History: ~0 tokens
  - Total Estimated: ~41,043 tokens

âœ… [FileSearch] Store name valid: fileSearchStores/knowledge-base-consulente-nqujxkv9w1qm

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” AI MODE: FILE SEARCH SEMANTIC (Gemini RAG) [CONSULTANT]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¦ Stores disponibili: 1
      1. fileSearchStores/knowledge-base-consulente-nqujxkv9w1qm

   ğŸ“Š BREAKDOWN DOCUMENTI PER STORE:

   ğŸ‘¤ Knowledge Base Consulente (7 documenti):
      ğŸ“„ consultant_guide: 3
      ğŸ“„ dynamic_context: 3
      ğŸ§  Knowledge Base: 1
   âœ… Tool fileSearch: ATTIVO
   ğŸ“„ Il modello cercherÃ  semanticamente nei documenti indicizzati
   ğŸ“‰ System prompt ridotto grazie a File Search
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[AI] Using model: gemini-3-flash-preview with thinking_level: low [CONSULTANT STREAMING]
[AI] Provider: Google AI Studio, User-selected: YES
ğŸ› ï¸  [TOOLS] Consultant chat: codeExecution=YES, fileSearch=YES
ğŸ”„ AI stream attempt 1/6...
ğŸ”’ [Semaphore] Acquired slot (1/3 in use)
ğŸ”“ [Semaphore] Released slot (0/3 in use)
ğŸ“Š [TokenTracker] Buffered: consultant-chat | gemini-3-flash-preview | 45454 tokens | $0.0235 | consultant=c2146759-f08a-430a-afdf-701bbc674300 client=self
âœ… AI streaming completed successfully on attempt 1
â±ï¸  [TIMING] Gemini API call (with streaming): 3899ms

ğŸ“Š TOKEN USAGE (REAL from Gemini) [CONSULTANT]:
   - Prompt tokens: 45,126
   - Response tokens: 328
   - Total tokens: 45,454
ğŸ” [DB INSERT DEBUG] About to insert assistant message...
   - conversationId: 28b3056d-43aa-4aff-bb04-311a97a0dd76
   - content length: 1123 chars
   - accumulatedThinking length: 0 chars
âœ… [DB INSERT DEBUG] Message saved successfully: b488287b-96ca-446b-9359-ff1650fa887f
âœ… Consultant AI streaming completed for message b488287b-96ca-446b-9359-ff1650fa887f
ğŸ“Š [TITLE-GEN] Conversation 28b3056d-43aa-4aff-bb04-311a97a0dd76: 2 messages, current title: "ciao"

ğŸ“ [TITLE-GEN] Generating title for consultant conversation 28b3056d-43aa-4aff-bb04-311a97a0dd76...
   ğŸ“¨ User message: "ciao"
   ğŸ¤– AI response: "EhilÃ , Massimo! ğŸ‘‹ Benvenuto a bordo della nostra navicella spaziale operativa! ğŸš€

Oggi Ã¨ mercoledÃ¬..."
   ğŸ”‘ [TITLE-GEN] Using SuperAdmin Gemini key
   ğŸ¤– [TITLE-GEN] Calling Gemini API...
âœ… [TokenTracker] Flushed 1 entries to DB
ğŸ“Š [TokenTracker] Buffered: consultant-title-gen | gemini-3-flash-preview | 644 tokens | $0.0014 | consultant=c2146759-f08a-430a-afdf-701bbc674300 client=self
   âœ… [TITLE-GEN] Title generated and saved: "Monitoraggio lead Assistente Viaggio"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ” FILE SEARCH STREAMING SUMMARY [CONSULTANT]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ“¦ Stores attivi: 1
   âš ï¸  Nota: In modalitÃ  streaming, le citazioni non sono disponibili
      nel response object. File Search Ã¨ stato configurato come tool.
   ğŸ“„ Se la risposta cita documenti specifici, Gemini ha usato File Search.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â±ï¸  PERFORMANCE TIMING BREAKDOWN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   [0ms â†’ 1387ms] Context Building (1387ms)
   [1387ms â†’ 1392ms] Prompt Building (5ms)
   [1392ms â†’ 9761ms] Gemini API Call (3899ms)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â±ï¸  TOTAL: 9.76s (9761ms)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”