# Overview
This full-stack web application is a comprehensive consultation platform designed to connect consultants and clients, facilitating exercise assignments, progress tracking, and performance analytics. Its core purpose is to leverage an AI assistant for personalized financial insights, enhancing consultant-client interactions, streamlining financial guidance, and improving overall client outcomes and consultant efficiency. The platform includes a multi-tier subscription system for AI agents with revenue sharing, an employee licensing system, and a a public landing page for lead generation, aiming to be a holistic solution for modern financial consultation.

# User Preferences
Preferred communication style: Simple, everyday language.
User requested "obsessive-compulsive" attention to detail when verifying what works and what doesn't.

# System Architecture
The application features a modern UI/UX built with React 18, TypeScript, Vite, Tailwind CSS, and `shadcn/ui`, prioritizing accessibility and responsiveness. The backend is powered by Express.js, TypeScript, JWT, bcrypt, and PostgreSQL (Drizzle ORM), implementing a robust role-based access control (consultant, client, super_admin) and multi-profile system.

**Key Features and Design Patterns:**

*   **AI Integration:** Deeply integrated AI provides personalized financial insights, a multi-tenant semantic search knowledge base, consultation summarization, and AI-powered integrations with WhatsApp Business, Instagram, and X (Twitter) DMs. It includes configurable AI sales agents, a fully AI-driven follow-up system, automated weekly client check-ins, and AI tools for generating courses and exercises. The platform features a ChatGPT-style AI Assistant with dynamic model selection, reasoning visualization, conversation memory, and a hybrid AI context system with token optimization and RAG. A Consultation Function Calling System with an LLM Intent Classifier (Gemini 2.5 Flash Lite) ensures intelligent tool usage, guardrails, and semantic output. **Knowledge Base Enhancement:** System Prompt Documents (`system_prompt_documents` table) allow consultants to inject custom instructions directly into AI system prompts with per-target toggles (client AI assistant, autonomous agents, WhatsApp). **Per-Agent WhatsApp Targeting:** `target_whatsapp_agents` is JSONB (not boolean), enabling targeting specific WhatsApp "dipendenti" (employees) from `consultant_whatsapp_config`. **Injection Mode:** `injection_mode` column ('system_prompt' | 'file_search') controls delivery â€” System Prompt (always in memory) or File Search (RAG-based retrieval for larger documents). Auto-sync to File Search stores on create/update/toggle/delete with cleanup on mode switch. Agent Knowledge Assignments (`agent_knowledge_assignments` table) allow assigning existing KB documents to any of the 8 autonomous AI agents. Service: `server/services/system-prompt-documents-service.ts`. Sync: `syncSystemPromptDocumentToFileSearch()` and `removeSystemPromptDocumentFromFileSearch()` in `file-search-sync-service.ts`. Frontend: `AgentKnowledgeSection.tsx` and `SystemDocumentsSection.tsx` components in the Knowledge Base page. File Search Analytics hierarchy includes WhatsApp agent stores visualization.
*   **Subscription & Licensing:** A multi-tier subscription system manages AI agent access, consultant licenses, revenue sharing, and AI credits, with Stripe integration for payments.
*   **Content & Marketing Studio:** Features AI tools for content idea generation, social media copy, a 6-step campaign builder, AI image generation, and a Lead Nurturing 365 System with automated AI-generated email sequences. The Email Hub supports IMAP/SMTP, unified inboxes, and AI-powered response generation.
*   **Data Analysis:** A "compute-first" system processes structured data (Excel/CSV), separating deterministic calculation (SQL) from AI interpretation. It includes efficient Excel parsing, dynamic tables with Row Level Security (RLS), Server-Sent Events (SSE), and an enterprise-grade Semantic Layer with **28 logical roles** (22 core + 6 production costs) to prevent AI hallucinations. **Semantic Roles:** price, cost, quantity, order_date, order_id, product_name, product_id, category, customer_id, discount_percent, total_net, tax_rate, payment_method, staff, line_id, is_sellable, revenue_amount, document_type, time_slot, sales_channel, document_id, supplier_id, cost_foodbev, cost_materials, cost_extra, cost_staff, cost_structure, cost_utilities. **Production Cost Metrics:** prime_cost (food cost + personale), cost_staff_percent, cost_foodbev_percent, total_production_cost, and per-component totals. **Multi-CSV Join System:** Supports uploading 2-10 CSV files simultaneously with automatic relationship detection (95%+ accuracy via column name matching, value overlap, and PK/FK pattern detection). Creates unified datasets via LEFT JOIN with staging tables, system column injection, and semantic mapping. Available both as manual upload (with visual join preview/confirmation) and webhook auto-join (`/webhook-multi/:apiKey`) for external system integrations. Key files: `join-detector.ts` (algorithm), `MultiFileUploader.tsx` (upload UI), `JoinPreview.tsx` (join confirmation UI).
*   **Consultant Workflow:** A 4-phase, 23-step Consultant Setup Wizard guides configuration, alongside configurable monthly consultation limits.
*   **Communication & Automation:**
    *   **Voice Telephony (Alessia AI Phone):** Integrates FreeSWITCH with Gemini 2.5 Flash Native Audio for real-time voice AI, automatic caller recognition, call management, and recording. Supports both Google AI Studio and Vertex AI with automatic fallback and backend-specific prompt optimization.
    *   **Direction-Based Voice Template System:** Provides separate, configurable templates for inbound and outbound calls with a template library and variable interpolation.
    *   **AI Task Scheduling:** An automated system for AI-powered voice calls with a database-backed task queue, retry logic, recurrence options, and a comprehensive REST API and frontend UI.
    *   **AI Autonomous Employee (Multi-Role):** A Decision Engine (`autonomous-decision-engine.ts`) uses Gemini to analyze client context and generate multi-step execution plans. A Task Executor (`ai-task-executor.ts`) runs steps with per-step logging. Guardrails enforce working hours, daily limits, channel restrictions. Eight specialized AI agents (Alessia, Millie, Echo, Nova, Stella, Iris, Marco, Personalizza) each with dedicated data queries, Gemini prompts, and task categories. Roles can be individually toggled, and a UI allows configuration of the "Personalizza" agent.
    *   **Voice Supervisors (LLM Architecture):** Real-time transcript analysis systems (Task and Booking Supervisors) using Gemini 2.5 Flash Lite detect and manage reminders/tasks and trigger bookings based on conversational intent, ensuring data completeness and conflict detection.
*   **System Robustness:** Features include a 4-week calendar system for check-ins, universal PDF support, real-time Google Drive sync, a Dataset Sync API for partners, a Data Sync Observability Dashboard, an Intent Follow-Through System, a Partner Webhook Notification System, and a Database-Based Cron Mutex. An Anti-Zombie Connection System prevents stale Gemini WebSocket connections.
*   **Content Generation Enhancements:** Includes a Content Studio Platform-Specific Schema Selection with templates, character limits, AI shortening, and writing styles. A Content Autopilot System automates content scheduling with AdVisage AI integration for image generation. A Bulk Publish System for Publer enables one-click scheduling. A Content Variety System prevents repetitive AI-generated ads through dynamic pattern and angle rotation, anti-repetition features, and AI compression.

# External Dependencies
*   **Supabase**: PostgreSQL hosting.
*   **Recharts**: Data visualization.
*   **Date-fns**: Date manipulation.
*   **Radix UI**: Accessible UI primitives.
*   **Google Fonts**: Inter, Poppins, DM Sans, Fira Code.
*   **Lucide React**: Iconography.
*   **Google Gemini API**: Powers AI features.
*   **Percorso Capitale API**: Financial management system.
*   **Fathom**: Consultation recording and transcription.
*   **Driver.js**: Interactive guided tours.
*   **Twilio API**: WhatsApp Business messaging.
*   **X (Twitter) API v2**: Direct message automation and Account Activity webhooks.
*   **Stripe**: Payment processing for subscriptions and licenses.
*   **FreeSWITCH**: Voice telephony integration.
*   **Google Calendar API**: Appointment scheduling.
*   **Publer**: Social media scheduling and publishing.