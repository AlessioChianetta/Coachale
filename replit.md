# Overview
This full-stack web application is a consultation platform connecting consultants and clients for exercise assignments, progress tracking, and performance analytics. It features an AI assistant for personalized financial insights using real-time data, advanced client management, and communication tools. The platform also includes a robust AI knowledge base system, aiming to enhance consultant-client interactions, streamline financial guidance, and improve client outcomes and consultant efficiency.

# User Preferences
Preferred communication style: Simple, everyday language.
User requested "obsessive-compulsive" attention to detail when verifying what works and what doesn't.

# System Architecture
## Core Technologies
- **Frontend**: React 18, TypeScript, Vite, TanStack React Query, Wouter, shadcn/ui, Tailwind CSS, React Hook Form, Zod.
- **Backend**: Express.js, TypeScript, JWT, bcrypt, PostgreSQL (Drizzle ORM), Multer.
## Data Management
- **Database**: PostgreSQL (Supabase) with Drizzle ORM, supporting users, exercises, assignments, submissions, consultations, goals, and analytics.
## Authentication & Authorization
- **JWT tokens** for client-side authentication.
- **Role-based access control** (consultant/client/super_admin).
- **Secure password handling** using bcrypt.
- **Super Admin System**: Centralized management with global OAuth, TURN server configurations, and a 3-tier priority system for Gemini API keys.
## UI/UX Decisions
- Modern, accessible, and responsive design using `shadcn/ui` and `Tailwind CSS`.
- Interactive guided tours via `Driver.js` for onboarding.
- Categorized Sidebar Navigation for consultants with state persistence.
- Redesigned "Libreria Formativa" layout with a Sidebar + Content pattern, redesigned course cards, 4-level deletion protection, responsive action buttons, integrated search, and a compact header.
## AI Integration
- **Percorso Capitale**: Personalized financial insights with graceful degradation and daily pre-fetch.
- **AI Knowledge Base System**: Allows document uploads (PDF, DOCX, TXT) and external API integrations for AI context, featuring text extraction, indexing, priority-based ranking, and multi-tenant isolation.
- **Gemini File Search Integration (RAG)**: Semantic document retrieval using Google's native File Search. Each consultant has a dedicated `FileSearchStore` with automatic syncing and support for mixed-role users. Strict privacy isolation for client data and a comprehensive Consultant Platform Guide automatically synced. **Per-Client File Search Toggle**: Consultants can enable/disable File Search on a per-client basis via the Analytics Settings tab. When disabled, the AI falls back to traditional context loading with full document content. Default is enabled for all clients. **External Docs Auto-Sync**: Automatically syncs Google Docs linked to exercises via `workPlatform` field. If a personalized link exists on `exerciseAssignments.workPlatform`, uses that; otherwise uses template link from `exercises.workPlatform`. Documents are scraped and indexed into client's private store with sourceType `exercise_external_doc`. Managed via File Search Analytics page with audit view, settings toggle, and content display. **Automatic Large File Chunking**: XLSX/CSV files exceeding 400k tokens are automatically split into smaller chunks for upload. The chunking utility (`file-chunker.ts`) estimates tokens (~4 chars/token) and splits content preserving headers. Each chunk is named with "Parte X/N" suffix and tracked with unique sourceIds. Staleness detection properly handles both chunked and non-chunked documents, cleaning up old content before re-uploading.
- **Echo - AI Consultation Summary Agent**: Generates consultation summary emails and extracts actionable tasks from Fathom transcripts with approval workflows.
- **AI System Prompt Architecture**: All AI endpoints use `buildSystemPrompt()` for comprehensive context.
- **Token Optimization Strategy**: Hybrid approach using intent detection, conditional database queries, intent-scoped caching, dynamic exercise scraping limits, and File Search RAG to reduce AI token consumption.
- **WhatsApp Business Integration**: Full-featured WhatsApp messaging via Twilio with AI-powered responses, rich media, and automatic API key rotation, including multi-tenant configuration and Gemini AI responses.
- **Instagram Direct Messaging Integration**: AI sales agents for Instagram DMs via Meta Graph API. Supports reactive messaging (24-hour window compliance), comment-to-DM automation, story replies, story mentions, and ice breakers (quick replies menu). Features include: HMAC signature verification for webhook security, 200 DMs/hour rate limiting, encrypted token storage per consultant, separate message-processor reusing shared AI logic (`ai-prompts.ts`, `ai-context-builder.ts`), window expiration tracking with cron job cleanup every 5 minutes, and pending message queue for out-of-window messages. Database tables: `consultant_instagram_config`, `instagram_conversations`, `instagram_messages`, `instagram_window_status`, `instagram_pending_messages`, `instagram_comments`. Routes: `/api/instagram/webhook` (public), `/api/instagram/config` (authenticated). **Frontend Integration**: Instagram tab in API Keys page (cyan/teal theme) with Page ID, Access Token, App Secret configuration and connection testing. Conversations page features WhatsApp/Instagram tabs with unified interface, WindowStatusBadge for 24h window status visualization (green=active with countdown, red=expired), InstagramMessageBubble for message display with story reply/mention indicators. Hooks: `useInstagramConversations`, `useInstagramMessages`, `useSaveInstagramConfig`, `useTestInstagramConnection` with full TypeScript interfaces. Schema extended with `instagramConfigId` on `consultant_whatsapp_config` for agent-level Instagram linking.
- **Per-Agent Google Calendar Integration**: Each WhatsApp agent operates independently with mandatory agent calendars, agent-specific availability settings, and isolated booking data.
- **Sales Agent Configuration**: Configurable AI agent execution for sales phases with dynamic token usage optimization, intelligent personality profiling, and sequentially validated scripts.
- **Human Seller Analytics & Session Persistence**: Unified analytics for AI agents and human sellers, with session state storage and restoration.
- **Checkpoint Validation System**: 3-tier status system (VALIDATED, VAGUE, MISSING) for sales coaching.
- **Gemini Model Configuration**: Dynamic model selection based on provider type (Google AI Studio/Vertex AI) and priority for SuperAdmin Gemini Keys for Gemini 3 capabilities.
- **Video Copilot Turn-Taking System**: Prevents API bombardment during video meetings via intelligent turn-taking.
- **WebRTC/WebSocket Resilience System**: Implements heartbeat, exponential backoff, and network change detection for robust connectivity.
- **AI-Driven Follow-up Automation System**: 100% AI-driven follow-up system guided by per-consultant preferences while maintaining decision autonomy.
- **Booking Extraction Accumulator Pattern**: Prevents booking data loss during AI re-extraction cycles by progressively accumulating fields across multiple attempts.
- **AI Course Builder**: 5-step wizard to generate lessons from YouTube videos with 3-layer transcript extraction fallback, manual transcript input, AI lesson generation preserving speaker's tone, SSE progress tracking, draft management, transcript quality evaluation, AI instruction templates, a review screen, duplicate video detection, and lesson regeneration. Includes real-time loading for video processing, automatic step transitions, a Course Theme System with 5 visual themes, and Module Organization with single module, manual, or AI auto-assignment options. AI lesson generation enhancements include extended output, length requirements, priority instructions, content logging, and styled HTML lesson output with theme-specific Tailwind classes. Features a hierarchical Step 5 view and Email Journey style preview for lessons. **Parallel Batch Processing**: Generates 5 lessons simultaneously per batch (BATCH_SIZE = 5) with progressive job.lessons updates and 2-second pause between batches. **Auto-Save & Resume**: Drafts auto-save after each batch with generatedLessonIds tracking; interrupted sessions can be resumed from the last completed batch, skipping already-generated videos. **yt-dlp JavaScript Runtime**: All yt-dlp calls use `--js-runtimes node` flag (required since Nov 2024 for YouTube extraction). **Transcript Failure Handling**: Tracks transcript failures during polling with visual error badges (red "0 caratteri"); after 3 consecutive failures, shows AlertDialog prompting manual transcript entry with guided flow through each failed video.
- **AI University Pathway Generator**: 4-step wizard at `/consultant/templates` for AI-powered university pathway creation. Step 1: Course selection from library. Step 2: AI analyzes courses and suggests trimester assignments (Q1-Q4) based on progressive difficulty and topic dependencies. Step 3: Pathway details form with structure preview. Step 4: Optional client assignment with instant instantiation. Backend service (`ai-university-generator.ts`) handles course analysis, pathway generation with template creation (trimesters, modules, lessons), and client instantiation with privacy-isolated File Search syncing.
- **AI Exercise Generator**: Generates exercises from course lessons with advanced configuration options. Features include: multi-language support (course language, specific language, or custom system prompt), adjustable writing styles (elementary/standard/professional/academic/custom), automatic question count determination based on lesson complexity (1-15 questions) or fixed count mode. Uses SSE streaming for real-time progress updates with lesson-by-lesson status tracking (pending → analyzing → generating → completed/error). Saves `libraryDocumentId` to link generated exercises to their source lessons. Backend service (`ai-exercise-generator.ts`) with `generateExercisesForCourseWithProgress()` for sequential processing with progress callbacks.
- **AI Assistant Agent Integration**: WhatsApp agents can be enabled for use in the AI Assistant interface. Features include: per-agent `enableInAIAssistant` toggle in agent settings, agent dropdown in consultant/client AI assistant pages, agent context (name, description, personality, instructions) injected into system prompts when selected, `agentClientAssignments` table for sharing agents with specific clients via AgentShareManager modal, `fileSearchCategories` field for per-agent File Search category selection (stored for future deep integration), and ChatGPT-style `aiAssistantPreferences` table with 5 writing styles (conversational/professional/concise/detailed/custom), 3 response lengths (brief/standard/comprehensive), and custom instructions that integrate into system prompts. **Hierarchical AI Instructions System**: Consultants can define `defaultSystemInstructions` that serve as base instructions for all their clients. Clients see the consultant's base instructions as read-only context and can add their own custom instructions that extend (not replace) the consultant base. The prompt combines consultant base + client overrides. Consultants can also manage preferences for individual clients via `ClientAIPreferencesManager`. Backend routes in `ai-assistant-router.ts` handle all CRUD operations with JWT authentication.

# External Dependencies
- **Supabase**: PostgreSQL hosting.
- **Recharts**: Data visualization.
- **Date-fns**: Date manipulation.
- **Radix UI**: Accessible UI primitives.
- **Google Fonts**: Inter, Poppins, DM Sans, Fira Code.
- **Lucide React**: Iconography.
- **Google Gemini API**: AI-powered features.
- **Percorso Capitale API**: Financial management system integration.
- **Fathom**: AI-powered consultation recording and transcription.
- **Driver.js**: Interactive guided tours and onboarding.
- **Twilio API**: WhatsApp Business messaging.