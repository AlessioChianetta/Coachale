# Overview
This full-stack web application is a comprehensive consultation platform connecting consultants and clients, primarily leveraging an AI assistant for personalized financial insights. Its purpose is to enhance interactions, streamline financial guidance, and improve client outcomes and consultant efficiency. The platform includes a multi-tier subscription system for AI agents with revenue sharing, an employee licensing system, and a public landing page for lead generation, aiming to be a holistic solution for modern financial consultation.

# User Preferences
Preferred communication style: Simple, everyday language.
User requested "obsessive-compulsive" attention to detail when verifying what works and what doesn't.
User prefers direct SQL for any database modifications (not ORM migrations).

# System Architecture
The application features a modern UI/UX built with React 18, TypeScript, Vite, Tailwind CSS, and `shadcn/ui`, prioritizing accessibility and responsiveness. The backend uses Express.js, TypeScript, JWT, bcrypt, and PostgreSQL (Drizzle ORM), implementing robust role-based access control (consultant, client, super_admin) and a multi-profile system.

**Key Features and Design Patterns:**

*   **AI Integration:** Provides personalized financial insights, multi-tenant semantic search, consultation summarization, and AI-powered integrations (WhatsApp Business, Instagram, X DMs). Includes configurable AI sales agents, automated follow-up and client check-ins, and tools for generating courses and exercises. A ChatGPT-style AI Assistant offers dynamic model selection, reasoning visualization, conversation memory, and a hybrid AI context system with token optimization and RAG. A Consultation Function Calling System with an LLM Intent Classifier ensures intelligent tool usage and guardrails. Knowledge Base enhancement allows custom instructions in AI system prompts.
*   **Subscription & Licensing:** A multi-tier subscription system manages AI agent access, consultant licenses, revenue sharing, and AI credits with Stripe integration.
*   **Content & Marketing Studio:** Features AI tools for content idea generation, social media copy, a 6-step campaign builder, AI image generation, and a Lead Nurturing 365 System with automated AI-generated email sequences. The Email Hub supports IMAP/SMTP, unified inboxes, and AI-powered response generation. A Content Autopilot System automates content scheduling.
*   **Data Analysis:** A "compute-first" system processes structured data, separating deterministic calculation (SQL) from AI interpretation. Includes efficient Excel parsing, dynamic tables with Row Level Security (RLS), Server-Sent Events (SSE), and an enterprise-grade Semantic Layer. A Multi-CSV Join System supports uploading multiple CSV files with automatic relationship detection.
*   **Consultant Workflow:** A 4-phase, 27-step Consultant Setup Wizard guides configuration, alongside configurable monthly consultation limits. The `/consultant/api-keys-unified` page features a Service Status Dashboard (10-service grid with green/gray/yellow status dots, click-to-navigate), status-indicator-equipped tab bar with visual group separators, collapsible guides (AI Vertex + Twilio), progressive-disclosure Stripe tab with stepper, and a compact Video Meeting tab. An integrated **Accademia di Formazione** LMS at `/consultant/academy` provides dynamically managed lessons organized in modules, with YouTube + iframe (Guidde) video support, document attachments, progress tracking via DB (`consultant_academy_completions`), bidirectional wizard↔academy links, and automatic pre-completion for wizard-verified steps. Academy content is stored in DB tables (`academy_modules`, `academy_lessons`, `academy_lesson_documents`) and managed via a superadmin CMS at `/admin/academy` with full CRUD, reordering, and video/document management. API at `/api/consultant/academy/modules` (read) and `/api/consultant/academy/admin/*` (CRUD, superadmin-only).
    *   **Client Library (Academy-style):** The `/client/library` page uses a 2-column Academy-style layout with a sticky sidebar accordion (modules/lessons with progress badges) and an inline content area (video player, text content, document sections, attachments, linked exercises with status badges, and Prev/Next navigation). Exercises linked to library documents are fetched via `GET /api/library/documents/:documentId/exercises` and displayed inline with action buttons. Exercise ordering in `getAssignmentsByClient` uses `exerciseCategories.sortOrder` + `exercises.createdAt`.
*   **Communication & Automation:**
    *   **Voice Telephony (Alessia AI Phone):** Integrates FreeSWITCH with Gemini 2.5 Flash Native Audio for real-time voice AI, automatic caller recognition, call management, and recording.
    *   **Direction-Based Voice Template System:** Provides configurable templates for inbound and outbound calls.
    *   **AI Task Scheduling:** Automated system for AI-powered voice calls with a database-backed task queue, retry logic, and recurrence options.
    *   **AI Autonomous Employee (Multi-Role):** A Decision Engine uses Gemini to analyze client context and generate multi-step execution plans. A Task Executor runs steps with logging. Guardrails enforce working hours and channel restrictions. Nine specialized AI agents (including Hunter — Lead Prospector) with dedicated data queries, Gemini prompts, and task categories. Supports per-role client filtering, dual reasoning modes ("Strutturato" and "Deep Think"), and post-generation anti-duplication of tasks using Jaccard keyword similarity. Includes bulk task actions and a reasoning dashboard.
    *   **Hunter Outreach System:** Autonomous lead prospecting pipeline. Hunter searches Google Maps/Search via SerpApi, enriches with Firecrawl, qualifies leads with AI scores, and delegates outreach to Alessia (voice calls via FreeSWITCH templates), Stella (WhatsApp via proactive_setter employee + templates), and Millie (email). Includes rate limiting (`outreach-rate-limiter.ts`), outreach content generation (`outreach-templates.ts`), feedback loop (lead status updates after contact → strategy adaptation), and full UI config in AI Autonomy channels tab. See `OUTREACH_SYSTEM.md` for architecture docs.
    *   **Assisted Mode (Modalità Assistita):** Allows AI tasks to pause for consultant feedback and context injection.
    *   **Intelligent Document Generation:** Generates dual output (summary and formal document) with dynamic classification (contract, market_research, guide, etc.) and adaptive PDF layouts.
    *   **Voice Supervisors (LLM Architecture):** Real-time transcript analysis for task management and booking.
    *   **Orbitale Tools Integration:** Integrates external Orbitale tools via iframe.
*   **AI Autonomy UI Structure:** The Dipendenti AI page (`/consultant/ai-autonomy`) uses a unified single tab bar inside `SettingsTab.tsx` with 8 tabs: Panoramica, Autonomia & Modalità, Orari & Limiti, Canali & Categorie, Dipendenti AI, Feed, Task, Dati. The parent `index.tsx` controls tab state via `activeTab`/`onTabChange` props. Feed/Task/Dati content components are passed as `activityContent`/`dashboardContent`/`dataCatalogContent` render props. Header uses clean white card with SaaS B2B styling (violet palette, shadow-sm, border-gray-200). KPI cards use flat `shadow-sm` style without colored top borders.
*   **Bidirectional Telegram Bot Integration:** Each AI employee can have its own Telegram bot, supporting 1:1 private and group chats with bidirectional message syncing. Includes an "Open Mode" for AI-driven conversational onboarding and structured profile extraction, with privacy isolation.
*   **Global Consultation Store (Marco + Alessia):** Aggregates client consultation notes and email journey documents into a single consultant-specific store, optimized for AI access with anti-hallucination titles. Alessia now also loads the Store Globale, WhatsApp conversations (60 days), and AI-assistant chat history (last 10 conversations + 2-month summaries).
*   **Voice Latency Optimization System:** In-memory caching (5min TTL) for `voice_numbers`, `consultant_availability_settings`, and `consultantInfo` (via `_voiceNumbersCache`, `_settingsCache`, `_consultantInfoCache` Maps). Scheduled call query deduplication reuses early auth lookup result. Single `voiceThinkingBudget` (default 0) applied once in Gemini setup message for entire session (Gemini Live API only accepts `generationConfig` at setup). First-message barge-in protection (`voice_protect_first_message`) suppresses interruption events until first AI turn completes. **Deferred Prompt** (`voice_deferred_prompt`, default false): when enabled, moves contentPrompt, brandVoice, and consultantDetailedProfile OUT of systemInstruction (~6746→~550 tokens) and injects them as a `clientContent` chunk with `turnComplete: false` AFTER the greeting trigger. **Configurable VAD (Voice Activity Detection):** `voice_vad_start_sensitivity` (LOW/MEDIUM/HIGH, default MEDIUM), `voice_vad_end_sensitivity` (LOW/MEDIUM/HIGH, default LOW), `voice_vad_silence_ms` (300-1000, default 500) — applied in both Google AI Studio and Vertex AI setup messages. Cache invalidation on settings save (`invalidateVoiceCache`) and voice_numbers update/delete (`invalidateVoiceNumberCache`). Frontend controls in "Impostazioni AI Avanzate" card on voice settings tab.
    *   **Alessia Enhanced Intelligence System:** Persistent client memory (`alessia_client_memory` table) stores per-client interaction summaries, client promises, next steps, sentiment, and AI self-evaluation after every call. Client-specific measurable objectives (`alessia_client_objectives` table) with deadlines, priorities, and progress tracking. Automatic post-consultation detection flags consultations without follow-up within 48h. Dynamic call scripts with structured format (type, opening, points, objective, tone, context, closure). AI-powered feedback loop analyzes transcripts via Gemini after every completed call (`voice-feedback-loop.ts`).
*   **Operational Data File Search Optimization:** Reduces AI chat system prompt token count when File Search is active by syncing operational data (clients, templates, configs) as `sourceType: "operational_context"`.
*   **Consultant Detailed Profile:** Stores comprehensive consultant information across 8 sections, including personal info, identity, business details, services, target audience, approach, values, and AI context, all integrated into the AI's understanding.
*   **System Robustness:** Includes a 4-week calendar, universal PDF support, real-time Google Drive sync, a Dataset Sync API, a Data Sync Observability Dashboard, an Intent Follow-Through System, a Partner Webhook Notification System, and a Database-Based Cron Mutex. An Anti-Zombie Connection System prevents stale Gemini WebSocket connections.
*   **Mobile & Dark Mode Design System:** Employs a Revolut-style design system with reusable CSS utilities and shared components, ensuring responsive and accessible UI with proper dark mode support using CSS variables.

# External Dependencies
*   **Supabase**: PostgreSQL hosting.
*   **Recharts**: Data visualization.
*   **Date-fns**: Date manipulation.
*   **Radix UI**: Accessible UI primitives.
*   **Google Fonts**: Inter, Poppins, DM Sans, Fira Code.
*   **Lucide React**: Iconography.
*   **Google Gemini API**: Powers AI features.
*   **Percorso Capitale API**: Financial management system.
*   **Fathom**: Consultation recording and transcription.
*   **Driver.js**: Interactive guided tours.
*   **Twilio API**: WhatsApp Business messaging.
*   **X (Twitter) API v2**: Direct message automation and Account Activity webhooks.
*   **Stripe**: Payment processing for subscriptions and licenses.
*   **FreeSWITCH**: Voice telephony integration.
*   **Google Calendar API**: Appointment scheduling.
*   **Publer**: Social media scheduling and publishing.
*   **SerpAPI**: Google Maps business data extraction for Lead Scraper (requires `SERPAPI_KEY`).
*   **Firecrawl**: Website scraping for email/contact extraction in Lead Scraper (requires `FIRECRAWL_API_KEY`).

# Skill Store & Lead Scraper (New Features)

*   **Skill Store** (`/consultant/skills-store`): Marketplace for importing AI skills from GitHub repositories (`anthropics/skills` official, `travisvn/awesome-claude-skills` community) plus custom skill creation. Skills are markdown instructions injected into Gemini AI system prompt (max 5 active, 3000 chars each). DB tables: `ai_skills_store`, `ai_skills_assignments`. Backend: `server/routes/skills-store-router.ts`. Frontend: `client/src/pages/consultant-skills-store.tsx` + `client/src/components/skills-store/`. Sidebar: under "CERVELLO AI". **Fully functional**: file uploads (images, PDFs, text files) sent to Gemini as `inlineData` base64, code execution enabled (`codeExecution: {}` tool), ActiveSkillsBadge component shows active skills above chat input. Active skills endpoint: `GET /api/skills-store/active`.
*   **Lead Scraper** (`/consultant/lead-scraper`): Dual-engine search via SerpAPI — **Google Maps** (local businesses) and **Google Search** (any website). Website enrichment via Firecrawl with full-content extraction (no truncation), robust phone filtering (Italian formats, excludes GPS coordinates/IDs), email blacklist, social link cleanup (TikTok/Pinterest support, tracking param removal), expanded service keywords. **Smart cache**: reuses previously scraped website data (`scraped_cached` status) to save Firecrawl credits — domain-level deduplication across all searches. CSV export includes full description, extra phones, services. UI: 3-tab layout (Ricerca/CRM Lead/Sales Agent), engine selector toggle (Maps/Web), source badge per result, scrape status icons (email/phone/social), expandable description, unified contacts (dedup Maps+website). **CRM Lead Management**: per-lead status tracking (nuovo/contattato/in_trattativa/proposta_inviata/chiuso_vinto/chiuso_perso/non_interessato), notes, next action with date, deal value in EUR, auto-set contacted_at on first status change. **AI Sales Agent**: per-consultant sales context configuration (9 fields: services, target, value proposition, pricing, competitive advantages, ideal client profile, sales approach, case studies, additional context), stored in `lead_scraper_sales_context` table. AI generates structured sales reports per scraped company via `quickGenerate()` with score 1-100 (regex `**SCORE: N**`), including sections: compatibility score, company analysis, potential needs, approach strategy, suggested opening phrase. Batch generation available. **AI Keyword Suggestions**: `POST /suggest-keywords` analyzes sales context and suggests 8-12 search queries with Maps/Search engine recommendation, shown as clickable chips that populate the search form. **Chat AI slide-in panel**: framer-motion `AnimatePresence` + `motion.div` sliding from right (`fixed inset-y-0 right-0 w-[420px]`), spring animation, FAB button (violet Bot icon, emerald pulse dot), backdrop overlay. **Lead Detail Page** (`/consultant/lead-scraper/lead/:leadId`): full-page 2-column layout — left: contact info, AI Sales Summary (with regenerate), scraped data (expandable), social links, services; right: sticky CRM form (status, value, next action, date, notes, save). Score badge in header. `GET /results/:id` with ownership verification. CRM tab has textual search (ILIKE on businessName/email/phone/notes/category), status counter cards (7 clickable stat chips), navigation to detail page. **Improved table layout**: score bar (colored progress bar + number), contact dots (blue/green/purple for email/phone/site), category subtext, left border color by lead status (kanban-style), sort by score/rating/name, timeAgo timestamps in sidebar. DB tables: `lead_scraper_searches`, `lead_scraper_results` (with CRM+AI fields), `lead_scraper_sales_context`, `lead_scraper_activities` (activity tracking with type/title/description/outcome/scheduledAt/completedAt/metadata). Backend: `server/routes/lead-scraper-router.ts`, `server/services/lead-scraper-service.ts`. Endpoints: search, results, results/:id, scrape, export, CRM PATCH, sales-context GET/PUT, generate-summary, generate-summaries (batch), all-results (with search param), chat, suggest-keywords, `GET/POST /leads/:leadId/activities`, `PATCH/DELETE /activities/:activityId`. Frontend: `client/src/pages/consultant-lead-scraper.tsx`, `client/src/pages/consultant-lead-detail.tsx`. **Lead Detail Page redesigned Close CRM-style**: 4/8 grid layout, left column (contacts card, CRM management form, AI analysis card), right column (activity timeline with tabs: Timeline/Note/Chiamate/Disco&Demo/Opportunita). 8 activity types (nota/chiamata/email_inviata/discovery/demo/appuntamento/proposta/chiusura), 6 outcomes (positivo/neutro/negativo/non_risponde/da_richiamare/prenotato). Visual timeline with type-colored icons, scheduled/completed badges, hover edit/delete. New activity dialog with type grid selector, outcome chips, datetime pickers. Sidebar: under "COMUNICAZIONE".

# Shared Chat Components

*   **Message Component** (`client/src/components/ai-assistant/Message.tsx`): Unified message renderer supporting full AI Assistant mode (with "Simone" avatar, code executions, generated files, suggested actions) and `compact` mode (small avatar + bubble layout for embedded chat panels). Props: `assistantName`, `assistantSubtitle`, `assistantAvatarSrc`, `assistantAvatarFallbackIcon` for identity customization; `compact` for embedded panel layout. Used by: AI Assistant (default mode), Lead Scraper Sales Agent chat (`assistantName="Sales Agent"`), AgentChat autonomy chats (`assistantName={roleName}`).
*   **ThinkingBubble** (`client/src/components/ai-assistant/ThinkingBubble.tsx`): Reused as typing indicator across all chat interfaces.
*   **ChatMarkdown** (`client/src/components/shared/ChatMarkdown.tsx`): Standalone markdown renderer (react-markdown + GFM + rehype-sanitize) with info boxes. Available as utility but currently not imported — Message component handles markdown rendering internally.

# AI Streaming Architecture (Code Execution / Generated Files)

The `@google/genai` SDK yields `GenerateContentResponse` objects during streaming. These chunks contain `candidates[0].content.parts[]` with typed fields: `text`, `thought`, `executableCode`, `codeExecutionResult`, `inlineData`, `functionCall`. Both `GeminiAdapter` (Google AI Studio) and `VertexAIClientAdapter` (Vertex AI) in `server/ai/provider-factory.ts` re-map SDK chunks to `GeminiStreamChunk` objects, preserving all part types. The `streamWithBackoff` function in `server/ai/retry-manager.ts` processes these parts and yields typed SSE events (`code_execution`, `code_execution_result`, `generated_file`, `function_call`, `thinking`, `delta`). Frontend handlers in `consultant-ai-assistant.tsx` and `ChatPanel.tsx` parse these events and render download cards (via `Message.tsx`) for generated files.